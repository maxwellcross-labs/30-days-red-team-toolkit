"""
Phase 4: Exploitation operations
"""

from datetime import datetime
from core import OutputParsers


class ExploitationPhase:
    """Handles vulnerability exploitation"""
    
    def __init__(self, config, executor, logger, parsers=None):
        self.config = config
        self.executor = executor
        self.logger = logger
        self.parsers = parsers or OutputParsers()
    
    def execute(self):
        """Execute exploitation phase"""
        self.logger.section_header("PHASE 4: EXPLOITATION")
        
        phase_results = {
            'start_time': datetime.now().isoformat(),
            'vulnerabilities_found': [],
            'exploitation_attempted': [],
            'shells_obtained': []
        }
        
        if not self.config.get('scope.exploitation', True):
            self.logger.info("Exploitation phase disabled in scope")
            return phase_results
        
        domain = self.config.get('target.domain')
        
        # Vulnerability scanning
        if self.config.get('scope.vulnerability_scan', True):
            phase_results['vulnerabilities_found'] = self._scan_vulnerabilities(domain)
        
        # Service exploitation
        if self.config.get('scope.port_scan', True):
            self._exploit_services()
        
        # Provide shell handler instructions
        self._show_shell_handler_instructions()
        
        phase_results['end_time'] = datetime.now().isoformat()
        self.logger.info("Phase 4 complete")
        
        return phase_results
    
    def _scan_vulnerabilities(self, domain):
        """Scan target for vulnerabilities"""
        self.logger.info("Running vulnerability scanner...")
        
        result = self.executor.run_python_script(
            '04-exploitation/vulnerability_scanner.py',
            f'https://{domain}',
            timeout=600
        )
        
        if result['success']:
            vulns = self.parsers.parse_vulnerabilities(result['stdout'])
            self.logger.info(f"Found {len(vulns)} potential vulnerabilities")
            return vulns
        
        return []
    
    def _exploit_services(self):
        """Attempt to exploit discovered services"""
        self.logger.info("Running service exploitation...")
        
        for ip_range in self.config.get('target.ip_ranges', []):
            result = self.executor.run_python_script(
                '04-exploitation/service_exploiter.py',
                ip_range,
                timeout=900
            )
            
            if result['success']:
                self.logger.info("Service exploitation complete")
    
    def _show_shell_handler_instructions(self):
        """Display shell handler setup instructions"""
        attacker_ip = self.config.get('attacker.ip')
        attacker_port = self.config.get('attacker.port')
        
        self.logger.info("[!] MANUAL STEP REQUIRED:")
        self.logger.info(f"    Start shell handler: python3 04-exploitation/reverse_shell_handler.py --lhost {attacker_ip} --lport {attacker_port}")
        self.logger.info("    Wait for incoming shells from exploitation attempts")