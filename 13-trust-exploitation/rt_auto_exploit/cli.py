"""
Automated Trust Exploitation CLI
Command-line interface for the automated trust exploitation framework
"""

import argparse
import sys

from .orchestrator import ExploitationWorkflow


def main():
    """Main CLI entry point"""
    parser = argparse.ArgumentParser(
        description="Automated Trust Exploitation Framework - Full trust exploitation automation",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  # Full automated exploitation
  python -m rt_auto_exploit --domain corp.local --username admin \\
    --password P@ssw0rd --dc-ip 192.168.1.10

  # Enumeration only (no exploitation)
  python -m rt_auto_exploit --domain corp.local --username admin \\
    --password P@ssw0rd --dc-ip 192.168.1.10 --enumerate-only

  # Generate report from previous run
  python -m rt_auto_exploit --domain corp.local --username admin \\
    --password P@ssw0rd --dc-ip 192.168.1.10 --report-only
        """
    )

    # Required arguments
    parser.add_argument(
        '--domain', '-d',
        type=str,
        required=True,
        help='Initial compromised domain (where you have DA)'
    )

    parser.add_argument(
        '--username', '-u',
        type=str,
        required=True,
        help='Domain Admin username'
    )

    parser.add_argument(
        '--password', '-p',
        type=str,
        required=True,
        help='Domain Admin password'
    )

    parser.add_argument(
        '--dc-ip',
        type=str,
        required=True,
        help='Domain controller IP address'
    )

    # Optional arguments
    parser.add_argument(
        '--output', '-o',
        type=str,
        default='auto_trust_exploit',
        help='Output directory (default: auto_trust_exploit)'
    )

    parser.add_argument(
        '--enumerate-only',
        action='store_true',
        help='Only enumerate trusts, do not exploit'
    )

    parser.add_argument(
        '--no-auto-exploit',
        action='store_true',
        help='Enumerate and analyze, but do not auto-exploit'
    )

    parser.add_argument(
        '--quiet', '-q',
        action='store_true',
        help='Suppress status messages'
    )

    # Parse arguments
    args = parser.parse_args()

    # Initialize workflow
    workflow = ExploitationWorkflow(
        output_dir=args.output,
        verbose=not args.quiet
    )

    if args.enumerate_only:
        # Enumeration only
        print("[*] Running enumeration only mode...")
        trusts = workflow.enumerate_only(
            args.domain,
            args.username,
            args.password,
            args.dc_ip
        )

        print(f"\n[+] Found {len(trusts)} trust(s)")
        for trust in trusts:
            print(f"    {trust.source_domain} -> {trust.target_domain} ({trust.category.value})")
    else:
        # Full workflow
        auto_exploit = not args.no_auto_exploit

        state = workflow.run_full_exploitation(
            args.domain,
            args.username,
            args.password,
            args.dc_ip,
            auto_exploit=auto_exploit
        )

        # Summary
        print(f"\n[+] Workflow complete!")
        print(f"    Trusts discovered: {len(state.trusts)}")
        print(f"    Paths identified: {len(state.exploit_paths)}")
        print(f"    Attempts: {len(state.attempts)}")
        print(f"    Successful: {len(state.successful_attempts)}")

    print(f"\n[+] Results saved to: {args.output}/")


if __name__ == "__main__":
    main()