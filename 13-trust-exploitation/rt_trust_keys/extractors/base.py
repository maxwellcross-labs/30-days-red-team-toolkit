"""
Base Extractor Class
Abstract base for all trust key extraction methods
"""

from abc import ABC, abstractmethod
from typing import Optional, List
from pathlib import Path

from ..models import TrustKey, ExtractionOperation, ExtractionStatus


class BaseExtractor(ABC):
    """
    Abstract base class for trust key extractors
    All extraction methods should inherit from this
    """

    def __init__(self, output_dir: str = "trust_keys", verbose: bool = True):
        """
        Initialize extractor

        Args:
            output_dir: Directory for output files
            verbose: Print status messages
        """
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        self.verbose = verbose
        self.name = self.__class__.__name__

    def log(self, message: str, level: str = "info") -> None:
        """
        Print status message if verbose enabled
        """
        if not self.verbose:
            return
        prefixes = {
            "info": "[*]",
            "success": "[+]",
            "error": "[-]",
            "warning": "[!]",
        }
        prefix = prefixes.get(level, "[*]")
        print(f"{prefix} {message}")

    @abstractmethod
    def extract(
            self,
            source_domain: str,
            target_domain: str,
            username: str,
            password: str,
            dc_ip: Optional[str] = None
    ) -> List[TrustKey]:
        """
        Extract trust keys

        Args:
            source_domain: Source domain with DA access
            target_domain: Target domain to extract trust for
            username: Domain Admin username
            password: Domain Admin password
            dc_ip: Domain controller IP

        Returns:
            List of extracted TrustKey objects
        """
        pass

    @abstractmethod
    def generate_commands(
            self,
            source_domain: str,
            target_domain: str,
            dc_ip: Optional[str] = None
    ) -> List[str]:
        """
        Generate extraction commands without executing

        Args:
            source_domain: Source domain
            target_domain: Target domain
            dc_ip: Domain controller IP

        Returns:
            List of command strings
        """
        pass

    @abstractmethod
    def is_available(self) -> bool:
        """
        Check if this extraction method is available

        Returns:
            True if method can be used
        """
        pass

    def save_commands(
            self,
            commands: List[str],
            source_domain: str,
            target_domain: str
    ) -> Path:
        """
        Save generated commands to file

        Args:
            commands: List of commands
            source_domain: Source domain
            target_domain: Target domain

        Returns:
            Path to saved file
        """
        filename = f"{self.name.lower()}_{source_domain}_to_{target_domain}.txt"
        filepath = self.output_dir / filename

        with open(filepath, 'w') as f:
            f.write(f"# Trust Key Extraction Commands\n")
            f.write(f"# Source: {source_domain}\n")
            f.write(f"# Target: {target_domain}\n")
            f.write(f"# Method: {self.name}\n")
            f.write(f"# Generated by RT Trust Key Framework\n\n")

            for cmd in commands:
                f.write(f"{cmd}\n")

        self.log(f"Commands saved to: {filepath}", "success")

        return filepath

    def save_keys(self, keys: List[TrustKey], source_domain: str) -> Path:
        """
        Save extracted keys to file

        Args:
            keys: List of TrustKey objects
            source_domain: Source domain

        Returns:
            Path to saved file
        """
        filename = f"trust_keys_{source_domain}.txt"
        filepath = self.output_dir / filename

        with open(filepath, 'w') as f:
            f.write(f"# Trust Keys for {source_domain}\n")
            f.write(f"# Extracted by RT Trust Key Framework\n\n")

            for key in keys:
                f.write(f"Account: {key.account_name}\n")
                f.write(f"Target Domain: {key.target_domain}\n")
                f.write(f"NTLM (RC4): {key.key_value}\n")
                if key.aes256_key:
                    f.write(f"AES256: {key.aes256_key}\n")
                if key.aes128_key:
                    f.write(f"AES128: {key.aes128_key}\n")
                f.write("\n")

        self.log(f"Keys saved to: {filepath}", "success")

        return filepath