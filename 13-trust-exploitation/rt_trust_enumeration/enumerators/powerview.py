"""
PowerView Trust Enumerator
Enumerate AD trusts using PowerView cmdlets
"""

import subprocess
import json
import shutil
from typing import Optional, List

from .base import BaseEnumerator
from ..models.trust import Trust


class PowerViewEnumerator(BaseEnumerator):
    """
    Enumerate trusts using PowerView PowerShell module
    Best for: Windows environments with PowerView available
    """

    def __init__(self, powerview_path: str = ".\\PowerView.ps1", verbose: bool = True):
        """
        Initialize PowerView enumerator

        Args:
            powerview_path: Path to PowerView.ps1 script
            verbose: Print status messages
        """
        super().__init__(verbose)
        self.powerview_path = powerview_path
        self.timeout = 30

    def is_available(self) -> bool:
        """Check if PowerShell is available"""
        return shutil.which("powershell") is not None

    def enumerate(
            self,
            domain: str,
            username: Optional[str] = None,
            password: Optional[str] = None,
            dc: Optional[str] = None
    ) -> List[Trust]:
        """
        Enumerate trusts using PowerView Get-DomainTrust

        Args:
            domain: Target domain
            username: Username for authentication
            password: Password for authentication
            dc: Domain controller IP/hostname

        Returns:
            List of Trust objects
        """
        self.log(f"Enumerating trusts for {domain} using PowerView...")

        trusts = []

        # Build PowerView command
        powerview_cmd = f"Get-DomainTrust -Domain {domain}"
        if dc:
            powerview_cmd += f" -Server {dc}"

        # Build full PowerShell command
        if username and password:
            ps_cmd = f"""
$SecPassword = ConvertTo-SecureString '{password}' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('{username}', $SecPassword)
Import-Module {self.powerview_path}
{powerview_cmd} -Credential $Cred | ConvertTo-Json
"""
        else:
            ps_cmd = f"""
Import-Module {self.powerview_path}
{powerview_cmd} | ConvertTo-Json
"""

        try:
            result = subprocess.run(
                ["powershell", "-Command", ps_cmd],
                capture_output=True,
                text=True,
                timeout=self.timeout
            )

            if result.returncode == 0 and result.stdout:
                trusts = self._parse_output(result.stdout, domain)
                self.log(f"Found {len(trusts)} trust(s) via PowerView", "success")
            else:
                self.log(f"PowerView enumeration failed: {result.stderr}", "error")

        except subprocess.TimeoutExpired:
            self.log("PowerView timeout", "error")
        except Exception as e:
            self.log(f"PowerView error: {e}", "error")

        return trusts

    def _parse_output(self, output: str, source_domain: str) -> List[Trust]:
        """
        Parse PowerView JSON output

        Args:
            output: JSON output from PowerView
            source_domain: Source domain name

        Returns:
            List of Trust objects
        """
        trusts = []

        try:
            data = json.loads(output)

            # Handle single result (not in array)
            if not isinstance(data, list):
                data = [data]

            for entry in data:
                trust = Trust.from_raw(
                    source_domain=entry.get("SourceName", source_domain),
                    target_domain=entry.get("TargetName", ""),
                    raw_type=entry.get("TrustType", 0),
                    raw_direction=entry.get("TrustDirection", 0),
                    trust_attributes=entry.get("TrustAttributes", 0)
                )
                trusts.append(trust)

                self._log_trust(trust)

        except json.JSONDecodeError:
            self.log("Could not parse PowerView JSON output", "error")

        return trusts

    def _log_trust(self, trust: Trust) -> None:
        """Log trust details"""
        self.log(f"Trust found:", "success")
        self.log(f"    Source: {trust.source_domain}")
        self.log(f"    Target: {trust.target_domain}")
        self.log(f"    Type: {trust.trust_type}")
        self.log(f"    Direction: {trust.trust_direction}")

        if trust.sid_filtering_enabled:
            self.log(f"    SID Filtering: Enabled", "warning")
        else:
            self.log(f"    SID Filtering: DISABLED (Exploitable!)", "success")

    def enumerate_forest_domains(
            self,
            domain: str,
            username: Optional[str] = None,
            password: Optional[str] = None
    ) -> List[str]:
        """
        Enumerate all domains in the forest

        Args:
            domain: Any domain in the forest
            username: Username for authentication
            password: Password for authentication

        Returns:
            List of domain names in forest
        """
        self.log(f"Enumerating forest domains from {domain}...")

        domains = []

        if username and password:
            ps_cmd = f"""
$SecPassword = ConvertTo-SecureString '{password}' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('{username}', $SecPassword)
Import-Module {self.powerview_path}
Get-Forest -Credential $Cred | Select-Object -ExpandProperty Domains
"""
        else:
            ps_cmd = f"""
Import-Module {self.powerview_path}
Get-Forest | Select-Object -ExpandProperty Domains
"""

        try:
            result = subprocess.run(
                ["powershell", "-Command", ps_cmd],
                capture_output=True,
                text=True,
                timeout=self.timeout
            )

            if result.returncode == 0 and result.stdout:
                domains = [
                    line.strip()
                    for line in result.stdout.split('\n')
                    if line.strip() and '.' in line
                ]
                self.log(f"Found {len(domains)} domain(s) in forest", "success")
                for d in domains:
                    self.log(f"    {d}")

        except Exception as e:
            self.log(f"Forest enumeration error: {e}", "error")

        return domains