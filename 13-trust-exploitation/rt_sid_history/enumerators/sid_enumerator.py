"""
SID Enumerator
Enumerate domain SIDs and user SID history
"""

import subprocess
import shutil
from typing import Optional, List
from pathlib import Path

from ..models import DomainInfo, InjectionTarget
from ..utils.sid_utils import get_enterprise_admins_sid, get_domain_admins_sid


class SIDEnumerator:
    """
    Enumerate SIDs from Active Directory
    """

    def __init__(self, verbose: bool = True, powerview_path: str = ".\\PowerView.ps1"):
        """
        Initialize SID enumerator

        Args:
            verbose: Print status messages
            powerview_path: Path to PowerView.ps1
        """
        self.verbose = verbose
        self.powerview_path = powerview_path
        self.timeout = 30

    def log(self, message: str, level: str = "info") -> None:
        """Print status message"""
        if not self.verbose:
            return
        prefixes = {"info": "[*]", "success": "[+]", "error": "[-]", "warning": "[!]"}
        print(f"{prefixes.get(level, '[*]')} {message}")

    def is_powershell_available(self) -> bool:
        """Check if PowerShell is available"""
        return shutil.which("powershell") is not None

    def get_domain_sid(
            self,
            domain: str,
            username: str,
            password: str,
            dc: Optional[str] = None
    ) -> Optional[str]:
        """
        Get domain SID using PowerView

        Args:
            domain: Target domain
            username: Username for authentication
            password: Password
            dc: Domain controller (optional)

        Returns:
            Domain SID string or None
        """
        self.log(f"Getting SID for domain: {domain}")

        target_dc = dc if dc else domain

        ps_cmd = f"""
Import-Module {self.powerview_path}
$SecPassword = ConvertTo-SecureString '{password}' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('{username}@{domain}', $SecPassword)
Get-DomainSID -Domain {domain} -Server {target_dc} -Credential $Cred
"""

        try:
            result = subprocess.run(
                ["powershell", "-Command", ps_cmd],
                capture_output=True,
                text=True,
                timeout=self.timeout
            )

            if result.returncode == 0 and result.stdout:
                domain_sid = result.stdout.strip()

                # Validate SID format
                if domain_sid.startswith("S-1-5-21-"):
                    self.log(f"Domain SID: {domain_sid}", "success")
                    return domain_sid
                else:
                    self.log(f"Invalid SID format: {domain_sid}", "error")
                    return None
            else:
                self.log(f"Could not get domain SID: {result.stderr}", "error")
                return None

        except subprocess.TimeoutExpired:
            self.log("PowerView timeout", "error")
            return None
        except Exception as e:
            self.log(f"Error getting domain SID: {e}", "error")
            return None

    def get_domain_info(
            self,
            domain: str,
            username: str,
            password: str,
            dc: Optional[str] = None,
            is_forest_root: bool = False
    ) -> Optional[DomainInfo]:
        """
        Get complete domain information

        Args:
            domain: Target domain
            username: Username
            password: Password
            dc: Domain controller
            is_forest_root: Whether this is forest root

        Returns:
            DomainInfo object or None
        """
        self.log(f"Gathering domain info for: {domain}")

        domain_sid = self.get_domain_sid(domain, username, password, dc)

        if domain_sid:
            return DomainInfo(
                name=domain,
                sid=domain_sid,
                dc_hostname=dc,
                dc_ip=dc,
                is_forest_root=is_forest_root
            )

        return None

    def get_enterprise_admins_sid(
            self,
            forest_root_domain: str,
            username: str,
            password: str,
            dc: Optional[str] = None
    ) -> Optional[str]:
        """
        Get Enterprise Admins SID from forest root domain

        Args:
            forest_root_domain: Forest root domain name
            username: Username
            password: Password
            dc: Domain controller

        Returns:
            Enterprise Admins SID or None
        """
        self.log(f"Getting Enterprise Admins SID from {forest_root_domain}")

        domain_sid = self.get_domain_sid(forest_root_domain, username, password, dc)

        if domain_sid:
            ea_sid = get_enterprise_admins_sid(domain_sid)
            self.log(f"Enterprise Admins SID: {ea_sid}", "success")
            return ea_sid

        return None

    def get_user_sid_history(
            self,
            username: str,
            domain: str,
            auth_username: str,
            auth_password: str,
            dc: Optional[str] = None
    ) -> Optional[InjectionTarget]:
        """
        Get user's current SID and SID history

        Args:
            username: Target user to check
            domain: User's domain
            auth_username: Authentication username
            auth_password: Authentication password
            dc: Domain controller

        Returns:
            InjectionTarget with SID info or None
        """
        self.log(f"Checking SID history for: {username}@{domain}")

        target_dc = dc if dc else domain

        ps_cmd = f"""
Import-Module {self.powerview_path}
$SecPassword = ConvertTo-SecureString '{auth_password}' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('{auth_username}@{domain}', $SecPassword)
Get-DomainUser -Identity {username} -Server {target_dc} -Credential $Cred | 
    Select-Object SamAccountName, ObjectSid, SIDHistory | 
    ConvertTo-Json
"""

        try:
            result = subprocess.run(
                ["powershell", "-Command", ps_cmd],
                capture_output=True,
                text=True,
                timeout=self.timeout
            )

            if result.returncode == 0 and result.stdout:
                import json

                try:
                    data = json.loads(result.stdout)

                    target = InjectionTarget(
                        username=data.get("SamAccountName", username),
                        domain=domain,
                        current_sid=data.get("ObjectSid"),
                        sid_history=[]
                    )

                    # Parse SID history
                    sid_hist = data.get("SIDHistory")
                    if sid_hist:
                        if isinstance(sid_hist, list):
                            target.sid_history = sid_hist
                        else:
                            target.sid_history = [sid_hist]

                    if target.sid_history:
                        self.log(f"SID History found: {len(target.sid_history)} entry(ies)", "success")
                        for sid in target.sid_history:
                            self.log(f"  - {sid}")
                    else:
                        self.log("No SID History found", "info")

                    return target

                except json.JSONDecodeError:
                    self.log("Could not parse user data", "error")
                    return None
            else:
                self.log(f"Could not get user info: {result.stderr}", "error")
                return None

        except Exception as e:
            self.log(f"Error: {e}", "error")
            return None

    def enumerate_users_with_sid_history(
            self,
            domain: str,
            username: str,
            password: str,
            dc: Optional[str] = None
    ) -> List[InjectionTarget]:
        """
        Find all users with SID history in a domain

        Args:
            domain: Target domain
            username: Authentication username
            password: Authentication password
            dc: Domain controller

        Returns:
            List of InjectionTarget objects
        """
        self.log(f"Searching for users with SID history in: {domain}")

        users_with_history = []
        target_dc = dc if dc else domain

        ps_cmd = f"""
Import-Module {self.powerview_path}
$SecPassword = ConvertTo-SecureString '{password}' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('{username}@{domain}', $SecPassword)
Get-DomainUser -LDAPFilter '(sidHistory=*)' -Server {target_dc} -Credential $Cred | 
    Select-Object SamAccountName, ObjectSid, SIDHistory | 
    ConvertTo-Json
"""

        try:
            result = subprocess.run(
                ["powershell", "-Command", ps_cmd],
                capture_output=True,
                text=True,
                timeout=60
            )

            if result.returncode == 0 and result.stdout.strip():
                import json

                try:
                    data = json.loads(result.stdout)

                    if not isinstance(data, list):
                        data = [data]

                    for entry in data:
                        target = InjectionTarget(
                            username=entry.get("SamAccountName", ""),
                            domain=domain,
                            current_sid=entry.get("ObjectSid"),
                            sid_history=[]
                        )

                        sid_hist = entry.get("SIDHistory")
                        if sid_hist:
                            if isinstance(sid_hist, list):
                                target.sid_history = sid_hist
                            else:
                                target.sid_history = [sid_hist]

                        users_with_history.append(target)

                    self.log(f"Found {len(users_with_history)} user(s) with SID history", "success")

                except json.JSONDecodeError:
                    self.log("Could not parse enumeration results", "error")
            else:
                self.log("No users with SID history found", "info")

        except Exception as e:
            self.log(f"Enumeration error: {e}", "error")

        return users_with_history