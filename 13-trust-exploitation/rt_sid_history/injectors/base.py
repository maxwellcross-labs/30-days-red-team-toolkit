"""
Base Injector Class
Abstract base for all SID history injection methods
"""

from abc import ABC, abstractmethod
from typing import Optional
from pathlib import Path

from ..models import InjectionOperation, InjectionStatus


class BaseInjector(ABC):
    """
    Abstract base class for SID history injectors
    All injection methods should inherit from this
    """

    def __init__(self, output_dir: str = "sid_history", verbose: bool = True):
        """
        Initialize injector

        Args:
            output_dir: Directory for output files
            verbose: Print status messages
        """
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        self.verbose = verbose
        self.name = self.__class__.__name__

    def log(self, message: str, level: str = "info") -> None:
        """
        Print status message if verbose enabled

        Args:
            message: Message to print
            level: Log level
        """
        if not self.verbose:
            return
        prefixes = {
            "info": "[*]",
            "success": "[+]",
            "error": "[-]",
            "warning": "[!]",
        }
        prefix = prefixes.get(level, "[*]")
        print(f"{prefix} {message}")

    @abstractmethod
    def inject(self, operation: InjectionOperation) -> bool:
        """
        Perform SID history injection

        Args:
            operation: InjectionOperation with details

        Returns:
            True if successful
        """
        pass

    @abstractmethod
    def generate_commands(self, operation: InjectionOperation) -> list:
        """
        Generate commands for the injection (without executing)

        Args:
            operation: InjectionOperation with details

        Returns:
            List of command strings
        """
        pass

    @abstractmethod
    def is_available(self) -> bool:
        """
        Check if this injection method is available

        Returns:
            True if method can be used
        """
        pass

    def save_commands(self, operation: InjectionOperation, commands: list) -> Path:
        """
        Save generated commands to file

        Args:
            operation: InjectionOperation
            commands: List of commands

        Returns:
            Path to saved file
        """
        filename = f"{self.name.lower()}_{operation.target_user}_{operation.target_domain}.txt"
        filepath = self.output_dir / filename

        with open(filepath, 'w') as f:
            f.write(f"# SID History Injection Commands\n")
            f.write(f"# Target: {operation.target_user}@{operation.target_domain}\n")
            f.write(f"# SID to inject: {operation.sid_to_inject}\n")
            f.write(f"# Method: {self.name}\n")
            f.write(f"# Generated by RT SID History Framework\n\n")

            for cmd in commands:
                f.write(f"{cmd}\n")

        operation.output_file = str(filepath)
        operation.commands_generated = commands

        self.log(f"Commands saved to: {filepath}", "success")

        return filepath
