"""
SID Utilities
Helper functions for SID manipulation and parsing
"""

import re
from typing import Optional, Tuple, List

# Well-known RIDs
WELL_KNOWN_RIDS = {
    500: "Administrator",
    501: "Guest",
    502: "KRBTGT",
    512: "Domain Admins",
    513: "Domain Users",
    514: "Domain Guests",
    515: "Domain Computers",
    516: "Domain Controllers",
    517: "Cert Publishers",
    518: "Schema Admins",
    519: "Enterprise Admins",
    520: "Group Policy Creator Owners",
    521: "Read-only Domain Controllers",
    522: "Cloneable Domain Controllers",
    525: "Protected Users",
    526: "Key Admins",
    527: "Enterprise Key Admins",
    553: "RAS and IAS Servers",
}

# Well-known SIDs
WELL_KNOWN_SIDS = {
    "S-1-0-0": "Nobody",
    "S-1-1-0": "Everyone",
    "S-1-2-0": "Local",
    "S-1-3-0": "Creator Owner",
    "S-1-3-1": "Creator Group",
    "S-1-5-7": "Anonymous",
    "S-1-5-11": "Authenticated Users",
    "S-1-5-18": "Local System",
    "S-1-5-19": "Local Service",
    "S-1-5-20": "Network Service",
}


def parse_sid(sid_string: str) -> Optional[dict]:
    """
    Parse a SID string into components

    Args:
        sid_string: SID in format S-1-5-21-xxx-xxx-xxx-RID

    Returns:
        Dictionary with SID components or None
    """
    pattern = r'^S-(\d+)-(\d+)(?:-(\d+)(?:-(\d+))?(?:-(\d+))?(?:-(\d+))?)?$'
    match = re.match(pattern, sid_string)

    if not match:
        return None

    groups = match.groups()

    result = {
        "revision": int(groups[0]) if groups[0] else None,
        "authority": int(groups[1]) if groups[1] else None,
        "sub_authorities": [],
        "rid": None,
        "full_sid": sid_string,
    }

    # Parse sub-authorities
    for g in groups[2:]:
        if g:
            result["sub_authorities"].append(int(g))

    # Last sub-authority is the RID for domain SIDs
    if len(result["sub_authorities"]) > 0:
        result["rid"] = result["sub_authorities"][-1]
        result["domain_sid"] = "-".join(sid_string.split("-")[:-1])

    return result


def get_domain_sid(full_sid: str) -> Optional[str]:
    """
    Extract domain SID from a full SID (removes the RID)

    Args:
        full_sid: Full SID string

    Returns:
        Domain SID portion
    """
    parts = full_sid.split("-")
    if len(parts) >= 4:
        return "-".join(parts[:-1])
    return None


def build_sid(domain_sid: str, rid: int) -> str:
    """
    Build a full SID from domain SID and RID

    Args:
        domain_sid: Domain SID (S-1-5-21-xxx-xxx-xxx)
        rid: Relative Identifier

    Returns:
        Full SID string
    """
    return f"{domain_sid}-{rid}"


def get_enterprise_admins_sid(domain_sid: str) -> str:
    """
    Calculate Enterprise Admins SID from domain SID
    Enterprise Admins RID is always 519

    Args:
        domain_sid: Forest root domain SID

    Returns:
        Enterprise Admins SID
    """
    return build_sid(domain_sid, 519)


def get_domain_admins_sid(domain_sid: str) -> str:
    """
    Calculate Domain Admins SID from domain SID
    Domain Admins RID is always 512

    Args:
        domain_sid: Domain SID

    Returns:
        Domain Admins SID
    """
    return build_sid(domain_sid, 512)


def get_schema_admins_sid(domain_sid: str) -> str:
    """
    Calculate Schema Admins SID from domain SID
    Schema Admins RID is always 518

    Args:
        domain_sid: Forest root domain SID

    Returns:
        Schema Admins SID
    """
    return build_sid(domain_sid, 518)


def get_krbtgt_sid(domain_sid: str) -> str:
    """
    Calculate KRBTGT SID from domain SID
    KRBTGT RID is always 502

    Args:
        domain_sid: Domain SID

    Returns:
        KRBTGT SID
    """
    return build_sid(domain_sid, 502)


def describe_rid(rid: int) -> str:
    """
    Get human-readable description of a RID

    Args:
        rid: Relative Identifier

    Returns:
        Description string
    """
    return WELL_KNOWN_RIDS.get(rid, f"Custom RID ({rid})")


def describe_sid(sid_string: str) -> str:
    """
    Get human-readable description of a SID

    Args:
        sid_string: Full SID string

    Returns:
        Description string
    """
    # Check well-known SIDs first
    if sid_string in WELL_KNOWN_SIDS:
        return WELL_KNOWN_SIDS[sid_string]

    # Parse and check RID
    parsed = parse_sid(sid_string)
    if parsed and parsed["rid"]:
        rid_desc = describe_rid(parsed["rid"])
        return f"Domain\\{rid_desc}"

    return "Unknown SID"


def is_privileged_sid(sid_string: str) -> Tuple[bool, str]:
    """
    Check if a SID represents a privileged group

    Args:
        sid_string: Full SID string

    Returns:
        Tuple of (is_privileged, description)
    """
    privileged_rids = [500, 512, 518, 519]  # Admin, DA, SA, EA

    parsed = parse_sid(sid_string)
    if parsed and parsed["rid"] in privileged_rids:
        return True, describe_rid(parsed["rid"])

    return False, ""


def get_high_value_sids(domain_sid: str) -> List[dict]:
    """
    Get list of high-value SIDs for a domain

    Args:
        domain_sid: Domain SID

    Returns:
        List of dictionaries with SID info
    """
    high_value = [
        {"rid": 500, "name": "Administrator", "value": "CRITICAL"},
        {"rid": 502, "name": "KRBTGT", "value": "CRITICAL"},
        {"rid": 512, "name": "Domain Admins", "value": "HIGH"},
        {"rid": 518, "name": "Schema Admins", "value": "HIGH"},
        {"rid": 519, "name": "Enterprise Admins", "value": "CRITICAL"},
    ]

    result = []
    for item in high_value:
        result.append({
            "sid": build_sid(domain_sid, item["rid"]),
            "rid": item["rid"],
            "name": item["name"],
            "value": item["value"],
        })

    return result