"""
Injection Target Models
Data structures for SID history injection operations
"""

from dataclasses import dataclass, field
from typing import Optional, List
from enum import Enum
from datetime import datetime

from ..utils.sid_utils import describe_rid, parse_sid


class InjectionMethod(Enum):
    """Available injection methods"""
    MIMIKATZ = "mimikatz"
    IMPACKET = "impacket"
    DCSYNC = "dcsync"
    MANUAL = "manual"


class InjectionStatus(Enum):
    """Injection operation status"""
    PENDING = "pending"
    IN_PROGRESS = "in_progress"
    SUCCESS = "success"
    FAILED = "failed"
    VERIFIED = "verified"


@dataclass
class DomainInfo:
    """Domain information"""
    name: str
    sid: Optional[str] = None
    dc_hostname: Optional[str] = None
    dc_ip: Optional[str] = None
    is_forest_root: bool = False

    @property
    def enterprise_admins_sid(self) -> Optional[str]:
        """Get Enterprise Admins SID (only valid for forest root)"""
        if self.sid and self.is_forest_root:
            return f"{self.sid}-519"
        return None

    @property
    def domain_admins_sid(self) -> Optional[str]:
        """Get Domain Admins SID"""
        if self.sid:
            return f"{self.sid}-512"
        return None

    def to_dict(self) -> dict:
        return {
            "name": self.name,
            "sid": self.sid,
            "dc_hostname": self.dc_hostname,
            "dc_ip": self.dc_ip,
            "is_forest_root": self.is_forest_root,
            "enterprise_admins_sid": self.enterprise_admins_sid,
            "domain_admins_sid": self.domain_admins_sid,
        }


@dataclass
class InjectionTarget:
    """Target for SID history injection"""
    username: str
    domain: str
    current_sid: Optional[str] = None
    sid_history: List[str] = field(default_factory=list)

    def has_sid_history(self) -> bool:
        """Check if user has SID history"""
        return len(self.sid_history) > 0

    def has_privileged_sid(self) -> bool:
        """Check if any SID history entry is privileged"""
        privileged_rids = [500, 512, 518, 519]

        for sid in self.sid_history:
            parsed = parse_sid(sid)
            if parsed and parsed.get("rid") in privileged_rids:
                return True
        return False

    def to_dict(self) -> dict:
        return {
            "username": self.username,
            "domain": self.domain,
            "current_sid": self.current_sid,
            "sid_history": self.sid_history,
            "has_privileged_sid": self.has_privileged_sid(),
        }


@dataclass
class InjectionOperation:
    """Represents a single SID history injection operation"""
    target_user: str
    target_domain: str
    sid_to_inject: str
    method: InjectionMethod
    status: InjectionStatus = InjectionStatus.PENDING

    # Execution details
    dc_ip: Optional[str] = None
    commands_generated: List[str] = field(default_factory=list)
    output_file: Optional[str] = None

    # Results
    started_at: Optional[datetime] = None
    completed_at: Optional[datetime] = None
    error_message: Optional[str] = None

    @property
    def sid_description(self) -> str:
        """Get description of injected SID"""
        parsed = parse_sid(self.sid_to_inject)
        if parsed and parsed.get("rid"):
            return describe_rid(parsed["rid"])
        return "Unknown"

    @property
    def duration(self) -> Optional[float]:
        """Get operation duration in seconds"""
        if self.started_at and self.completed_at:
            return (self.completed_at - self.started_at).total_seconds()
        return None

    def mark_started(self) -> None:
        """Mark operation as started"""
        self.status = InjectionStatus.IN_PROGRESS
        self.started_at = datetime.now()

    def mark_success(self) -> None:
        """Mark operation as successful"""
        self.status = InjectionStatus.SUCCESS
        self.completed_at = datetime.now()

    def mark_failed(self, error: str) -> None:
        """Mark operation as failed"""
        self.status = InjectionStatus.FAILED
        self.completed_at = datetime.now()
        self.error_message = error

    def mark_verified(self) -> None:
        """Mark injection as verified"""
        self.status = InjectionStatus.VERIFIED

    def to_dict(self) -> dict:
        return {
            "target_user": self.target_user,
            "target_domain": self.target_domain,
            "sid_to_inject": self.sid_to_inject,
            "sid_description": self.sid_description,
            "method": self.method.value,
            "status": self.status.value,
            "dc_ip": self.dc_ip,
            "commands_generated": self.commands_generated,
            "output_file": self.output_file,
            "started_at": self.started_at.isoformat() if self.started_at else None,
            "completed_at": self.completed_at.isoformat() if self.completed_at else None,
            "duration_seconds": self.duration,
            "error_message": self.error_message,
        }


@dataclass
class AttackScenario:
    """Represents a complete attack scenario"""
    name: str
    description: str
    source_domain: DomainInfo
    target_domain: DomainInfo
    injection_operations: List[InjectionOperation] = field(default_factory=list)
    prerequisites: List[str] = field(default_factory=list)
    mitre_techniques: List[str] = field(default_factory=list)

    def add_operation(self, operation: InjectionOperation) -> None:
        """Add injection operation to scenario"""
        self.injection_operations.append(operation)

    @property
    def is_complete(self) -> bool:
        """Check if all operations completed"""
        return all(
            op.status in [InjectionStatus.SUCCESS, InjectionStatus.VERIFIED]
            for op in self.injection_operations
        )

    def to_dict(self) -> dict:
        return {
            "name": self.name,
            "description": self.description,
            "source_domain": self.source_domain.to_dict(),
            "target_domain": self.target_domain.to_dict(),
            "operations": [op.to_dict() for op in self.injection_operations],
            "prerequisites": self.prerequisites,
            "mitre_techniques": self.mitre_techniques,
            "is_complete": self.is_complete,
        }
