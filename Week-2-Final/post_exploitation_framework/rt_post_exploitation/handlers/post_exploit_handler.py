#!/usr/bin/env python3
"""
Post-Exploitation Handler
Orchestrates complete post-exploitation workflow
"""

from ..core.session import Session
from ..core.findings import FindingsManager
from ..modules.domain_enum import DomainEnumerator
from ..modules.credential_harvest import CredentialHarvester
from ..modules.network_mapping import NetworkMapper
from ..modules.sensitive_data import SensitiveDataFinder
from ..modules.privilege_escalation import PrivilegeEscalator


class PostExploitationHandler:
    """
    Complete post-exploitation orchestration
    Coordinates all modules for systematic reconnaissance
    """
    
    def __init__(self, session_id: str = None, c2_server: str = None):
        """
        Initialize post-exploitation handler
        
        Args:
            session_id: Unique session identifier
            c2_server: Command and Control server address
        """
        # Initialize session
        self.session = Session(session_id, c2_server)
        
        # Initialize findings manager
        self.findings = FindingsManager(self.session.session_id)
        
        # Initialize operational modules
        self.domain_enum = DomainEnumerator()
        self.cred_harvest = CredentialHarvester()
        self.network_mapper = NetworkMapper()
        self.data_finder = SensitiveDataFinder()
        self.priv_esc = PrivilegeEscalator()
    
    def enumerate_domain(self) -> bool:
        """
        Phase 1: Active Directory enumeration
        Discover users, computers, groups, trusts, GPOs
        
        Returns:
            True if enumeration completed successfully
        """
        print("\n" + "="*60)
        print("PHASE 1: ACTIVE DIRECTORY ENUMERATION")
        print("="*60)
        
        summary = self.domain_enum.get_enumeration_summary()
        
        print(f"\n[*] Total enumeration commands: {summary['total_commands']}")
        print(f"[*] Critical commands: {summary['critical_commands']}")
        
        print("\n[*] Enumeration categories:")
        for category, details in summary['categories'].items():
            print(f"    • {category}: {details['total']} commands")
            print(f"      - Critical: {details['critical']}, Important: {details['important']}")
        
        # In production, this would execute commands via C2
        # For now, we log the intent
        critical = self.domain_enum.get_critical_commands()
        
        print(f"\n[*] Executing {len(critical)} critical enumeration commands...")
        for cmd in critical:
            print(f"    ✓ {cmd.description}")
            
            # Simulate adding findings
            if "users" in cmd.name.lower():
                self.findings.add_domain_info('total_users', 150)
            elif "computers" in cmd.name.lower():
                self.findings.add_domain_info('total_computers', 50)
            elif "groups" in cmd.name.lower():
                self.findings.add_domain_info('total_groups', 25)
        
        self.session.mark_phase_complete('domain_enumeration')
        print("\n[✓] Active Directory enumeration complete")
        
        return True
    
    def harvest_credentials(self) -> bool:
        """
        Phase 2: Credential harvesting
        Multiple techniques for maximum coverage
        
        Returns:
            True if harvesting completed successfully
        """
        print("\n" + "="*60)
        print("PHASE 2: CREDENTIAL HARVESTING")
        print("="*60)
        
        summary = self.cred_harvest.get_technique_summary()
        
        print(f"\n[*] Total techniques: {summary['total_techniques']}")
        print(f"[*] Admin required: {summary['admin_required']}")
        print(f"[*] Non-admin: {summary['non_admin']}")
        
        print("\n[*] Stealth levels:")
        for level, count in summary['stealth_levels'].items():
            print(f"    • {level.capitalize()}: {count} techniques")
        
        # Execute non-admin techniques
        non_admin = self.cred_harvest.get_non_admin_techniques()
        
        print(f"\n[*] Executing {len(non_admin)} non-admin techniques...")
        for technique in non_admin:
            print(f"    ✓ {technique.name}")
            
            # Simulate credential findings
            if "browser" in technique.name.lower():
                self.findings.add_credential({
                    'type': 'browser',
                    'username': 'user@example.com',
                    'source': 'Chrome'
                })
            elif "wifi" in technique.name.lower():
                self.findings.add_credential({
                    'type': 'wifi',
                    'username': 'Corp-WiFi',
                    'source': 'Windows WiFi'
                })
        
        self.session.mark_phase_complete('credential_harvesting')
        print("\n[✓] Credential harvesting complete")
        
        return True
    
    def map_network(self) -> bool:
        """
        Phase 3: Network mapping
        Discover hosts, services, and network relationships
        
        Returns:
            True if mapping completed successfully
        """
        print("\n" + "="*60)
        print("PHASE 3: NETWORK MAPPING")
        print("="*60)
        
        summary = self.network_mapper.get_mapping_summary()
        
        print(f"\n[*] Total mapping tasks: {summary['total_tasks']}")
        print(f"[*] Common ports to scan: {summary['common_ports']}")
        
        print("\n[*] Task categories:")
        for category, count in summary['categories'].items():
            print(f"    • {category}: {count} tasks")
        
        print("\n[*] Executing network discovery...")
        
        # Simulate network findings
        for i in range(1, 11):
            self.findings.add_network_host(
                f"192.168.1.{i}",
                ports=[445, 3389, 5985] if i % 2 == 0 else [80, 443]
            )
        
        self.session.mark_phase_complete('network_mapping')
        print("\n[✓] Network mapping complete")
        
        return True
    
    def find_sensitive_data(self) -> bool:
        """
        Phase 4: Sensitive data discovery
        Locate high-value targets and intellectual property
        
        Returns:
            True if search completed successfully
        """
        print("\n" + "="*60)
        print("PHASE 4: SENSITIVE DATA DISCOVERY")
        print("="*60)
        
        summary = self.data_finder.get_search_summary()
        
        print(f"\n[*] Search categories: {summary['total_categories']}")
        
        print("\n[*] Categories:")
        for category, description in summary['descriptions'].items():
            print(f"    • {category}: {description}")
        
        print("\n[*] Executing sensitive data search...")
        
        # Simulate file findings
        categories = ['financial', 'credentials', 'database', 'configuration']
        for category in categories:
            for i in range(3):
                self.findings.add_sensitive_file({
                    'path': f'C:\\Users\\victim\\Documents\\{category}_{i}.txt',
                    'category': category,
                    'size': 1024 * (i + 1)
                })
        
        self.session.mark_phase_complete('sensitive_data_search')
        print("\n[✓] Sensitive data discovery complete")
        
        return True
    
    def identify_privilege_escalation(self) -> bool:
        """
        Phase 5: Privilege escalation identification
        Discover misconfigurations and weak permissions
        
        Returns:
            True if checks completed successfully
        """
        print("\n" + "="*60)
        print("PHASE 5: PRIVILEGE ESCALATION")
        print("="*60)
        
        summary = self.priv_esc.get_escalation_summary()
        
        print(f"\n[*] Total checks: {summary['total_checks']}")
        
        print("\n[*] By severity:")
        for severity, count in summary['by_severity'].items():
            print(f"    • {severity.capitalize()}: {count} checks")
        
        print("\n[*] Categories:")
        for category, details in summary['categories'].items():
            print(f"    • {category}: {details['total']} checks")
        
        # Execute high-severity checks
        high_severity = self.priv_esc.get_high_severity_checks()
        
        print(f"\n[*] Executing {len(high_severity)} high-severity checks...")
        for check in high_severity:
            print(f"    ✓ {check.description}")
            
            # Simulate privilege escalation findings
            if "unquoted" in check.name:
                self.findings.add_privilege_path({
                    'type': 'unquoted_service_path',
                    'details': 'VulnService - C:\\Program Files\\Vuln Service\\service.exe',
                    'severity': 'high'
                })
        
        self.session.mark_phase_complete('privilege_escalation')
        print("\n[✓] Privilege escalation checks complete")
        
        return True
    
    def compile_target_profile(self) -> bool:
        """
        Phase 6: Generate comprehensive target profile
        Compile all findings into actionable report
        
        Returns:
            True if profiling completed successfully
        """
        print("\n" + "="*60)
        print("PHASE 6: TARGET PROFILING")
        print("="*60)
        
        # Get statistics
        stats = self.findings.get_statistics()
        
        print("\n[*] Findings summary:")
        print(f"    • Credentials: {stats['total_credentials']}")
        print(f"    • Network Hosts: {stats['total_hosts']}")
        print(f"    • Sensitive Files: {stats['total_files']}")
        print(f"    • Privilege Paths: {stats['total_privilege_paths']}")
        print(f"    • Domain Users: {stats['total_users']}")
        print(f"    • Domain Computers: {stats['total_computers']}")
        
        # Save findings
        findings_file = self.findings.save_findings()
        print(f"\n[*] Findings saved to: {findings_file}")
        
        # Generate report
        report = self.findings.generate_report()
        print("\n[*] Report generated")
        
        self.session.mark_phase_complete('profiling')
        print("\n[✓] Target profiling complete")
        
        return True
    
    def execute_post_exploitation(self) -> bool:
        """
        Execute complete post-exploitation workflow
        Systematic reconnaissance from initial access to profile
        
        Returns:
            True if all phases completed successfully
        """
        print("\n" + "="*70)
        print(" "*15 + "POST-EXPLOITATION FRAMEWORK")
        print("="*70)
        print(f"Session ID: {self.session.session_id}")
        print(f"C2 Server: {self.session.c2_server}")
        print(f"Start Time: {self.session.start_time.strftime('%Y-%m-%d %H:%M:%S')}")
        print("="*70)
        
        # Phase 1: Domain Enumeration
        if not self.enumerate_domain():
            print("\n[!] Domain enumeration failed")
            return False
        
        # Phase 2: Credential Harvesting
        if not self.harvest_credentials():
            print("\n[!] Credential harvesting failed")
            return False
        
        # Phase 3: Network Mapping
        if not self.map_network():
            print("\n[!] Network mapping failed")
            return False
        
        # Phase 4: Sensitive Data Discovery
        if not self.find_sensitive_data():
            print("\n[!] Sensitive data discovery failed")
            return False
        
        # Phase 5: Privilege Escalation
        if not self.identify_privilege_escalation():
            print("\n[!] Privilege escalation checks failed")
            return False
        
        # Phase 6: Target Profiling
        if not self.compile_target_profile():
            print("\n[!] Target profiling failed")
            return False
        
        # Finalize session
        self.session.finalize()
        
        # Display final summary
        print("\n" + "="*70)
        print(" "*20 + "OPERATION COMPLETE")
        print("="*70)
        
        session_info = self.session.get_session_info()
        completion = session_info['completion_status']
        
        print(f"\nSession Duration: {session_info['elapsed_time']}")
        print(f"Completion: {completion['completion_percentage']}%")
        
        print("\n[*] Phase Status:")
        for phase, completed in completion['phases'].items():
            status = "✓" if completed else "✗"
            print(f"    {status} {phase.replace('_', ' ').title()}")
        
        stats = self.findings.get_statistics()
        print(f"\n[*] Total Findings:")
        print(f"    • Credentials: {stats['total_credentials']}")
        print(f"    • Network Hosts: {stats['total_hosts']}")
        print(f"    • Sensitive Files: {stats['total_files']}")
        print(f"    • Privilege Paths: {stats['total_privilege_paths']}")
        
        print("\n" + "="*70)
        
        return True
    
    def get_operation_summary(self) -> dict:
        """Get complete operation summary"""
        return {
            'session': self.session.get_session_info(),
            'findings': self.findings.get_statistics(),
            'modules': {
                'domain_enum': self.domain_enum.get_enumeration_summary(),
                'credential_harvest': self.cred_harvest.get_technique_summary(),
                'network_mapping': self.network_mapper.get_mapping_summary(),
                'sensitive_data': self.data_finder.get_search_summary(),
                'privilege_esc': self.priv_esc.get_escalation_summary()
            }
        }
