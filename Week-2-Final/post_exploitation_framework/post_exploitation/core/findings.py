#!/usr/bin/env python3
"""
Findings Management
Centralized storage and management of all post-exploitation findings
"""

import json
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Any


class FindingsManager:
    """
    Manages all post-exploitation findings
    Provides structured storage, retrieval, and reporting
    """
    
    def __init__(self, session_id: str, output_dir: str = "/tmp"):
        """
        Initialize findings manager
        
        Args:
            session_id: Session identifier
            output_dir: Directory for saving findings
        """
        self.session_id = session_id
        self.output_dir = Path(output_dir)
        
        # Structured findings storage
        self.findings = {
            'credentials': [],
            'network': {
                'live_hosts': [],
                'open_ports': [],
                'services': []
            },
            'systems': [],
            'shares': [],
            'sensitive_files': [],
            'privilege_paths': [],
            'domain_info': {},
            'users': [],
            'computers': [],
            'groups': []
        }
        
        # Statistics
        self.stats = {
            'total_credentials': 0,
            'total_hosts': 0,
            'total_files': 0,
            'total_privilege_paths': 0
        }
    
    def add_credential(self, credential: Dict) -> None:
        """
        Add discovered credential
        
        Args:
            credential: Dictionary with credential information
        """
        credential['timestamp'] = datetime.now().isoformat()
        self.findings['credentials'].append(credential)
        self.stats['total_credentials'] += 1
    
    def add_network_host(self, host: str, ports: List[int] = None) -> None:
        """
        Add discovered network host
        
        Args:
            host: IP address or hostname
            ports: List of open ports
        """
        host_entry = {
            'host': host,
            'ports': ports or [],
            'timestamp': datetime.now().isoformat()
        }
        self.findings['network']['live_hosts'].append(host_entry)
        self.stats['total_hosts'] += 1
    
    def add_sensitive_file(self, file_info: Dict) -> None:
        """
        Add discovered sensitive file
        
        Args:
            file_info: Dictionary with file information
        """
        file_info['timestamp'] = datetime.now().isoformat()
        self.findings['sensitive_files'].append(file_info)
        self.stats['total_files'] += 1
    
    def add_privilege_path(self, path_info: Dict) -> None:
        """
        Add privilege escalation path
        
        Args:
            path_info: Dictionary with escalation path details
        """
        path_info['timestamp'] = datetime.now().isoformat()
        self.findings['privilege_paths'].append(path_info)
        self.stats['total_privilege_paths'] += 1
    
    def add_domain_info(self, key: str, value: Any) -> None:
        """
        Add Active Directory domain information
        
        Args:
            key: Information key
            value: Information value
        """
        self.findings['domain_info'][key] = value
    
    def add_user(self, user_info: Dict) -> None:
        """Add domain user information"""
        self.findings['users'].append(user_info)
    
    def add_computer(self, computer_info: Dict) -> None:
        """Add domain computer information"""
        self.findings['computers'].append(computer_info)
    
    def add_group(self, group_info: Dict) -> None:
        """Add domain group information"""
        self.findings['groups'].append(group_info)
    
    def add_share(self, share_info: Dict) -> None:
        """Add network share information"""
        self.findings['shares'].append(share_info)
    
    def get_credentials(self) -> List[Dict]:
        """Get all discovered credentials"""
        return self.findings['credentials']
    
    def get_sensitive_files(self) -> List[Dict]:
        """Get all sensitive files"""
        return self.findings['sensitive_files']
    
    def get_privilege_paths(self) -> List[Dict]:
        """Get all privilege escalation paths"""
        return self.findings['privilege_paths']
    
    def get_statistics(self) -> Dict:
        """Get findings statistics"""
        return {
            **self.stats,
            'total_users': len(self.findings['users']),
            'total_computers': len(self.findings['computers']),
            'total_groups': len(self.findings['groups']),
            'total_shares': len(self.findings['shares'])
        }
    
    def get_all_findings(self) -> Dict:
        """Get all findings"""
        return self.findings.copy()
    
    def save_findings(self, filename: str = None) -> Path:
        """
        Save findings to JSON file
        
        Args:
            filename: Custom filename (default: session_id_findings.json)
            
        Returns:
            Path to saved file
        """
        if filename is None:
            filename = f"{self.session_id}_findings.json"
        
        output_path = self.output_dir / filename
        
        output_data = {
            'session_id': self.session_id,
            'timestamp': datetime.now().isoformat(),
            'statistics': self.get_statistics(),
            'findings': self.findings
        }
        
        with open(output_path, 'w') as f:
            json.dump(output_data, f, indent=2)
        
        return output_path
    
    def generate_report(self) -> str:
        """
        Generate human-readable findings report
        
        Returns:
            Formatted report string
        """
        stats = self.get_statistics()
        
        report = f"""
{'='*60}
POST-EXPLOITATION FINDINGS REPORT
Session: {self.session_id}
{'='*60}

STATISTICS
{'='*60}
Credentials Found:        {stats['total_credentials']}
Network Hosts:            {stats['total_hosts']}
Sensitive Files:          {stats['total_files']}
Privilege Paths:          {stats['total_privilege_paths']}
Domain Users:             {stats['total_users']}
Domain Computers:         {stats['total_computers']}
Domain Groups:            {stats['total_groups']}
Network Shares:           {stats['total_shares']}

"""
        
        # Credentials section
        if self.findings['credentials']:
            report += f"\nCREDENTIALS ({len(self.findings['credentials'])})\n"
            report += "="*60 + "\n"
            for cred in self.findings['credentials'][:10]:  # Show first 10
                report += f"  • Type: {cred.get('type', 'unknown')}\n"
                report += f"    User: {cred.get('username', 'N/A')}\n"
                report += f"    Source: {cred.get('source', 'N/A')}\n\n"
            
            if len(self.findings['credentials']) > 10:
                report += f"  ... and {len(self.findings['credentials']) - 10} more\n"
        
        # Privilege escalation paths
        if self.findings['privilege_paths']:
            report += f"\nPRIVILEGE ESCALATION PATHS ({len(self.findings['privilege_paths'])})\n"
            report += "="*60 + "\n"
            for path in self.findings['privilege_paths']:
                report += f"  • Type: {path.get('type', 'unknown')}\n"
                report += f"    Details: {path.get('details', 'N/A')}\n\n"
        
        # Sensitive files
        if self.findings['sensitive_files']:
            report += f"\nSENSITIVE FILES ({len(self.findings['sensitive_files'])})\n"
            report += "="*60 + "\n"
            for file in self.findings['sensitive_files'][:10]:
                report += f"  • {file.get('path', 'N/A')}\n"
                report += f"    Category: {file.get('category', 'unknown')}\n\n"
            
            if len(self.findings['sensitive_files']) > 10:
                report += f"  ... and {len(self.findings['sensitive_files']) - 10} more\n"
        
        report += "\n" + "="*60 + "\n"
        
        return report
