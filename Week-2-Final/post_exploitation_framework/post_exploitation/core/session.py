#!/usr/bin/env python3
"""
Session Management
Tracks post-exploitation session state and metadata
"""

import time
from datetime import datetime
from typing import Dict, Optional


class Session:
    """
    Represents a post-exploitation operation session
    Maintains state, timing, and target information
    """
    
    def __init__(self, session_id: str = None, c2_server: str = None):
        """
        Initialize post-exploitation session
        
        Args:
            session_id: Unique session identifier (auto-generated if not provided)
            c2_server: Command and Control server address
        """
        self.session_id = session_id or f"session_{int(time.time())}"
        self.c2_server = c2_server or "c2.server.com"
        self.start_time = datetime.now()
        self.end_time = None
        
        # Phase tracking
        self.phases_completed = {
            'domain_enumeration': False,
            'credential_harvesting': False,
            'network_mapping': False,
            'sensitive_data_search': False,
            'privilege_escalation': False,
            'profiling': False
        }
        
        # Metadata
        self.metadata = {
            'session_id': self.session_id,
            'c2_server': self.c2_server,
            'start_time': self.start_time.isoformat(),
            'target_platform': 'windows',  # Can be updated
            'operator': None
        }
    
    def mark_phase_complete(self, phase: str) -> None:
        """
        Mark a phase as complete
        
        Args:
            phase: Phase name to mark as complete
        """
        if phase in self.phases_completed:
            self.phases_completed[phase] = True
    
    def get_elapsed_time(self) -> float:
        """Get elapsed time in seconds since session start"""
        return (datetime.now() - self.start_time).total_seconds()
    
    def get_elapsed_time_formatted(self) -> str:
        """Get human-readable elapsed time"""
        seconds = self.get_elapsed_time()
        minutes = int(seconds // 60)
        secs = int(seconds % 60)
        hours = minutes // 60
        minutes = minutes % 60
        
        if hours > 0:
            return f"{hours}h {minutes}m {secs}s"
        elif minutes > 0:
            return f"{minutes}m {secs}s"
        else:
            return f"{secs}s"
    
    def get_completion_status(self) -> Dict:
        """Get phase completion status"""
        total = len(self.phases_completed)
        completed = sum(1 for v in self.phases_completed.values() if v)
        
        return {
            'total_phases': total,
            'completed_phases': completed,
            'completion_percentage': int((completed / total) * 100),
            'phases': self.phases_completed.copy()
        }
    
    def finalize(self) -> None:
        """Mark session as complete"""
        self.end_time = datetime.now()
        self.metadata['end_time'] = self.end_time.isoformat()
        self.metadata['total_duration'] = self.get_elapsed_time_formatted()
    
    def get_session_info(self) -> Dict:
        """Get complete session information"""
        return {
            'session_id': self.session_id,
            'c2_server': self.c2_server,
            'start_time': self.start_time.isoformat(),
            'elapsed_time': self.get_elapsed_time_formatted(),
            'completion_status': self.get_completion_status(),
            'metadata': self.metadata
        }
