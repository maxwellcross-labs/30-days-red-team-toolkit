#!/usr/bin/env python3
"""
Network Mapping Module
Comprehensive internal network discovery and mapping
"""

from typing import Dict, List
from dataclasses import dataclass


@dataclass
class NetworkScanTask:
    """Represents a network scanning task"""
    name: str
    description: str
    command: str
    category: str


class NetworkMapper:
    """
    Complete network mapping capabilities
    Discovers hosts, services, and network relationships
    """
    
    def __init__(self):
        """Initialize network mapper"""
        self.tasks = self._initialize_tasks()
        self.common_ports = [
            21,    # FTP
            22,    # SSH
            23,    # Telnet
            25,    # SMTP
            53,    # DNS
            80,    # HTTP
            88,    # Kerberos
            135,   # RPC
            139,   # NetBIOS
            389,   # LDAP
            443,   # HTTPS
            445,   # SMB
            1433,  # MSSQL
            3306,  # MySQL
            3389,  # RDP
            5985,  # WinRM HTTP
            5986,  # WinRM HTTPS
            8080,  # HTTP Alt
            8443   # HTTPS Alt
        ]
    
    def _initialize_tasks(self) -> List[NetworkScanTask]:
        """Initialize network scanning tasks"""
        return [
            NetworkScanTask(
                name="subnet_discovery",
                description="Discover current subnet information",
                category="Discovery",
                command="""
Write-Host "[*] Discovering subnet information..."

# Get network configuration
$networkConfig = Get-NetIPConfiguration

foreach ($config in $networkConfig) {
    if ($config.IPv4Address) {
        $ip = $config.IPv4Address.IPAddress
        $prefix = $config.IPv4Address.PrefixLength
        
        Write-Host "[+] Interface: $($config.InterfaceAlias)"
        Write-Host "    IP: $ip/$prefix"
        Write-Host "    Gateway: $($config.IPv4DefaultGateway.NextHop)"
        Write-Host "    DNS: $($config.DNSServer.ServerAddresses -join ', ')"
        
        # Calculate subnet
        $subnet = $ip -replace '\\d+$', ''
        Write-Host "    Subnet: $subnet*"
    }
}
"""
            ),
            
            NetworkScanTask(
                name="arp_discovery",
                description="Discover hosts via ARP cache",
                category="Discovery",
                command="""
Write-Host "[*] Checking ARP cache for known hosts..."

$arpCache = Get-NetNeighbor -AddressFamily IPv4 | 
    Where-Object {$_.State -ne 'Unreachable'} | 
    Select-Object IPAddress, LinkLayerAddress, State

Write-Host "[+] Known hosts from ARP cache:"
$arpCache | ForEach-Object {
    Write-Host "    $($_.IPAddress) - $($_.LinkLayerAddress) [$($_.State)]"
}
"""
            ),
            
            NetworkScanTask(
                name="dns_discovery",
                description="Query DNS for domain hosts",
                category="Discovery",
                command="""
Write-Host "[*] Querying DNS for domain hosts..."

# Get domain name
$domain = (Get-WmiObject Win32_ComputerSystem).Domain

if ($domain -and $domain -ne 'WORKGROUP') {
    Write-Host "[*] Domain: $domain"
    
    # Try to get DNS records
    try {
        $dnsRecords = Resolve-DnsName -Name $domain -Type A -ErrorAction SilentlyContinue
        
        if ($dnsRecords) {
            Write-Host "[+] Domain DNS records:"
            $dnsRecords | ForEach-Object {
                Write-Host "    $($_.Name) -> $($_.IPAddress)"
            }
        }
    } catch {
        Write-Host "[-] Could not query DNS"
    }
}
"""
            ),
            
            NetworkScanTask(
                name="ping_sweep",
                description="Fast ping sweep of subnet",
                category="Scanning",
                command="""
Write-Host "[*] Performing ping sweep..."

# Get local subnet
$subnet = (Get-NetIPConfiguration).IPv4Address.IPAddress -replace '\\d+$', ''

Write-Host "[*] Scanning subnet: $subnet*"

$liveHosts = 1..254 | ForEach-Object -Parallel {
    $ip = "{using:subnet}$_"
    if (Test-Connection -ComputerName $ip -Count 1 -Quiet -TimeoutSeconds 1) {
        $ip
    }
} -ThrottleLimit 50

Write-Host "[+] Live hosts found: $($liveHosts.Count)"
$liveHosts | ForEach-Object { Write-Host "    $_" }

# Return for further scanning
return $liveHosts
"""
            ),
            
            NetworkScanTask(
                name="port_scan",
                description="Scan common ports on discovered hosts",
                category="Scanning",
                command="""
Write-Host "[*] Scanning common ports..."

$ports = @(21,22,23,25,53,80,88,135,139,389,443,445,1433,3306,3389,5985,5986,8080,8443)

foreach ($target in $liveHosts) {
    Write-Host "[*] Scanning: $target"
    
    $openPorts = @()
    
    foreach ($port in $ports) {
        $socket = New-Object System.Net.Sockets.TcpClient
        try {
            $socket.ConnectAsync($target, $port).Wait(100) | Out-Null
            
            if ($socket.Connected) {
                $openPorts += $port
                $socket.Close()
            }
        } catch {
            # Port closed or filtered
        }
    }
    
    if ($openPorts.Count -gt 0) {
        Write-Host "[+] $target - Open ports: $($openPorts -join ', ')"
    }
}
"""
            ),
            
            NetworkScanTask(
                name="smb_enumeration",
                description="Enumerate SMB shares on network",
                category="Service Enum",
                command="""
Write-Host "[*] Enumerating SMB shares..."

foreach ($target in $liveHosts) {
    try {
        # Try to list shares
        $shares = net view \\\\$target /all 2>$null
        
        if ($shares) {
            Write-Host "[+] $target - Shares:"
            $shares | Where-Object {$_ -match '^\\s'} | ForEach-Object {
                Write-Host "    $_"
            }
        }
    } catch {
        # Access denied or not available
    }
}
"""
            ),
            
            NetworkScanTask(
                name="service_identification",
                description="Identify services on open ports",
                category="Service Enum",
                command="""
Write-Host "[*] Identifying services..."

$serviceMap = @{
    21 = "FTP"
    22 = "SSH"
    23 = "Telnet"
    25 = "SMTP"
    53 = "DNS"
    80 = "HTTP"
    88 = "Kerberos"
    135 = "RPC"
    139 = "NetBIOS"
    389 = "LDAP"
    443 = "HTTPS"
    445 = "SMB"
    1433 = "MSSQL"
    3306 = "MySQL"
    3389 = "RDP"
    5985 = "WinRM-HTTP"
    5986 = "WinRM-HTTPS"
    8080 = "HTTP-Alt"
}

# Map open ports to services
# (This would use results from port_scan)
Write-Host "[+] Service mapping complete"
"""
            ),
            
            NetworkScanTask(
                name="domain_computers",
                description="List all domain computers",
                category="Domain",
                command="""
Write-Host "[*] Querying domain for computers..."

try {
    Import-Module ActiveDirectory -ErrorAction Stop
    
    $computers = Get-ADComputer -Filter * -Properties OperatingSystem, IPv4Address, LastLogonDate
    
    Write-Host "[+] Domain computers: $($computers.Count)"
    
    $computers | ForEach-Object {
        Write-Host "    $($_.Name)"
        Write-Host "      OS: $($_.OperatingSystem)"
        Write-Host "      IP: $($_.IPv4Address)"
        Write-Host "      Last Logon: $($_.LastLogonDate)"
    }
} catch {
    Write-Host "[-] Could not query Active Directory"
}
"""
            ),
            
            NetworkScanTask(
                name="routing_table",
                description="Display routing table",
                category="Discovery",
                command="""
Write-Host "[*] Checking routing table..."

$routes = Get-NetRoute -AddressFamily IPv4 | 
    Where-Object {$_.DestinationPrefix -ne '255.255.255.255/32'} |
    Select-Object DestinationPrefix, NextHop, InterfaceAlias, RouteMetric

Write-Host "[+] Network routes:"
$routes | ForEach-Object {
    Write-Host "    $($_.DestinationPrefix) via $($_.NextHop) [$($_.InterfaceAlias)]"
}
"""
            )
        ]
    
    def get_tasks_by_category(self, category: str) -> List[NetworkScanTask]:
        """Get tasks for specific category"""
        return [task for task in self.tasks if task.category.lower() == category.lower()]
    
    def get_all_tasks(self) -> List[NetworkScanTask]:
        """Get all network mapping tasks"""
        return self.tasks
    
    def get_common_ports(self) -> List[int]:
        """Get list of common ports to scan"""
        return self.common_ports
    
    def generate_mapping_script(self) -> str:
        """
        Generate complete network mapping PowerShell script
        
        Returns:
            PowerShell script for network mapping
        """
        script = """# Network Mapping Script
# Comprehensive internal network discovery

Write-Host "[*] Starting network mapping..."

# Create output file
$outputFile = "$env:TEMP\\netmap_$(Get-Date -Format 'yyyyMMdd_HHmmss').txt"
Start-Transcript -Path $outputFile

"""
        
        for task in self.get_all_tasks():
            script += f"""
# {task.description}
Write-Host "`n{'='*60}"
Write-Host "[*] {task.name.upper()}"
Write-Host "{'='*60}"

{task.command}

"""
        
        script += """
Write-Host "`n[+] Network mapping complete"
Write-Host "[*] Results saved to: $outputFile"

Stop-Transcript
"""
        
        return script
    
    def get_port_service_map(self) -> Dict[int, str]:
        """Get port to service mapping"""
        return {
            21: "FTP",
            22: "SSH",
            23: "Telnet",
            25: "SMTP",
            53: "DNS",
            80: "HTTP",
            88: "Kerberos",
            135: "RPC",
            139: "NetBIOS",
            389: "LDAP",
            443: "HTTPS",
            445: "SMB",
            1433: "MSSQL",
            3306: "MySQL",
            3389: "RDP",
            5985: "WinRM-HTTP",
            5986: "WinRM-HTTPS",
            8080: "HTTP-Alt",
            8443: "HTTPS-Alt"
        }
    
    def get_mapping_summary(self) -> Dict:
        """Get summary of mapping capabilities"""
        categories = {}
        for task in self.tasks:
            if task.category not in categories:
                categories[task.category] = 0
            categories[task.category] += 1
        
        return {
            'total_tasks': len(self.tasks),
            'categories': categories,
            'common_ports': len(self.common_ports)
        }
