#!/usr/bin/env python3
"""
Active Directory Enumeration Module
Comprehensive domain reconnaissance
"""

from typing import Dict, List
from dataclasses import dataclass


@dataclass
class ADCommand:
    """Represents a single AD enumeration command"""
    name: str
    description: str
    command: str
    category: str
    priority: int  # 1=critical, 2=important, 3=nice-to-have


class DomainEnumerator:
    """
    Comprehensive Active Directory enumeration
    Discovers users, computers, groups, trusts, and GPOs
    """
    
    def __init__(self):
        """Initialize domain enumerator"""
        self.commands = self._initialize_commands()
    
    def _initialize_commands(self) -> List[ADCommand]:
        """Initialize AD enumeration commands"""
        return [
            # Critical - Domain Information
            ADCommand(
                name="domain_info",
                description="Basic domain information",
                category="Domain",
                priority=1,
                command="Get-ADDomain"
            ),
            ADCommand(
                name="forest_info",
                description="Forest information",
                category="Domain",
                priority=1,
                command="Get-ADForest"
            ),
            ADCommand(
                name="domain_controllers",
                description="All domain controllers",
                category="Domain",
                priority=1,
                command="Get-ADDomainController -Filter *"
            ),
            
            # Critical - Users
            ADCommand(
                name="all_users",
                description="All domain users with properties",
                category="Users",
                priority=1,
                command="Get-ADUser -Filter * -Properties *"
            ),
            ADCommand(
                name="enabled_users",
                description="All enabled user accounts",
                category="Users",
                priority=1,
                command="Get-ADUser -Filter {Enabled -eq $true} -Properties *"
            ),
            ADCommand(
                name="admin_users",
                description="Domain administrator accounts",
                category="Users",
                priority=1,
                command="Get-ADGroupMember 'Domain Admins' -Recursive"
            ),
            ADCommand(
                name="enterprise_admins",
                description="Enterprise administrator accounts",
                category="Users",
                priority=1,
                command="Get-ADGroupMember 'Enterprise Admins' -Recursive"
            ),
            ADCommand(
                name="service_accounts",
                description="Service principal accounts",
                category="Users",
                priority=2,
                command="Get-ADUser -Filter {ServicePrincipalName -like '*'} -Properties ServicePrincipalName"
            ),
            ADCommand(
                name="password_not_required",
                description="Users with password not required",
                category="Users",
                priority=2,
                command="Get-ADUser -Filter {PasswordNotRequired -eq $true} -Properties PasswordNotRequired"
            ),
            ADCommand(
                name="password_never_expires",
                description="Users with non-expiring passwords",
                category="Users",
                priority=2,
                command="Get-ADUser -Filter {PasswordNeverExpires -eq $true} -Properties PasswordNeverExpires"
            ),
            
            # Important - Computers
            ADCommand(
                name="all_computers",
                description="All domain computers",
                category="Computers",
                priority=1,
                command="Get-ADComputer -Filter * -Properties *"
            ),
            ADCommand(
                name="servers",
                description="Server operating systems",
                category="Computers",
                priority=2,
                command="Get-ADComputer -Filter {OperatingSystem -like '*Server*'} -Properties OperatingSystem"
            ),
            ADCommand(
                name="workstations",
                description="Workstation computers",
                category="Computers",
                priority=2,
                command="Get-ADComputer -Filter {OperatingSystem -notlike '*Server*'} -Properties OperatingSystem"
            ),
            
            # Important - Groups
            ADCommand(
                name="all_groups",
                description="All domain groups",
                category="Groups",
                priority=2,
                command="Get-ADGroup -Filter * -Properties *"
            ),
            ADCommand(
                name="privileged_groups",
                description="High-privilege groups",
                category="Groups",
                priority=1,
                command="""
                @('Domain Admins', 'Enterprise Admins', 'Schema Admins', 
                  'Administrators', 'Account Operators', 'Backup Operators',
                  'Print Operators', 'Server Operators', 'Group Policy Creator Owners') | 
                ForEach-Object { Get-ADGroup $_ -Properties * }
                """
            ),
            
            # Important - GPOs
            ADCommand(
                name="all_gpos",
                description="All Group Policy Objects",
                category="GPO",
                priority=2,
                command="Get-GPO -All"
            ),
            ADCommand(
                name="gpo_permissions",
                description="GPO permissions and ownership",
                category="GPO",
                priority=2,
                command="Get-GPO -All | Get-GPPermission -All"
            ),
            
            # Important - Trusts
            ADCommand(
                name="domain_trusts",
                description="Domain trust relationships",
                category="Trusts",
                priority=2,
                command="Get-ADTrust -Filter *"
            ),
            
            # Nice-to-have - Additional
            ADCommand(
                name="organizational_units",
                description="Organizational unit structure",
                category="Structure",
                priority=3,
                command="Get-ADOrganizationalUnit -Filter *"
            ),
            ADCommand(
                name="fine_grained_policies",
                description="Fine-grained password policies",
                category="Policies",
                priority=3,
                command="Get-ADFineGrainedPasswordPolicy -Filter *"
            )
        ]
    
    def get_critical_commands(self) -> List[ADCommand]:
        """Get priority 1 commands"""
        return [cmd for cmd in self.commands if cmd.priority == 1]
    
    def get_all_commands(self) -> List[ADCommand]:
        """Get all enumeration commands"""
        return sorted(self.commands, key=lambda x: x.priority)
    
    def get_commands_by_category(self, category: str) -> List[ADCommand]:
        """Get commands for specific category"""
        return [cmd for cmd in self.commands if cmd.category.lower() == category.lower()]
    
    def get_categories(self) -> List[str]:
        """Get all unique categories"""
        return list(set(cmd.category for cmd in self.commands))
    
    def generate_enumeration_script(self) -> str:
        """
        Generate complete AD enumeration PowerShell script
        
        Returns:
            PowerShell script for AD enumeration
        """
        script = """# Active Directory Enumeration Script
# Comprehensive domain reconnaissance

# Check if we're in a domain
$isDomain = (Get-WmiObject Win32_ComputerSystem).PartOfDomain

if (-not $isDomain) {
    Write-Host "[!] This system is not joined to a domain"
    exit
}

# Import Active Directory module
Import-Module ActiveDirectory -ErrorAction SilentlyContinue

if (-not (Get-Module ActiveDirectory)) {
    Write-Host "[!] Active Directory module not available"
    exit
}

Write-Host "[*] Starting Active Directory enumeration..."

# Create output directory
$outputDir = "$env:TEMP\\ADEnum_$(Get-Date -Format 'yyyyMMdd_HHmmss')"
New-Item -ItemType Directory -Path $outputDir -Force | Out-Null

"""
        
        for cmd in self.get_all_commands():
            script += f"""
# {cmd.description}
Write-Host "[*] Enumerating: {cmd.description}..."
try {{
    {cmd.command} | Export-Clixml "$outputDir\\{cmd.name}.xml"
    Write-Host "[+] {cmd.name} complete"
}} catch {{
    Write-Host "[-] Failed: {cmd.name} - $_"
}}

"""
        
        script += """
Write-Host "[+] Enumeration complete"
Write-Host "[*] Results saved to: $outputDir"

# Compress results
$zipFile = "$env:TEMP\\ADEnum_$(Get-Date -Format 'yyyyMMdd_HHmmss').zip"
Compress-Archive -Path $outputDir -DestinationPath $zipFile
Write-Host "[*] Compressed results: $zipFile"
"""
        
        return script
    
    def get_enumeration_summary(self) -> Dict:
        """Get summary of enumeration capabilities"""
        categories = {}
        for cmd in self.commands:
            if cmd.category not in categories:
                categories[cmd.category] = {
                    'total': 0,
                    'critical': 0,
                    'important': 0,
                    'nice_to_have': 0
                }
            categories[cmd.category]['total'] += 1
            
            if cmd.priority == 1:
                categories[cmd.category]['critical'] += 1
            elif cmd.priority == 2:
                categories[cmd.category]['important'] += 1
            else:
                categories[cmd.category]['nice_to_have'] += 1
        
        return {
            'total_commands': len(self.commands),
            'categories': categories,
            'critical_commands': len(self.get_critical_commands())
        }
