"""
Sudo Permissions Data Structures
================================

Data structures for representing sudo permissions and exploitation results.
"""

from dataclasses import dataclass, field
from typing import List, Optional, Dict, Any
from datetime import datetime
from enum import Enum


class ExploitStatus(Enum):
    """Status of exploitation attempt"""
    SUCCESS = "success"
    FAILED = "failed"
    INTERACTIVE = "interactive"
    UNTESTED = "untested"
    ERROR = "error"


@dataclass
class SudoCommand:
    """
    Represents a single command allowed via sudo.

    Attributes:
        full_path: Full path to the binary (e.g., /usr/bin/vim)
        name: Binary name (e.g., vim)
        args: Any arguments specified (e.g., /etc/hosts)
        is_all: Whether this is the ALL permission
    """
    full_path: str
    name: str
    args: str = ""
    is_all: bool = False

    def to_dict(self) -> Dict[str, Any]:
        return {
            'full_path': self.full_path,
            'name': self.name,
            'args': self.args,
            'is_all': self.is_all
        }

    def __str__(self) -> str:
        if self.is_all:
            return "ALL"
        return f"{self.full_path} {self.args}".strip()


@dataclass
class SudoPermission:
    """
    Represents a sudo permission entry from sudo -l.

    Attributes:
        raw_line: Original line from sudo -l
        run_as_user: User the command runs as (usually root)
        run_as_group: Group the command runs as
        nopasswd: Whether NOPASSWD is set
        commands: List of allowed commands
        tags: Additional sudo tags (SETENV, etc.)
    """
    raw_line: str
    run_as_user: str = "root"
    run_as_group: Optional[str] = None
    nopasswd: bool = False
    commands: List[SudoCommand] = field(default_factory=list)
    tags: List[str] = field(default_factory=list)

    @property
    def is_exploitable(self) -> bool:
        """Check if this permission is potentially exploitable"""
        # ANY command means automatic root
        for cmd in self.commands:
            if cmd.is_all:
                return True
        return len(self.commands) > 0

    @property
    def severity(self) -> str:
        """Determine severity of this permission"""
        for cmd in self.commands:
            if cmd.is_all:
                return "CRITICAL"

        if self.nopasswd:
            return "CRITICAL"

        return "HIGH"

    def to_dict(self) -> Dict[str, Any]:
        return {
            'raw_line': self.raw_line,
            'run_as_user': self.run_as_user,
            'run_as_group': self.run_as_group,
            'nopasswd': self.nopasswd,
            'commands': [cmd.to_dict() for cmd in self.commands],
            'tags': self.tags,
            'severity': self.severity
        }

    def __str__(self) -> str:
        nopasswd_str = " [NOPASSWD]" if self.nopasswd else ""
        cmds = ", ".join(str(cmd) for cmd in self.commands)
        return f"({self.run_as_user}){nopasswd_str}: {cmds}"


@dataclass
class ExploitableCommand:
    """
    A sudo command that has known exploitation techniques.

    Attributes:
        permission: The sudo permission this came from
        command: The specific command
        exploits: List of exploitation commands
        gtfobins_url: URL to GTFOBins page
    """
    permission: SudoPermission
    command: SudoCommand
    exploits: List[str] = field(default_factory=list)
    gtfobins_url: str = ""

    @property
    def is_nopasswd(self) -> bool:
        return self.permission.nopasswd

    def to_dict(self) -> Dict[str, Any]:
        return {
            'command': self.command.to_dict(),
            'nopasswd': self.is_nopasswd,
            'run_as': self.permission.run_as_user,
            'exploits': self.exploits,
            'gtfobins_url': self.gtfobins_url
        }

    def __str__(self) -> str:
        nopasswd = " [NOPASSWD]" if self.is_nopasswd else ""
        return f"sudo {self.command.name}{nopasswd}"


@dataclass
class ExploitResult:
    """
    Result of a sudo exploitation attempt.
    """
    target: ExploitableCommand
    technique: str
    command_executed: str
    status: ExploitStatus
    output: str = ""
    got_root: bool = False
    error: Optional[str] = None
    attempted_at: datetime = field(default_factory=datetime.now)

    def to_dict(self) -> Dict[str, Any]:
        return {
            'target_binary': self.target.command.name,
            'technique': self.technique,
            'command_executed': self.command_executed,
            'status': self.status.value,
            'output': self.output,
            'got_root': self.got_root,
            'error': self.error,
            'attempted_at': self.attempted_at.isoformat()
        }


@dataclass
class SudoScanResult:
    """
    Complete results of a sudo scan.
    """
    permissions: List[SudoPermission] = field(default_factory=list)
    exploitable: List[ExploitableCommand] = field(default_factory=list)
    exploit_results: List[ExploitResult] = field(default_factory=list)
    sudo_version: Optional[str] = None
    scan_time: datetime = field(default_factory=datetime.now)

    @property
    def has_nopasswd(self) -> bool:
        """Check if any NOPASSWD permissions exist"""
        return any(p.nopasswd for p in self.permissions)

    @property
    def has_all_permission(self) -> bool:
        """Check if user has full sudo access"""
        for perm in self.permissions:
            for cmd in perm.commands:
                if cmd.is_all:
                    return True
        return False

    @property
    def successful_exploits(self) -> List[ExploitResult]:
        return [r for r in self.exploit_results if r.got_root]

    def to_dict(self) -> Dict[str, Any]:
        return {
            'scan_time': self.scan_time.isoformat(),
            'sudo_version': self.sudo_version,
            'summary': {
                'total_permissions': len(self.permissions),
                'exploitable_commands': len(self.exploitable),
                'has_nopasswd': self.has_nopasswd,
                'has_all_permission': self.has_all_permission
            },
            'permissions': [p.to_dict() for p in self.permissions],
            'exploitable': [e.to_dict() for e in self.exploitable],
            'exploit_results': [r.to_dict() for r in self.exploit_results]
        }

    def print_summary(self) -> None:
        """Print scan summary"""
        print(f"\n{'=' * 60}")
        print(f"SUDO SCAN SUMMARY")
        print(f"{'=' * 60}")

        if self.sudo_version:
            print(f"Sudo version: {self.sudo_version}")

        print(f"Total permission entries: {len(self.permissions)}")
        print(f"Exploitable commands: {len(self.exploitable)}")

        if self.has_all_permission:
            print(f"[!!!] User has FULL sudo access (ALL)")

        if self.has_nopasswd:
            print(f"[+] NOPASSWD entries found!")