"""
Binary Data Structures
======================

Data structures for SUID binary findings and exploitation results.
"""

from dataclasses import dataclass, field
from typing import List, Optional, Dict, Any
from datetime import datetime
from enum import Enum


class ExploitStatus(Enum):
    """Status of exploitation attempt"""
    SUCCESS = "success"  # Got root/elevated privileges
    FAILED = "failed"  # Exploit did not work
    INTERACTIVE = "interactive"  # Requires interactive shell
    UNTESTED = "untested"  # Not yet tested
    ERROR = "error"  # Error during exploitation


@dataclass
class SUIDFinding:
    """
    Represents a discovered SUID binary.

    Attributes:
        path: Full path to the binary
        name: Binary name (basename)
        owner_uid: UID of the binary owner
        owner_name: Username of the binary owner
        is_exploitable: Whether binary is in GTFOBins
        is_unusual: Whether binary is non-standard
        permissions: Permission string (e.g., -rwsr-xr-x)
        file_type: Output from 'file' command
    """
    path: str
    name: str
    owner_uid: int = 0
    owner_name: str = "root"
    is_exploitable: bool = False
    is_unusual: bool = False
    permissions: str = ""
    file_type: str = ""
    discovered_at: datetime = field(default_factory=datetime.now)

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'path': self.path,
            'name': self.name,
            'owner_uid': self.owner_uid,
            'owner_name': self.owner_name,
            'is_exploitable': self.is_exploitable,
            'is_unusual': self.is_unusual,
            'permissions': self.permissions,
            'file_type': self.file_type,
            'discovered_at': self.discovered_at.isoformat()
        }

    @property
    def gtfobins_url(self) -> str:
        """Get GTFOBins URL for this binary"""
        return f"https://gtfobins.github.io/gtfobins/{self.name}/#suid"

    def __str__(self) -> str:
        status = "EXPLOITABLE" if self.is_exploitable else "UNUSUAL" if self.is_unusual else "STANDARD"
        return f"[{status}] {self.path} (owner: {self.owner_name})"


@dataclass
class ExploitResult:
    """
    Result of an exploitation attempt.

    Attributes:
        binary: The SUID binary that was targeted
        technique: Description of exploitation technique used
        command: The command that was executed
        status: ExploitStatus indicating result
        output: Output from the exploitation attempt
        got_root: Whether root was achieved
        error: Error message if any
    """
    binary: SUIDFinding
    technique: str
    command: str
    status: ExploitStatus
    output: str = ""
    got_root: bool = False
    error: Optional[str] = None
    attempted_at: datetime = field(default_factory=datetime.now)

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'binary_path': self.binary.path,
            'binary_name': self.binary.name,
            'technique': self.technique,
            'command': self.command,
            'status': self.status.value,
            'output': self.output,
            'got_root': self.got_root,
            'error': self.error,
            'attempted_at': self.attempted_at.isoformat()
        }

    def __str__(self) -> str:
        status_icon = "✓" if self.got_root else "✗" if self.status == ExploitStatus.FAILED else "?"
        return f"[{status_icon}] {self.binary.name}: {self.technique} -> {self.status.value}"


@dataclass
class SUIDScanResult:
    """
    Complete results of a SUID scan.

    Attributes:
        all_binaries: All SUID binaries found
        exploitable: Binaries with known exploits
        unusual: Non-standard binaries worth investigating
        standard: Common system binaries
        exploit_results: Results of exploitation attempts
    """
    all_binaries: List[SUIDFinding] = field(default_factory=list)
    exploitable: List[SUIDFinding] = field(default_factory=list)
    unusual: List[SUIDFinding] = field(default_factory=list)
    standard: List[SUIDFinding] = field(default_factory=list)
    exploit_results: List[ExploitResult] = field(default_factory=list)
    scan_time: datetime = field(default_factory=datetime.now)

    @property
    def total_count(self) -> int:
        return len(self.all_binaries)

    @property
    def exploitable_count(self) -> int:
        return len(self.exploitable)

    @property
    def unusual_count(self) -> int:
        return len(self.unusual)

    @property
    def successful_exploits(self) -> List[ExploitResult]:
        return [r for r in self.exploit_results if r.got_root]

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary"""
        return {
            'scan_time': self.scan_time.isoformat(),
            'summary': {
                'total': self.total_count,
                'exploitable': self.exploitable_count,
                'unusual': self.unusual_count,
                'standard': len(self.standard)
            },
            'exploitable_binaries': [b.to_dict() for b in self.exploitable],
            'unusual_binaries': [b.to_dict() for b in self.unusual],
            'exploit_results': [r.to_dict() for r in self.exploit_results]
        }

    def print_summary(self) -> None:
        """Print scan summary"""
        print(f"\n{'=' * 60}")
        print(f"SUID SCAN SUMMARY")
        print(f"{'=' * 60}")
        print(f"Total SUID binaries: {self.total_count}")
        print(f"  Exploitable (GTFOBins): {self.exploitable_count}")
        print(f"  Unusual (investigate): {self.unusual_count}")
        print(f"  Standard (likely safe): {len(self.standard)}")

        if self.exploit_results:
            successful = len(self.successful_exploits)
            print(f"\nExploitation attempts: {len(self.exploit_results)}")
            print(f"  Successful: {successful}")