"""
Group Data Structures
=====================

Data structures for representing dangerous groups and exploitation results.
"""

from dataclasses import dataclass, field
from typing import List, Optional, Dict, Any
from datetime import datetime
from enum import Enum


class Severity(Enum):
    """Severity/Impact level of group membership"""
    CRITICAL = "critical"  # Instant root access
    HIGH = "high"  # Significant privilege escalation
    MEDIUM = "medium"  # Useful access/information
    LOW = "low"  # Limited impact


class Difficulty(Enum):
    """Exploitation difficulty"""
    TRIVIAL = "trivial"  # One command
    EASY = "easy"  # Few simple steps
    MEDIUM = "medium"  # Requires some setup
    HARD = "hard"  # Complex exploitation


@dataclass
class DangerousGroup:
    """
    Definition of a dangerous group.

    Attributes:
        name: Group name (e.g., 'docker', 'lxd')
        description: What the group allows
        impact: Security impact of membership
        severity: Severity level
        difficulty: Exploitation difficulty
        exploitation: Brief description of exploitation method
        success_rate: Estimated success rate (0.0-1.0)
    """
    name: str
    description: str
    impact: str
    severity: Severity
    difficulty: Difficulty
    exploitation: str
    success_rate: float = 0.9

    def to_dict(self) -> Dict[str, Any]:
        return {
            'name': self.name,
            'description': self.description,
            'impact': self.impact,
            'severity': self.severity.value,
            'difficulty': self.difficulty.value,
            'exploitation': self.exploitation,
            'success_rate': self.success_rate
        }


# Pre-defined dangerous groups
DANGEROUS_GROUPS = {
    'docker': DangerousGroup(
        name='docker',
        description='Docker container management - can create containers',
        impact='CRITICAL - Instant root access by mounting host filesystem',
        severity=Severity.CRITICAL,
        difficulty=Difficulty.TRIVIAL,
        exploitation='Mount host / into container, chroot to access as root',
        success_rate=0.98
    ),
    'lxd': DangerousGroup(
        name='lxd',
        description='LXD/LXC container management',
        impact='CRITICAL - Root via privileged container with host mount',
        severity=Severity.CRITICAL,
        difficulty=Difficulty.EASY,
        exploitation='Create privileged container, mount host filesystem',
        success_rate=0.95
    ),
    'lxc': DangerousGroup(
        name='lxc',
        description='LXC container management (legacy)',
        impact='CRITICAL - Similar to lxd group',
        severity=Severity.CRITICAL,
        difficulty=Difficulty.EASY,
        exploitation='Create privileged container with host access',
        success_rate=0.90
    ),
    'disk': DangerousGroup(
        name='disk',
        description='Direct access to block devices (/dev/sda, etc.)',
        impact='HIGH - Read/write any file via raw disk access',
        severity=Severity.HIGH,
        difficulty=Difficulty.MEDIUM,
        exploitation='Use debugfs to read /etc/shadow or write files',
        success_rate=0.85
    ),
    'video': DangerousGroup(
        name='video',
        description='Access to video/framebuffer devices',
        impact='MEDIUM - Screen capture, potential credential theft',
        severity=Severity.MEDIUM,
        difficulty=Difficulty.MEDIUM,
        exploitation='Capture framebuffer to screenshot user activity',
        success_rate=0.70
    ),
    'adm': DangerousGroup(
        name='adm',
        description='System log access',
        impact='LOW - Read system logs for sensitive information',
        severity=Severity.LOW,
        difficulty=Difficulty.TRIVIAL,
        exploitation='Read /var/log/* for credentials, tokens, secrets',
        success_rate=0.95
    ),
    'sudo': DangerousGroup(
        name='sudo',
        description='Sudo group membership',
        impact='HIGH - Depends on sudo configuration',
        severity=Severity.HIGH,
        difficulty=Difficulty.EASY,
        exploitation='Check sudo -l for available commands',
        success_rate=0.90
    ),
    'wheel': DangerousGroup(
        name='wheel',
        description='Administrative group (RHEL/CentOS)',
        impact='HIGH - Typically grants sudo access',
        severity=Severity.HIGH,
        difficulty=Difficulty.EASY,
        exploitation='Check sudo -l for available commands',
        success_rate=0.90
    ),
    'shadow': DangerousGroup(
        name='shadow',
        description='Read access to /etc/shadow',
        impact='HIGH - Password hash extraction',
        severity=Severity.HIGH,
        difficulty=Difficulty.TRIVIAL,
        exploitation='cat /etc/shadow, crack hashes offline',
        success_rate=0.99
    ),
    'staff': DangerousGroup(
        name='staff',
        description='Write access to /usr/local without root',
        impact='MEDIUM - Binary planting, PATH hijacking',
        severity=Severity.MEDIUM,
        difficulty=Difficulty.MEDIUM,
        exploitation='Plant malicious binaries in /usr/local/bin',
        success_rate=0.75
    ),
    'kmem': DangerousGroup(
        name='kmem',
        description='Kernel memory access',
        impact='CRITICAL - Direct kernel memory read/write',
        severity=Severity.CRITICAL,
        difficulty=Difficulty.HARD,
        exploitation='Read kernel memory for credentials/keys',
        success_rate=0.60
    ),
    'dialout': DangerousGroup(
        name='dialout',
        description='Serial port access',
        impact='LOW - Access to serial devices',
        severity=Severity.LOW,
        difficulty=Difficulty.MEDIUM,
        exploitation='Access serial-connected devices',
        success_rate=0.50
    ),
    'audio': DangerousGroup(
        name='audio',
        description='Audio device access',
        impact='LOW - Audio recording capability',
        severity=Severity.LOW,
        difficulty=Difficulty.EASY,
        exploitation='Record audio from microphone',
        success_rate=0.60
    ),
    'cdrom': DangerousGroup(
        name='cdrom',
        description='CD-ROM device access',
        impact='LOW - Read optical media',
        severity=Severity.LOW,
        difficulty=Difficulty.TRIVIAL,
        exploitation='Access CD/DVD content',
        success_rate=0.80
    ),
    'plugdev': DangerousGroup(
        name='plugdev',
        description='Removable device access',
        impact='LOW - Mount USB devices',
        severity=Severity.LOW,
        difficulty=Difficulty.TRIVIAL,
        exploitation='Access USB storage devices',
        success_rate=0.80
    )
}


@dataclass
class GroupFinding:
    """
    Represents a discovered dangerous group membership.

    Attributes:
        group: The dangerous group
        is_member: Whether current user is a member
        gid: Group ID
        members: Other members of the group
    """
    group: DangerousGroup
    is_member: bool = True
    gid: Optional[int] = None
    members: List[str] = field(default_factory=list)

    def to_dict(self) -> Dict[str, Any]:
        return {
            'group': self.group.to_dict(),
            'is_member': self.is_member,
            'gid': self.gid,
            'members': self.members
        }

    def __str__(self) -> str:
        return f"[{self.group.severity.value.upper()}] {self.group.name}: {self.group.impact}"


class ExploitStatus(Enum):
    """Status of exploitation attempt"""
    SUCCESS = "success"
    FAILED = "failed"
    INTERACTIVE = "interactive"
    MANUAL = "manual"
    ERROR = "error"


@dataclass
class ExploitResult:
    """
    Result of a group exploitation attempt.
    """
    finding: GroupFinding
    method: str
    status: ExploitStatus
    output: str = ""
    got_root: bool = False
    artifacts: List[str] = field(default_factory=list)
    error: Optional[str] = None
    timestamp: datetime = field(default_factory=datetime.now)

    def to_dict(self) -> Dict[str, Any]:
        return {
            'group': self.finding.group.name,
            'method': self.method,
            'status': self.status.value,
            'output': self.output,
            'got_root': self.got_root,
            'artifacts': self.artifacts,
            'error': self.error,
            'timestamp': self.timestamp.isoformat()
        }


@dataclass
class GroupScanResult:
    """Complete results of a group scan"""
    user: str
    uid: int
    all_groups: List[str] = field(default_factory=list)
    findings: List[GroupFinding] = field(default_factory=list)
    exploit_results: List[ExploitResult] = field(default_factory=list)
    scan_time: datetime = field(default_factory=datetime.now)

    @property
    def critical_findings(self) -> List[GroupFinding]:
        return [f for f in self.findings if f.group.severity == Severity.CRITICAL]

    @property
    def high_findings(self) -> List[GroupFinding]:
        return [f for f in self.findings if f.group.severity == Severity.HIGH]

    @property
    def successful_exploits(self) -> List[ExploitResult]:
        return [r for r in self.exploit_results if r.got_root]

    def to_dict(self) -> Dict[str, Any]:
        return {
            'scan_time': self.scan_time.isoformat(),
            'user': self.user,
            'uid': self.uid,
            'all_groups': self.all_groups,
            'summary': {
                'total_groups': len(self.all_groups),
                'dangerous_groups': len(self.findings),
                'critical': len(self.critical_findings),
                'high': len(self.high_findings)
            },
            'findings': [f.to_dict() for f in self.findings],
            'exploit_results': [r.to_dict() for r in self.exploit_results]
        }

    def print_summary(self) -> None:
        """Print scan summary"""
        print(f"\n{'=' * 60}")
        print(f"GROUP SCAN SUMMARY")
        print(f"{'=' * 60}")
        print(f"User: {self.user} (UID: {self.uid})")
        print(f"Total groups: {len(self.all_groups)}")
        print(f"Dangerous groups: {len(self.findings)}")

        if self.critical_findings:
            print(f"  CRITICAL: {len(self.critical_findings)}")

        if self.high_findings:
            print(f"  HIGH: {len(self.high_findings)}")