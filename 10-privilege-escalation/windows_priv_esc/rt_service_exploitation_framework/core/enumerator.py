import subprocess
from typing import Dict, List, Optional
from pathlib import Path
from datetime import datetime


class ServiceEnumerator:
    """Enumerate Windows services and their configurations."""

    def __init__(self, output_dir: str = "service_exploits"):
        """
        Initialize the service enumerator.

        Args:
            output_dir: Directory for storing enumeration results
        """
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(exist_ok=True)
        self.services_cache: List[Dict] = []

    def get_all_services(self, refresh: bool = False) -> List[Dict]:
        """
        Get all Windows services.

        Args:
            refresh: Force refresh of cached services

        Returns:
            List of service dictionaries with name and display name
        """
        if self.services_cache and not refresh:
            return self.services_cache

        print("[*] Enumerating all Windows services...")

        cmd = 'sc query type= service state= all'
        result = subprocess.run(cmd, shell=True, capture_output=True, text=True)

        services = []
        current_service = {}

        for line in result.stdout.split('\n'):
            line = line.strip()

            if 'SERVICE_NAME:' in line:
                if current_service:
                    services.append(current_service)
                current_service = {
                    'name': line.split('SERVICE_NAME:')[1].strip()
                }
            elif 'DISPLAY_NAME:' in line:
                current_service['display'] = line.split('DISPLAY_NAME:')[1].strip()
            elif 'STATE' in line:
                # Extract state (e.g., "4  RUNNING" -> "RUNNING")
                parts = line.split()
                if len(parts) >= 3:
                    current_service['state'] = parts[3] if len(parts) > 3 else parts[-1]

        if current_service:
            services.append(current_service)

        self.services_cache = services
        print(f"[+] Found {len(services)} services")

        return services

    @staticmethod
    def get_service_config(service_name: str) -> Dict:
        """
        Get detailed configuration for a specific service.

        Args:
            service_name: Name of the service

        Returns:
            Dictionary with service configuration details
        """
        config = {
            'name': service_name,
            'binary_path': None,
            'start_type': None,
            'account': None,
            'dependencies': []
        }

        result = subprocess.run(
            f'sc qc "{service_name}"',
            shell=True,
            capture_output=True,
            text=True
        )

        for line in result.stdout.split('\n'):
            line = line.strip()

            if 'BINARY_PATH_NAME' in line:
                config['binary_path'] = line.split(':', 1)[-1].strip()
            elif 'START_TYPE' in line:
                config['start_type'] = line.split(':', 1)[-1].strip()
            elif 'SERVICE_START_NAME' in line:
                config['account'] = line.split(':', 1)[-1].strip()
            elif 'DEPENDENCIES' in line:
                deps = line.split(':', 1)[-1].strip()
                if deps:
                    config['dependencies'] = [d.strip() for d in deps.split(',')]

        return config

    @staticmethod
    def get_service_permissions(service_name: str) -> Dict:
        """
        Get security permissions for a service.

        Args:
            service_name: Name of the service

        Returns:
            Dictionary with permission information
        """
        permissions = {
            'service_name': service_name,
            'can_modify': False,
            'can_start': False,
            'can_stop': False,
            'full_control': False,
            'raw_permissions': []
        }

        result = subprocess.run(
            f'sc sdshow "{service_name}"',
            shell=True,
            capture_output=True,
            text=True
        )

        sddl = result.stdout.strip()
        permissions['sddl'] = sddl

        # Parse SDDL for common permission patterns
        # D:(A;;CCLCSWRPWPDTLOCRRC;;;SY) - typical admin permissions
        # Look for permissions granted to Users, Everyone, or Authenticated Users

        vulnerable_sids = ['WD', 'BU', 'AU']  # Everyone, BUILTIN\Users, Authenticated Users

        for sid in vulnerable_sids:
            if sid in sddl:
                # Check what permissions are granted
                # RPWP = Start/Stop, DC = Change Config, WD = Write DAC
                if 'DC' in sddl or 'WD' in sddl:
                    permissions['can_modify'] = True
                if 'RP' in sddl:
                    permissions['can_start'] = True
                if 'WP' in sddl:
                    permissions['can_stop'] = True
                if 'GA' in sddl:  # Generic All
                    permissions['full_control'] = True

        return permissions

    def export_enumeration(self, filename: str = None) -> str:
        """
        Export service enumeration results to a file.

        Args:
            filename: Optional filename (auto-generated if not provided)

        Returns:
            Path to the exported file
        """
        if not filename:
            timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
            filename = f"service_enum_{timestamp}.txt"

        filepath = self.output_dir / filename

        services = self.get_all_services()

        with open(filepath, 'w') as f:
            f.write("=" * 60 + "\n")
            f.write("Windows Service Enumeration Report\n")
            f.write(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write("=" * 60 + "\n\n")

            for service in services:
                config = self.get_service_config(service['name'])

                f.write(f"Service: {service['name']}\n")
                f.write(f"  Display: {service.get('display', 'N/A')}\n")
                f.write(f"  State: {service.get('state', 'N/A')}\n")
                f.write(f"  Binary: {config.get('binary_path', 'N/A')}\n")
                f.write(f"  Start Type: {config.get('start_type', 'N/A')}\n")
                f.write(f"  Account: {config.get('account', 'N/A')}\n")
                f.write("-" * 40 + "\n")

        print(f"[+] Enumeration exported to: {filepath}")
        return str(filepath)


if __name__ == "__main__":
    # Standalone usage
    enumerator = ServiceEnumerator()
    services = enumerator.get_all_services()

    print(f"\n[*] First 10 services:")
    for svc in services[:10]:
        print(f"    - {svc['name']}: {svc.get('display', 'N/A')}")